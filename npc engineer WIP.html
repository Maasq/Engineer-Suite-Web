<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="author" content="Maasq" />
		<meta name="description" content="A tool for creating and managing NPCs." />
		<meta name="version" content="0.02.11" />
		<meta name="date" content="2025-10-08" />
		
		<title>NPC Engineer</title>
		
		<!-- Tailwind CSS for styling -->
		<script src="https://cdn.tailwindcss.com"></script>
		<!-- Dexie.js for IndexedDB -->
		<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
		
		<!-- Trix Editor for WYSIWYG -->
		<link rel="stylesheet" type="text/css" href="https://unpkg.com/trix@2.0.0/dist/trix.css">
		<script type="text/javascript" src="https://unpkg.com/trix@2.0.0/dist/trix.umd.min.js"></script>
		
		<!-- Google Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700&display=swap" rel="stylesheet" />
		<link href="https://fonts.googleapis.com/css2?family=Cormorant+SC:wght@400;500;700&display=swap" rel="stylesheet" />
		<link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet" />
		<link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet" />
		
		<style>
			body { /* A simple style for our application font */
				font-family: "Lexend", sans-serif;
			}
			.card-body { /* Custom styles for the card collapse/expand transition */
				max-height: 0;
				overflow: hidden;
				transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
				padding-top: 0;
				padding-bottom: 0;
			}
			.card-body.open { /* A large max-height to allow content to expand fully */
				max-height: 40rem; /* Corresponds to 640px */
			}
			.card-font-style { /* Sets font size for card content */
				font-size: 11pt;
			}
			.custom-shadow { /* Custom shadow style */
				box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.4);
			}
			.input-field {
				@apply w-full bg-gray-100 border border-gray-300 rounded-md px-3 py-1 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500;
			}
			.label-text {
				@apply block text-sm font-medium text-gray-700;
			}
			.bordered-container { /* A reusable class for black borders */
				border: 1px solid black;
			}
			.info-input, .info-select { /* Custom style for specific input boxes and dropdowns */
				background-color: #F8FAFC; /* Lighter input background */
				border: 1px solid #CBD5E1; /* Adjusted darker shade for the border */
				border-radius: 2px;
				padding-left: 0.5rem;
				padding-right: 0.5rem;
				font-size: 10pt; /* Set font size for input fields */
			}

			/* --- Trix Editor Styles --- */
			trix-toolbar .trix-button-group button {
				tabindex: -1; /* Remove Trix toolbar buttons from tab order */
			}
			.trix-content {
				min-height: 250px;
				background-color: #F8FAFC;
				border: 1px solid #CBD5E1;
				border-top: none; /* The toolbar has a bottom border already */
				border-radius: 0 0 2px 2px;
				padding: 0.5rem;
			}
			trix-toolbar {
				background-color: #F8FAFC;
			}

			/* --- Viewport Styles --- */
			div.container {
				margin: auto;
				width: 10.3cm;
				box-shadow: 8px 8px 20px #472737;
				background-image: url("graphics/statblock texture.jpg");
				background-color: #FDF1E6; /* Pale yellow fallback */
			}
			div.cap {
				margin: auto;
				height: 0.1cm;
				width: 10.3cm;
				background: #87CC24; /* App title green color */
				border-style: solid;
				border-right-width: 1px;
				border-left-width: 1px;
				border-top-width: 1px;
				border-bottom-width: 1px;
				border-right-color: #000000;
				border-left-color: #000000;
				border-top-color: #000000;
				border-bottom-color: #000000;
				background-image: url("graphics/statblock cap.jpg");
			}
			div.npcname {
				margin: auto;
				width: 10.3cm;
				background: rgba(0, 0, 0, 0.0);
				color: #7A200D;
				font-family: "Cormorant SC", serif;
				font-size: 21pt;
				border-left-style: solid;
				border-right-style: solid;
				border-top-style: none;
				border-bottom-style: none;
				border-right-width: 1px;
				border-left-width: 1px;
				border-right-color: #BA4E3B;
				border-left-color: #BA4E3B;
				padding: 0cm 0.15cm 0cm 0.15cm;
			}
			div.npctype {
				margin: auto;
				width: 10.3cm;
				background: rgba(0, 0, 0, 0.0);
				color: #000000;
				font-family: "Questrial", sans-serif;
				font-size: 9pt;
				border-left-style: solid;
				border-right-style: solid;
				border-top-style: none;
				border-bottom-style: none;
				border-right-width: 1px;
				border-left-width: 1px;
				border-right-color: #BA4E3B;
				border-left-color: #BA4E3B;
				padding: 0cm 0.15cm 0cm 0.15cm;
			}
			div.npctop {
				margin: auto;
				width: 10.3cm;
				background: rgba(0, 0, 0, 0.0);
				color: #7A200D;
				font-family: "Questrial", sans-serif;
				font-size: 10.5pt;
				border-left-style: solid;
				border-right-style: solid;
				border-top-style: none;
				border-bottom-style: none;
				border-right-width: 1px;
				border-left-width: 1px;
				border-right-color: #BA4E3B;
				border-left-color: #BA4E3B;
				padding: 0cm 0.15cm 0cm 0.15cm;
			}
			div.npcbottom {
				margin: auto;
				width: 10.3cm;
				background: rgba(0, 0, 0, 0.0);
				color: #000000;
				font-family: "Questrial", sans-serif;
				font-size: 10pt;
				border-left-style: solid;
				border-right-style: solid;
				border-top-style: none;
				border-bottom-style: none;
				border-right-width: 1px;
				border-left-width: 1px;
				border-right-color: #BA4E3B;
				border-left-color: #BA4E3B;
				padding: 0cm 0.15cm 0cm 0.15cm;
			}
			div.npcdescrip {
				margin: auto;
				background: rgba(255, 255, 255, 0.0);
				color: #000000;
				font-family: "Questrial", sans-serif;
				font-size: 10pt;
				padding: 0cm 0.15cm 0cm 0.15cm;
			}
			div.npcdescrip .trix-content { /* Override Trix's default padding for the viewport */
				padding: 0;
			}
			.heading {
				background: rgba(0, 0, 0, 0.0);
				color: #7A200D;
				font-size: 16pt;
				font-weight: bold;
			}
			.post-container {
				margin: 20px 20px 0 0;
				overflow: auto;
				padding: 0cm 0.15cm 0cm 0cm;
			}
			.post-thumb {
				float: left;
			}
			.post-thumb img {
				display: block;
			}
			.post-content {
				background: #FDF1E6;
				color: #000000;
				font-family: "Questrial", sans-serif;
				font-size: 10pt;
				border: 1px solid #7A200D;
				margin-left: 1cm;
				padding: 0.15cm 0.15cm 0cm 0.15cm;
				box-shadow: 4px 4px 8px #472737;
			}
			div.npcdiv {
				margin: auto;
				width: 10.3cm;
				background: rgba(0, 0, 0, 0.0);
				border-left-style: solid;
				border-right-style: solid;
				border-top-style: none;
				border-bottom-style: none;
				border-right-width: 1px;
				border-left-width: 1px;
				border-right-color: #BA4E3B;
				border-left-color: #BA4E3B;
				padding: 0cm 0.15cm 0cm 0.15cm;
			}
			.whoosh { /* This class is now used on an SVG polyline, styled via attributes */ }
			table.attr {
				background: rgba(0, 0, 0, 0.0);
				color: #7A200D;
				font-family: "Lato", sans-serif;
				font-size: 11pt;
				border-style: none;
				border-collapse: collapse;
				text-align: center;
				padding: 0cm 0cm 0cm 0cm;
			}
			div.npcdiv2 {
				margin: auto;
				width: 10.3cm;
				background: rgba(0, 0, 0, 0.0);
				border-left-style: solid;
				border-right-style: solid;
				border-top-style: none;
				border-bottom-style: none;
				border-right-width: 1px;
				border-left-width: 1px;
				border-right-color: #BA4E3B;
				border-left-color: #BA4E3B;
				padding: 0cm 0.15cm 0.2cm 0.15cm;
			}
			table.spell {
				background: #FDF1E6;
				color: #000000;
				font-family: "Lato", sans-serif;
				font-size: 11pt;
				border: 1px solid #7A200D;
				border-collapse: collapse;
				text-align: left;
				padding: 0.2cm 0.2cm 0.2cm 0.2cm;
				box-shadow: 3px 3px #DDDDDD;
			}
			table.spell th {
				background-color: #7A200D;
				color: #FFFFFF;
				padding: 0.1cm;
				border: 1px solid #7A200D;
				border-collapse: collapse;
			}
			table.spell td {
				padding: 0.1cm;
				border: 1px solid #7A200D;
				border-collapse: collapse;
			}

			/* --- Drag & Drop highlight --- */
			.drag-over {
				border: 2px dashed #87CC24 !important;
				background-color: #f0fff4 !important;
			}
			#npc-token, #npc-image {
				padding: 0;
			}
			.menu-item.disabled {
				opacity: 0.5;
				cursor: not-allowed;
			}
			.menu-item.disabled:hover {
				background-color: transparent;
			}
		</style>
	</head>
	<body class="bg-[#E2E8F0]">
		<!-- Centering Container with a max-width. -->
		<div class="max-w-screen-2xl mx-auto px-6 pb-6">

			<!-- Sticky Header Area -->
			<header class="sticky top-0 z-50 bg-[#E2E8F0] pt-1 pb-12">
				<div class="relative h-24">
					
					<!-- Hamburger Menu -->
					<div class="absolute top-2 left-2 z-40">
						<button id="hamburger-btn" class="w-10 h-10 flex items-center justify-center rounded-full bg-transparent hover:bg-violet-200 transition-colors">
							<svg class="h-6 w-6 text-black" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
							</svg>
						</button>
						<div id="main-menu" class="absolute left-0 mt-2 w-56 bg-white rounded-md shadow-lg z-50 hidden">
							<!-- Projects Sub-Menu -->
							<div class="relative group/projects">
								<div class="flex justify-between items-center w-full px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 cursor-default">
									<span>Projects</span>
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
								</div>
								<div class="absolute left-full top-0 w-56 bg-white rounded-md shadow-lg z-50 hidden group-hover/projects:block">
									<a href="#" id="menu-new-project" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">New Project</a>
									<a href="#" id="menu-load-project" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">Select Project</a>
									<a href="#" id="menu-import-project" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">Import Project</a>
									<a href="#" id="menu-export-project" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">Export Project</a>
								</div>
							</div>
							<hr class="my-1"/>
							<!-- NPCs Sub-Menu -->
							<div class="relative group/npcs">
								<div class="flex justify-between items-center w-full px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 cursor-default">
									<span>NPCs</span>
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
								</div>
								<div class="absolute left-full top-0 w-56 bg-white rounded-md shadow-lg z-50 hidden group-hover/npcs:block">
									<a href="#" id="menu-new-npc" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">New NPC</a>
									<a href="#" id="menu-import-npc" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">Import NPC</a>
									<a href="#" id="menu-export-npc" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">Export NPC</a>
									<a href="#" id="menu-delete-npc" class="menu-item block px-4 py-1 text-sm text-red-600 hover:bg-red-50">Delete NPC</a>
								</div>
							</div>
							<hr class="my-1"/>
							<a href="#" id="menu-settings" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
						</div>
					</div>

					<!-- Background circle for the graphic -->
					<div class="absolute w-32 h-32 bg-black rounded-full custom-shadow z-10" style="top: 16px; left: 28px"></div>
					<!-- Graphic Image -->
					<img src="graphics/npc engineer.webp" alt="NPC Engineer Logo" class="absolute w-32 h-32 rounded-full z-30" style="top: 16px; left: 28px" />
					
					
					<!-- Project Management Buttons -->
					<div id="project-buttons" class="absolute right-3 top-[15px] z-30 flex items-center space-x-4">
						<span id="project-status" class="text-sm font-medium text-gray-600 mr-2">No Project Loaded</span>
						<!-- New Project Button -->
						<button id="newProjectBtn" title="Create a new Project" class="transition duration-150 p-1.5 text-black rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-black">
							<svg class="h-6 w-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
								<path d="M11 19.913c-4.966-.084-8-1.388-8-2.334v-6.248C4.643 12.429 8.082 13 11.5 13s6.857-.57 8.5-1.67V14h1V5c0-1.97-4.78-3-9.5-3S2 3.03 2 5v12.58c0 2.116 4.448 3.255 9 3.333zM11.5 3C17 3 20 4.321 20 5s-3 2-8.5 2S3 5.679 3 5s3-2 8.5-2zM3 6.411C4.643 7.457 8.082 8 11.5 8s6.857-.543 8.5-1.589v3.437C20 10.726 16.689 12 11.5 12S3 10.726 3 9.848zM18 15l-1-1h-3l-1 1h-1v8h11v-8zm4 7h-9v-4h9zm-9-5v-1h.414l1-1h2.172l1 1H22v1z"/>
								<path fill="none" d="M0 0h24v24H0z"/>
							</svg>
						</button>
						<!-- Load Project Button -->
						<button id="loadProjectBtn" title="Select one of your Projects to edit" class="transition duration-150 p-1.5 text-black rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-black">
							<svg class="h-6 w-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
								<path d="M4 4H3v1h2V2h1v20H5v-1H4v2h18V1H4zm3-2h14v20H7zM5 20H3v-1h1v-1h1zm0-6H3v-1h1v-1h1zm0-6H3V7h1V6h1zm0 3H3v-1h1V9h1zm0 6H3v-1h1v-1h1zm10.5-5h-3A3.504 3.504 0 0 0 9 15.5V18h10v-2.5a3.504 3.504 0 0 0-3.5-3.5zm2.5 5h-8v-1.5a2.503 2.503 0 0 1 2.5-2.5h3a2.503 2.503 0 0 1 2.5 2.5zm-4-6a3 3 0 1 0-3-3 3.003 3.003 0 0 0 3 3zm0-5a2 2 0 1 1-2 2 2.002 2.002 0 0 1 2-2z"/>
								<path fill="none" d="M0 0h24v24H0z"/>
							</svg>
						</button>
						<!-- Import Project Button -->
						<button id="importProjectBtn" title="Import Project (JSON) from Disk" class="transition duration-150 p-1.5 text-black rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-black">
							<svg class="h-6 w-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
								<path d="M24 12a5 5 0 0 1-5 5h-2v-1h2a3.99 3.99 0 0 0 .623-7.934l-.79-.124-.052-.798a5.293 5.293 0 0 0-10.214-1.57L8.17 6.59l-.977-.483A2.277 2.277 0 0 0 6.19 5.87a2.18 2.18 0 0 0-1.167.339 2.205 2.205 0 0 0-.98 1.395l-.113.505-.476.2A4 4 0 0 0 5 16h3v1H5a5 5 0 0 1-1.934-9.611 3.21 3.21 0 0 1 1.422-2.025 3.17 3.17 0 0 1 1.702-.493 3.268 3.268 0 0 1 1.446.34 6.293 6.293 0 0 1 12.143 1.867A4.988 4.988 0 0 1 24 12zm-11-.293l2.646 2.646.707-.707L12.5 9.793l-3.854 3.853.707.707L12 11.707V22h1z"/>
								<path fill="none" d="M0 0h24v24H0z"/>
							</svg>
						</button>
						<!-- Export Project Button -->
						<button id="exportProjectBtn" title="Export Project (JSON) to Disk" class="transition duration-150 p-1.5 text-black rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-black">
							<svg class="h-6 w-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
								<path d="M24 12a5 5 0 0 1-5 5h-2v-1h2a3.99 3.99 0 0 0 .623-7.934l-.79-.124-.052-.798a5.293 5.293 0 0 0-10.214-1.57L8.17 6.59l-.977-.483A2.277 2.277 0 0 0 6.19 5.87a2.18 2.18 0 0 0-1.167.339 2.206 2.206 0 0 0-.98 1.395l-.113.505-.476.2A4 4 0 0 0 5 16h3v1H5a5 5 0 0 1-1.934-9.611 3.21 3.21 0 0 1 1.422-2.025 3.17 3.17 0 0 1 1.702-.493 3.268 3.268 0 0 1 1.446.34 6.293 6.293 0 0 1 12.143 1.867A4.988 4.988 0 0 1 24 12zm-11-1h-1v10.292l-2.646-2.646-.707.707 3.854 3.854 3.853-3.852-.707-.707L13 21.294z"/>
								<path fill="none" d="M0 0h24v24H0z"/>
							</svg>
						</button>
					</div>
					
					<!-- Persistent Header Bar -->
					<div class="absolute bottom-0 left-0 right-0 h-[50px] bg-gradient-to-b from-black via-gray-500 to-black border border-black rounded-xl custom-shadow z-20 flex items-center justify-between px-4">
						<h1 class="text-3xl font-bold text-[#87CC24] ml-48">NPC Engineer</h1>
						<div id="npc-buttons" class="flex items-center space-x-4">
							<button id="newNpcBtn" title="New NPC" class="transition duration-150 p-1.5 text-white rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
								<svg fill="currentColor" stroke="currentColor" stroke-width="0.5" class="h-5 w-5" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 502 502" xml:space="preserve"><g><g><path d="M405.889,348.576V105.273c0-2.652-1.054-5.196-2.929-7.071L307.688,2.929C305.812,1.054,303.269,0,300.617,0H70.783 c-5.523,0-10,4.477-10,10v445.916c0,5.523,4.477,10,10,10h216.442C303.083,488.611,328.615,502,356.57,502 c46.674,0,84.646-37.972,84.646-84.646C441.217,389.827,428.102,364.485,405.889,348.576z M80.783,20h215.691l76.158,76.158 h-51.151c-5.522,0-10,4.477-10,10s4.478,10,10,10h64.408v221.789c-9.334-3.451-19.247-5.241-29.319-5.241 c-46.675,0-84.647,37.973-84.647,84.647c0,9.793,1.692,19.45,4.955,28.562H80.783V20z M356.57,482 c-22.766,0-43.43-11.629-55.277-31.107c-6.13-10.077-9.37-21.675-9.37-33.539c0-35.646,29.001-64.647,64.647-64.647 c11.785,0,23.28,3.21,33.334,9.278c0.474,0.355,0.979,0.67,1.513,0.938c18.668,11.975,29.799,32.278,29.799,54.431 C421.217,453,392.217,482,356.57,482z"/><path d="M394.345,407.354h-27.776v-27.776c0-5.523-4.478-10-10-10s-10,4.477-10,10v27.776h-27.776c-5.522,0-10,4.477-10,10 s4.478,10,10,10h27.776v27.776c0,5.523,4.478,10,10,10s10-4.477,10-10v-27.776h27.776c5.522,0,10-4.477,10-10 S399.868,407.354,394.345,407.354z"/><path d="M292.56,106.158c0-5.523-4.478-10-10-10h-11.447c-5.522,0-10,4.477-10,10s4.478,10,10,10h11.447 C288.083,116.158,292.56,111.681,292.56,106.158z"/></g></g></svg>
							</button>
							<button id="importNpcBtn" title="Import NPC" class="transition duration-150 p-1.5 text-white rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white disabled:opacity-25 disabled:cursor-not-allowed">
								<svg class="h-5 w-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="currentColor" stroke-width="1"><path d="M21 5h-8.8L11 3H4L2.8 5H1v16h20l2.902-12H21zM2 6h1.366l1.2-2h5.868l1.2 2H20v3h-5.6l-2 2H4.35L2 18.015zm20.632 4l-2.42 10H2.39l2.68-8h7.744l2-2z"/></svg>
							</button>
							<button id="exportNpcBtn" title="Export NPC" class="transition duration-150 p-1.5 text-white rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white disabled:opacity-25 disabled:cursor-not-allowed">
								<svg class="h-5 w-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="currentColor" stroke-width="1"><path d="M16.765 2c1.187 0 1.363.06 1.51.168L21.662 4.7a.845.845 0 0 1 .339.677v15.78a.844.844 0 0 1-.844.844H2.844A.844.844 0 0 1 2 21.156V2.844A.844.844 0 0 1 2.844 2zM17 21v-7H7v7zM14 3v3h1V3zM7 3v6h10V3h-1v4h-3V3zM3 21h3v-8h12v8h3V5.452l-3-2.278v6.17a.769.769 0 0 1-.844.656H6.844A.769.769 0 0 1 6 9.344V3H3z"/></svg>
							</button>
						</div>
					</div>
					<!-- NPC Selector -->
					<div id="npc-selector-container" class="absolute left-0 right-0 pr-6" style="top: 100px; display: flex; justify-content: flex-end; align-items: center;">
						<select id="npc-selector" class="info-select hidden" style="width: 450px; font-size: 11pt;" title="Select an NPC to edit"></select>
						<button id="deleteNpcBtn" title="Delete Current NPC" class="ml-2 p-1.5 text-red-600 rounded-lg hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 hidden">
							<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>
							</svg>
						</button>
					</div>
				</div>
			</header>

			<!-- Main Content Area: flex-wrap will stack columns on smaller screens -->
			<main class="flex flex-wrap justify-center gap-6 pt-6">

				<!-- Left Column -->
				<div id="main-content-column" class="w-[900px] flex-shrink-0 space-y-6">

					<!-- Card: NPC Information -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-white px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">NPC Information</h2>
						</div>
						<div class="card-body">
							<div class="px-4 pt-2 pb-2">
								<div class="flex space-x-4">
									<!-- Main Info Column -->
									<div class="flex-shrink-0">
										<div class="space-y-1">
											<!-- Name -->
											<div class="flex items-center mb-2">
												<label for="npc-name" class="label-text w-28 text-right pr-2">Name</label>
												<input type="text" id="npc-name" class="info-input" style="width: 250px; height: 23px; background-color: #fef2f2; border-color: #b91c1c;" tabindex="1" title="Enter the NPC's name." />
											</div>
											<!-- Size and Gender -->
											<div class="flex items-center">
												<label for="npc-size" class="label-text w-28 text-right pr-2">Size</label>
												<div class="relative" style="width: 200px; height: 23px;">
													<select id="npc-size" class="info-select absolute top-0 left-0 w-full h-full" tabindex="2" title="Select from the standard size categories or enter your own by clicking the checkbox.">
														<option value="" disabled selected hidden></option>
														<option>Tiny</option>
														<option>Small</option>
														<option>Medium</option>
														<option>Large</option>
														<option>Huge</option>
														<option>Gargantuan</option>
													</select>
													<input type="text" id="npc-size-custom" class="info-input absolute top-0 left-0 w-full h-full hidden" tabindex="2" title="Select from the standard size categories or enter your own by clicking the checkbox." />
												</div>
												<input type="checkbox" id="toggle-custom-size" title="enter a custom size" class="ml-2 mr-4 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" tabindex="-1">
												<label for="npc-gender" class="label-text w-28 text-right pr-2">Gender</label>
												<select id="npc-gender" class="info-select" style="width: 130px; height: 23px;" tabindex="8" title="Select the NPC's gender.
This will insert gender-specific pronouns in the descriptive text.">
													<option value="neutral">neutral</option>
													<option value="male">male</option>
													<option value="female">female</option>
												</select>
											</div>
											<!-- Type and Unique -->
											<div class="flex items-center">
												<label for="npc-type" class="label-text w-28 text-right pr-2">Type</label>
												<div class="relative" style="width: 200px; height: 23px;">
													<select id="npc-type" class="info-select absolute top-0 left-0 w-full h-full" tabindex="3" title="Select from the standard creature types or enter your own by clicking the checkbox.">
														<option value="" disabled selected hidden></option>
														<option>aberration</option>
														<option>beast</option>
														<option>celestial</option>
														<option>construct</option>
														<option>dragon</option>
														<option>elemental</option>
														<option>fey</option>
														<option>fiend</option>
														<option>giant</option>
														<option>humanoid</option>
														<option>monstrosity</option>
														<option>ooze</option>
														<option>plant</option>
														<option>undead</option>
														<option disabled>──────────</option>
														<option>swarm of tiny aberrations</option>
														<option>swarm of tiny beasts</option>
														<option>swarm of tiny constructs</option>
														<option>swarm of tiny elementals</option>
														<option>swarm of tiny monstrosities</option>
														<option>swarm of tiny oozes</option>
														<option>swarm of tiny plants</option>
														<option disabled>──────────</option>
														<option>trap</option>
													</select>
													<input type="text" id="npc-type-custom" class="info-input absolute top-0 left-0 w-full h-full hidden" tabindex="3" title="Select from the standard creature types or enter your own by clicking the checkbox." />
												</div>
												<input type="checkbox" id="toggle-custom-type" title="enter a custom type" class="ml-2 mr-4 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" tabindex="-1">
												<label for="npc-unique" class="label-text w-28 text-right pr-2">Unique</label>
												<div class="w-[130px] flex items-center">
													<input type="checkbox" id="npc-unique" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" tabindex="9" title="Check if the NPC is unique for any reason.
This will capitalise its name in the descriptive text.">
												</div>
											</div>
											<!-- Species and Proper Name -->
											<div class="flex items-center">
												<label for="npc-species" class="label-text w-28 text-right pr-2">Species</label>
												<div class="relative" style="width: 200px; height: 23px;">
													<select id="npc-species" class="info-select absolute top-0 left-0 w-full h-full" tabindex="4" title="Select a specific species or enter your own by clicking the checkbox.
Example: a species of humanoid may be half-elf.
You can leave this box blank if desired.">
														<option value="" disabled selected hidden></option>
														<option>aarakocra</option>
														<option>any species</option>
														<option>bullywug</option>
														<option>demon</option>
														<option>derro</option>
														<option>devil</option>
														<option>dragonborn</option>
														<option>dwarf</option>
														<option>elf</option>
														<option>firenewt</option>
														<option>genasi</option>
														<option>gith</option>
														<option>gnoll</option>
														<option>gnome</option>
														<option>goblinoid</option>
														<option>grimlock</option>
														<option>grung</option>
														<option>half-elf</option>
														<option>half-orc</option>
														<option>halfling</option>
														<option>human</option>
														<option>kenku</option>
														<option>kobold</option>
														<option>kuo-toa</option>
														<option>lizardfolk</option>
														<option>merfolk</option>
														<option>orc</option>
														<option>quaggoth</option>
														<option>ratfolk</option>
														<option>sahuagin</option>
														<option>shapechanger</option>
														<option>thri-kreen</option>
														<option>tiefling</option>
														<option>titan</option>
														<option>troglodyte</option>
														<option>xvart</option>
														<option>yuan-ti</option>
														<option>yugoloth</option>
													</select>
													<input type="text" id="npc-species-custom" class="info-input absolute top-0 left-0 w-full h-full hidden" tabindex="4" title="Select a specific species or enter your own by clicking the checkbox.
Example: a species of humanoid may be half-elf.
You can leave this box blank if desired.">
												</div>
												<input type="checkbox" id="toggle-custom-species" title="enter a custom species" class="ml-2 mr-4 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" tabindex="-1">
												<label for="npc-proper" class="label-text w-28 text-right pr-2">Proper Name</label>
												<div class="w-[130px] flex items-center">
													<input type="checkbox" id="npc-proper" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" tabindex="10" title="Check if the name entered is a proper name.
This will use just the first word of the name in the descriptive text.
('Maasq Hammerheart' will be referred to as 'Maasq' throughout; 'Ironbane, Destroyer of Worlds' as 'Ironbane') ">
												</div>
											</div>
											<!-- Flex container for the Alignment/AC/HP column and Token column -->
											<div class="flex items-start">
												<!-- Left Column: Alignment, AC, HP -->
												<div class="space-y-1">
													<!-- Alignment -->
													<div class="flex items-center">
														<label for="npc-alignment" class="label-text w-28 text-right pr-2">Alignment</label>
														<div class="relative" style="width: 200px; height: 23px;">
															<select id="npc-alignment" class="info-select absolute top-0 left-0 w-full h-full" tabindex="5" title="Select from the standard alignments or enter your own by clicking the checkbox.">
																<option value="" disabled selected hidden></option>
																<option>unaligned</option>
																<option disabled>──────────</option>
																<option>lawful good</option>
																<option>lawful neutral</option>
																<option>lawful evil</option>
																<option disabled>──────────</option>
																<option>neutral good</option>
																<option>true neutral</option>
																<option>neutral evil</option>
																<option disabled>──────────</option>
																<option>chaotic good</option>
																<option>chaotic neutral</option>
																<option>chaotic evil</option>
															</select>
															<input type="text" id="npc-alignment-custom" class="info-input absolute top-0 left-0 w-full h-full hidden" tabindex="5" title="Select from the standard alignments or enter your own by clicking the checkbox.">
														</div>
														<input type="checkbox" id="toggle-custom-alignment" title="enter a custom alignment" class="ml-2 mr-4 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" tabindex="-1">
													</div>
													<!-- Armor Class -->
													<div class="flex items-center">
														<label for="npc-ac" class="label-text w-28 text-right pr-2">Armor Class</label>
														<input type="text" id="npc-ac" class="info-input" style="width: 200px; height: 23px;" tabindex="6" title="Enter the NPC's armor class. You can also enter the type of armor in brackets.
Example: 12 (leather armor)">
													</div>
													<!-- Hit Points -->
													<div class="flex items-center">
														<label for="npc-hp" class="label-text w-28 text-right pr-2">Hit Points</label>
														<input type="text" id="npc-hp" class="info-input" style="width: 200px; height: 23px;" tabindex="7" title="Enter the NPC's hit points, followed by its hit dice in brackets.
Example: 16 (3d6 + 6)
Double-click to open a window that will help build a correct expression.">
													</div>
													<!-- Challenge -->
													<div class="flex items-center" style="padding-top: 3px;">
														<label for="npc-challenge" class="label-text w-28 text-right pr-2">Challenge</label>
														<select id="npc-challenge" class="info-select" style="width: 70px; height: 23px;" tabindex="8"></select>
													</div>
													<!-- XP and Proficiency Bonus -->
													<div class="flex items-center" style="margin-top: -1px;">
														<label class="label-text w-28 text-right pr-2">XP</label>
														<span id="npc-experience-display" class="font-medium text-gray-800" style="width: 80px;"></span>
														<label class="label-text pr-2 ml-2">Proficiency Bonus</label>
														<span id="npc-proficiency-bonus-display" class="font-medium text-gray-800"></span>
													</div>
												</div>

												<!-- Right Column: Token -->
												<div class="flex">
													<label class="label-text w-28 text-right pr-2">Token</label>
													<div class="w-[130px]">
														<div id="npc-token" class="w-[130px] h-[130px] info-input cursor-pointer flex items-center justify-center text-gray-400 text-xs text-center overflow-hidden">
															<span>Click or Drag a Token Image Here</span>
														</div>
														<input type="file" id="token-upload" class="hidden" accept="image/png, image/webp">
													</div>
												</div>
											</div>
										</div>
									</div>

									<!-- Image Column -->
									<div class="flex-grow">
										<div id="npc-image" class="w-[256px] h-[242px] info-input cursor-pointer flex items-center justify-center text-gray-400 text-xs text-center overflow-hidden">
											<span>Click or Drag an NPC Image Here</span>
										</div>
										<input type="file" id="image-upload" class="hidden" accept="image/png, image/webp, image/jpeg">
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Card: Statistics -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-white px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">Statistics</h2>
						</div>
						<div class="card-body">
							<div class="p-4">
								<div class="flex space-x-8">
									<!-- Ability, Score, Bonus Columns -->
									<div class="flex space-x-4">
										<!-- Ability Column -->
										<div class="flex flex-col items-end space-y-1">
											<label class="label-text font-semibold h-6 mb-1">Ability</label>
											<label for="npc-strength" class="label-text h-6 flex items-center">Strength</label>
											<label for="npc-dexterity" class="label-text h-6 flex items-center">Dexterity</label>
											<label for="npc-constitution" class="label-text h-6 flex items-center">Constitution</label>
											<label for="npc-intelligence" class="label-text h-6 flex items-center">Intelligence</label>
											<label for="npc-wisdom" class="label-text h-6 flex items-center">Wisdom</label>
											<label for="npc-charisma" class="label-text h-6 flex items-center">Charisma</label>
										</div>
										<!-- Score Column -->
										<div class="flex flex-col items-center space-y-1">
											<label class="label-text font-semibold h-6 mb-1">Score</label>
											<input type="number" id="npc-strength" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="1" max="30">
											<input type="number" id="npc-dexterity" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="1" max="30">
											<input type="number" id="npc-constitution" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="1" max="30">
											<input type="number" id="npc-intelligence" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="1" max="30">
											<input type="number" id="npc-wisdom" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="1" max="30">
											<input type="number" id="npc-charisma" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="1" max="30">
										</div>
										<!-- Bonus Column -->
										<div class="flex flex-col items-center space-y-1">
											<label class="label-text font-semibold h-6 mb-1">Bonus</label>
											<span id="npc-strength-bonus" class="font-medium text-gray-800 h-6 flex items-center"></span>
											<span id="npc-dexterity-bonus" class="font-medium text-gray-800 h-6 flex items-center"></span>
											<span id="npc-constitution-bonus" class="font-medium text-gray-800 h-6 flex items-center"></span>
											<span id="npc-intelligence-bonus" class="font-medium text-gray-800 h-6 flex items-center"></span>
											<span id="npc-wisdom-bonus" class="font-medium text-gray-800 h-6 flex items-center"></span>
											<span id="npc-charisma-bonus" class="font-medium text-gray-800 h-6 flex items-center"></span>
										</div>
									</div>
									
									<!-- Saving Throws Column -->
									<div class="flex space-x-2">
										<div class="flex flex-col items-center space-y-1">
											<label class="label-text font-semibold h-6 mb-1 text-center" style="width: 50px;">Base</label>
											<span id="npc-strength-saving-throw-base" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
											<span id="npc-dexterity-saving-throw-base" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
											<span id="npc-constitution-saving-throw-base" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
											<span id="npc-intelligence-saving-throw-base" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
											<span id="npc-wisdom-saving-throw-base" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
											<span id="npc-charisma-saving-throw-base" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
										</div>
										<div class="flex flex-col items-center space-y-1">
											<label class="label-text font-semibold h-6 mb-1 text-center" style="width: 80px;">Proficiency</label>
											<div class="h-6 flex items-center justify-center"><input type="checkbox" id="npc-strength-saving-throw-prof" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="h-6 flex items-center justify-center"><input type="checkbox" id="npc-dexterity-saving-throw-prof" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="h-6 flex items-center justify-center"><input type="checkbox" id="npc-constitution-saving-throw-prof" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="h-6 flex items-center justify-center"><input type="checkbox" id="npc-intelligence-saving-throw-prof" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="h-6 flex items-center justify-center"><input type="checkbox" id="npc-wisdom-saving-throw-prof" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="h-6 flex items-center justify-center"><input type="checkbox" id="npc-charisma-saving-throw-prof" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
										</div>
										<div class="flex flex-col items-center space-y-1">
											<label class="label-text font-semibold h-6 mb-1 text-center" style="width: 50px;">Adjust</label>
											<input type="number" id="npc-strength-saving-throw-adjust" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="-9" max="9">
											<input type="number" id="npc-dexterity-saving-throw-adjust" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="-9" max="9">
											<input type="number" id="npc-constitution-saving-throw-adjust" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="-9" max="9">
											<input type="number" id="npc-intelligence-saving-throw-adjust" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="-9" max="9">
											<input type="number" id="npc-wisdom-saving-throw-adjust" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="-9" max="9">
											<input type="number" id="npc-charisma-saving-throw-adjust" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="-9" max="9">
										</div>
										<div class="flex flex-col items-center space-y-1">
											<label class="label-text font-semibold h-6 mb-1 text-center" style="width: 50px;">Total</label>
											<span id="npc-strength-saving-throw-total" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
											<span id="npc-dexterity-saving-throw-total" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
											<span id="npc-constitution-saving-throw-total" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
											<span id="npc-intelligence-saving-throw-total" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
											<span id="npc-wisdom-saving-throw-total" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
											<span id="npc-charisma-saving-throw-total" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
										</div>
									</div>

								</div>
							</div>
						</div>
					</div>

					<!-- Card: Resistances -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-white px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">Resistances</h2>
						</div>
						<div class="card-body">
							<div class="p-4 min-h-[10rem]"><!-- Placeholder space --></div>
						</div>
					</div>

					<!-- Card: Skills and Languages -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-white px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">Skills and Languages</h2>
						</div>
						<div class="card-body">
							<div class="p-4 min-h-[10rem]"><!-- Placeholder space --></div>
						</div>
					</div>

					<!-- Card: Traits -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-white px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">Traits</h2>
						</div>
						<div class="card-body">
							<div class="p-4 min-h-[10rem]"><!-- Placeholder space --></div>
						</div>
					</div>

					<!-- Card: Actions -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-white px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">Actions</h2>
						</div>
						<div class="card-body">
							<div class="p-4 min-h-[10rem]"><!-- Placeholder space --></div>
						</div>
					</div>

					<!-- Card: Description -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-white px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">Description</h2>
						</div>
						<div class="card-body">
							<div class="p-2">
								<input id="npc-description" type="hidden" name="content">
								<trix-editor input="npc-description" class="trix-content"></trix-editor>
							</div>
						</div>
					</div>
				</div>

				<!-- Right Column: Sticky on large screens -->
				<aside class="w-[500px] flex-shrink-0 lg:sticky top-36">
					<div id="viewport" class="w-[500px] h-[800px] bg-cover bg-center rounded-xl custom-shadow overflow-auto bordered-container" style=" padding-top: 10px; background-image: url(&quot;graphics/viewport.jpg&quot;); background-repeat: repeat; background-position: top left; background-size: auto; ">
						<!-- The generated HTML will eventually be injected here -->
					</div>
				</aside>
			</main>
		</div>

		<!-- Modals -->
		<div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
			
			<!-- New Project Modal -->
			<div id="new-project-modal" class="bg-white rounded-xl custom-shadow bordered-container card-font-style p-4 space-y-3 w-80 hidden">
				<div class="flex justify-between items-center mb-2">
					<h3 class="font-bold text-slate-700">Create New Project</h3>
					<button class="modal-close-btn text-gray-500 hover:text-black text-2xl leading-none">&times;</button>
				</div>
				<div class="space-y-2">
					<div>
						<label for="new-project-name" class="label-text">Project Name</label>
						<input type="text" id="new-project-name" class="info-input w-full">
					</div>
				</div>
				<div class="text-right pt-2">
					<button id="create-project-btn" class="bg-[#87CC24] text-black px-4 py-1 rounded-md text-sm hover:opacity-80 font-semibold">Create</button>
				</div>
			</div>

			<!-- Load Project Modal -->
			<div id="load-project-modal" class="bg-white rounded-xl custom-shadow bordered-container card-font-style p-4 space-y-3 w-96 hidden">
				<div class="flex justify-between items-center mb-2">
					<h3 class="font-bold text-slate-700">Load Project</h3>
					<button class="modal-close-btn text-gray-500 hover:text-black text-2xl leading-none">&times;</button>
				</div>
				<div id="project-list" class="space-y-2 max-h-80 overflow-y-auto">
					<!-- Project items will be injected here -->
				</div>
			</div>

			<!-- Hit Dice Calculator Modal -->
			<div id="hp-modal" class="bg-white rounded-xl custom-shadow bordered-container card-font-style p-4 space-y-3 w-64 hidden">
				<div class="flex justify-between items-center mb-2">
					<h3 class="font-bold text-slate-700">Hit Dice Calculator</h3>
					<button id="hp-modal-close" class="text-gray-500 hover:text-black text-2xl leading-none">&times;</button>
				</div>
				<div class="space-y-2">
					<div>
						<label for="hp-num-dice" class="label-text">Number of Dice</label>
						<input type="number" id="hp-num-dice" class="info-input w-full" value="1" min="1">
					</div>
					<div>
						<label for="hp-die-type" class="label-text">Die Type</label>
						<select id="hp-die-type" class="info-select w-full">
							<option value="4">d4</option>
							<option value="6">d6</option>
							<option value="8" selected>d8</option>
							<option value="10">d10</option>
							<option value="12">d12</option>
							<option value="20">d20</option>
						</select>
					</div>
					<div>
						<label for="hp-bonus" class="label-text">Bonus</label>
						<input type="number" id="hp-bonus" class="info-input w-full" value="0">
					</div>
				</div>
				<div class="text-right pt-2">
					<button id="hp-apply-btn" class="bg-[#87CC24] text-black px-4 py-1 rounded-md text-sm hover:opacity-80 font-semibold">Apply</button>
				</div>
			</div>

		</div>

		<script>
			document.addEventListener("DOMContentLoaded", () => {
				
				// --- DATABASE SETUP ---
				const db = new Dexie('npcEngineerDB');
				db.version(1).stores({
					projects: '++id, projectName' // Primary key and index
				});

				// --- DATA & STATE ---
				let activeProject = null;
				let activeNPC = null;
				let activeNPCIndex = -1;
				
				const defaultNPC = {
					name: "", size: "", type: "", species: "", alignment: "",
					armorClass: "", hitPoints: "", challenge: "0", experience: "10", proficiencyBonus: 2,
					strength: 10, strengthBonus: 0, dexterity: 10, dexterityBonus: 0, constitution: 10, constitutionBonus: 0,
					intelligence: 10, intelligenceBonus: 0, wisdom: 10, wisdomBonus: 0, charisma: 10, charismaBonus: 0,
					strengthSavingThrowProf: false, strengthSavingThrowAdjust: 0,
					dexteritySavingThrowProf: false, dexteritySavingThrowAdjust: 0,
					constitutionSavingThrowProf: false, constitutionSavingThrowAdjust: 0,
					intelligenceSavingThrowProf: false, intelligenceSavingThrowAdjust: 0,
					wisdomSavingThrowProf: false, wisdomSavingThrowAdjust: 0,
					charismaSavingThrowProf: false, charismaSavingThrowAdjust: 0,
					gender: "neutral", isUnique: false, isProperName: false, description: "", token: "", image: ""
				};

				const crToXpMap = {
					'0': '10', '1/8': '25', '1/4': '50', '1/2': '100', '1': '200', '2': '450', '3': '700',
					'4': '1,100', '5': '1,800', '6': '2,300', '7': '2,900', '8': '3,900', '9': '5,000', '10': '5,900',
					'11': '7,200', '12': '8,400', '13': '10,000', '14': '11,500', '15': '13,000', '16': '15,000',
					'17': '18,000', '18': '20,000', '19': '22,000', '20': '25,000', '21': '33,000', '22': '41,000',
					'23': '50,000', '24': '62,000', '25': '75,000', '26': '90,000', '27': '105,000', '28': '120,000',
					'29': '135,000', '30': '155,000'
				};

				const challengeOrder = ['0','1/8','1/4','1/2','1','2','3','4','5','6','7','8','9','10',
													'11','12','13','14','15','16','17','18','19','20','21','22','23',
													'24','25','26','27','28','29','30'];

				// --- UI ELEMENTS ---
				const mainContentColumn = document.getElementById('main-content-column');
				const viewport = document.getElementById("viewport");
				const projectStatusEl = document.getElementById("project-status");
				
				// Project Buttons
				const newProjectBtn = document.getElementById("newProjectBtn");
				const loadProjectBtn = document.getElementById("loadProjectBtn");
				const exportProjectBtn = document.getElementById("exportProjectBtn");
				const importProjectBtn = document.getElementById("importProjectBtn");

				// NPC Buttons
				const newNpcBtn = document.getElementById("newNpcBtn");
				const importNpcBtn = document.getElementById("importNpcBtn");
				const exportNpcBtn = document.getElementById("exportNpcBtn");
				const deleteNpcBtn = document.getElementById("deleteNpcBtn");
				
				// Menu Items
				const hamburgerBtn = document.getElementById('hamburger-btn');
				const mainMenu = document.getElementById('main-menu');
				const menuNewProject = document.getElementById('menu-new-project');
				const menuLoadProject = document.getElementById('menu-load-project');
				const menuImportProject = document.getElementById('menu-import-project');
				const menuExportProject = document.getElementById('menu-export-project');
				const menuNewNpc = document.getElementById('menu-new-npc');
				const menuImportNpc = document.getElementById('menu-import-npc');
				const menuExportNpc = document.getElementById('menu-export-npc');
				const menuDeleteNpc = document.getElementById('menu-delete-npc');

				// NPC Selector
				const npcSelector = document.getElementById("npc-selector");

				// Modals & Overlays
				const modalOverlay = document.getElementById("modal-overlay");
				const newProjectModal = document.getElementById("new-project-modal");
				const loadProjectModal = document.getElementById("load-project-modal");
				const hpModal = document.getElementById("hp-modal");
				
				// Modal-specific elements
				const createProjectBtn = document.getElementById("create-project-btn");
				const newProjectNameInput = document.getElementById("new-project-name");
				const projectListDiv = document.getElementById("project-list");

				const tokenBox = document.getElementById("npc-token");
				const tokenUpload = document.getElementById("token-upload");
				const imageBox = document.getElementById("npc-image");
				const imageUpload = document.getElementById("image-upload");

				const hpModalCloseBtn = document.getElementById("hp-modal-close");
				const hpApplyBtn = document.getElementById("hp-apply-btn");
				const numDiceInput = document.getElementById("hp-num-dice");
				const dieTypeSelect = document.getElementById("hp-die-type");
				const bonusInput = document.getElementById("hp-bonus");
				const experienceDisplay = document.getElementById("npc-experience-display");
				const proficiencyBonusDisplay = document.getElementById("npc-proficiency-bonus-display");

				// --- FORM INPUTS ---
				const inputs = {
					name: document.getElementById("npc-name"),
					size: document.getElementById("npc-size"),
					type: document.getElementById("npc-type"),
					species: document.getElementById("npc-species"),
					alignment: document.getElementById("npc-alignment"),
					armorClass: document.getElementById("npc-ac"),
					hitPoints: document.getElementById("npc-hp"),
					challenge: document.getElementById("npc-challenge"),
					strength: document.getElementById("npc-strength"),
					dexterity: document.getElementById("npc-dexterity"),
					constitution: document.getElementById("npc-constitution"),
					intelligence: document.getElementById("npc-intelligence"),
					wisdom: document.getElementById("npc-wisdom"),
					charisma: document.getElementById("npc-charisma"),
					gender: document.getElementById("npc-gender"),
					isUnique: document.getElementById("npc-unique"),
					isProperName: document.getElementById("npc-proper"),
					description: document.getElementById("npc-description") // hidden input for Trix
				};

				// --- FUNCTIONS ---

				// --- Project Management ---
				function showNewProjectModal() {
					modalOverlay.classList.remove('hidden');
					newProjectModal.classList.remove('hidden');
					newProjectNameInput.focus();
				}

				async function createNewProject() {
					const projectName = newProjectNameInput.value.trim();
					if (!projectName) {
						alert("Project name cannot be empty.");
						return;
					}

					const newProject = {
						projectName: projectName,
						metadata: { createdAt: new Date() },
						npcs: [{ ...defaultNPC }]
					};

					try {
						const newId = await db.projects.add(newProject);
						newProject.id = newId;
						loadProject(newProject);
						hideAllModals();
						newProjectNameInput.value = "";
					} catch (error) {
						console.error("Failed to create project:", error);
						alert("Error: Could not create project. Check console for details.");
					}
				}

				function loadProject(project) {
					activeProject = project;
					// Select the first NPC by default
					switchActiveNPC(0);
					updateUIForActiveProject();
				}
				
				function switchActiveNPC(index) {
					if (activeProject && index >= 0 && index < activeProject.npcs.length) {
						activeNPCIndex = index;
						activeNPC = activeProject.npcs[index];
						updateFormFromActiveNPC();
					}
				}

				async function saveActiveProjectToDB() {
					if (activeProject && activeProject.id) {
						try {
							await db.projects.put(activeProject);
						} catch (error) {
							console.error("Failed to save project to DB:", error);
						}
					}
				}

				async function exportProject() {
					if (!activeProject) return;
					
					const projectJson = JSON.stringify(activeProject, null, 2);
					try {
						const handle = await window.showSaveFilePicker({
							suggestedName: `Project-${activeProject.projectName}.json`,
							types: [{ description: "JSON Files", accept: { "application/json": [".json"] } }]
						});
						const writable = await handle.createWritable();
						await writable.write(projectJson);
						await writable.close();
					} catch (err) {
						if (err.name !== "AbortError") console.error("Error exporting project:", err);
					}
				}

				async function importProject() {
					try {
						const [handle] = await window.showOpenFilePicker({
							types: [{ description: "JSON Files", accept: { "application/json": [".json"] } }]
						});
						const file = await handle.getFile();
						const content = await file.text();
						const importedProject = JSON.parse(content);
						
						// Remove existing ID to ensure a new one is created on import
						delete importedProject.id; 

						await db.projects.add(importedProject);
						alert(`Project "${importedProject.projectName}" imported successfully!`);
					} catch (err) {
						if (err.name !== "AbortError") {
							console.error("Error importing project:", err);
							alert("Failed to import project.");
						}
					}
				}
				
				// --- NPC Management ---
				function createNewNpc() {
					if (!activeProject) return;
					const newNpc = { ...defaultNPC };
					activeProject.npcs.push(newNpc);
					switchActiveNPC(activeProject.npcs.length - 1);
					saveActiveProjectToDB();
					inputs.name.focus();
				}
				
				function deleteCurrentNpc() {
					if (!activeProject || activeProject.npcs.length <= 1) return;

					const oldIndex = activeNPCIndex;
					activeProject.npcs.splice(oldIndex, 1);
					
					const newIndex = Math.max(0, oldIndex - 1);
					switchActiveNPC(newIndex);
					saveActiveProjectToDB();
				}

				async function importNpc() {
					if (!activeProject) return;
					
					try {
						const [handle] = await window.showOpenFilePicker({
							types: [{ description: "JSON Files", accept: { "application/json": [".json"] } }]
						});
						const file = await handle.getFile();
						const content = await file.text();
						const loadedNPC = JSON.parse(content);
						
						const newNpc = { ...defaultNPC, ...loadedNPC };
						
						activeProject.npcs.push(newNpc);
						switchActiveNPC(activeProject.npcs.length - 1);
						saveActiveProjectToDB();
						
					} catch (err) {
						if (err.name !== "AbortError") console.error("Error importing NPC:", err);
					}
				}

				async function exportNpc() {
					if (!activeNPC) return;

					const npcJson = JSON.stringify(activeNPC, null, 2);
					try {
						const handle = await window.showSaveFilePicker({
							suggestedName: `${activeNPC.name || "unnamed-npc"}.json`,
							types: [{ description: "JSON Files", accept: { "application/json": [".json"] } }]
						});
						const writable = await handle.createWritable();
						await writable.write(npcJson);
						await writable.close();
					} catch (err) {
						if (err.name !== "AbortError") console.error("Error exporting NPC:", err);
					}
				}
				
				// --- UI & State Update Functions ---
				function updateMenuState() {
					const hasActiveProject = !!activeProject;
					const menuItemsToToggle = [
						menuExportProject, menuNewNpc, menuImportNpc,
						menuExportNpc, menuDeleteNpc
					];

					menuItemsToToggle.forEach(item => {
						if (hasActiveProject) {
							item.classList.remove('disabled');
						} else {
							item.classList.add('disabled');
						}
					});
					
					if (hasActiveProject && activeProject.npcs.length <= 1) {
						menuDeleteNpc.classList.add('disabled');
					}
				}

				function updateUIForActiveProject() {
					if (activeProject) {
						projectStatusEl.textContent = `Project: ${activeProject.projectName}`;
						mainContentColumn.style.opacity = '1';
						mainContentColumn.style.pointerEvents = 'auto';
						npcSelector.classList.remove('hidden');
						deleteNpcBtn.classList.remove('hidden');
						[newNpcBtn, importNpcBtn, exportNpcBtn, deleteNpcBtn].forEach(btn => btn.disabled = false);
					} else {
						projectStatusEl.textContent = "No Project Loaded";
						mainContentColumn.style.opacity = '0.3';
						mainContentColumn.style.pointerEvents = 'none';
						npcSelector.classList.add('hidden');
						deleteNpcBtn.classList.add('hidden');
						[newNpcBtn, importNpcBtn, exportNpcBtn, deleteNpcBtn].forEach(btn => btn.disabled = true);
					}
					updateMenuState();
					updateFormFromActiveNPC();
				}
				
				function updateNpcSelector() {
					if (!activeProject) return;
					
					npcSelector.innerHTML = '';
					activeProject.npcs.forEach((npc, index) => {
						if (npc.name) { // Only add NPCs with names
							const option = document.createElement('option');
							option.value = index;
							option.textContent = npc.name;
							if (index === activeNPCIndex) {
								option.selected = true;
							}
							npcSelector.appendChild(option);
						}
					});

					// Handle case where current NPC is unnamed
					if (activeNPC && !activeNPC.name) {
						const option = document.createElement('option');
						option.value = activeNPCIndex;
						option.textContent = "New Unnamed NPC";
						option.selected = true;
						option.disabled = true;
						npcSelector.appendChild(option);
					}
					
					deleteNpcBtn.disabled = activeProject.npcs.length <= 1;
				}
				
				function updateFormFromActiveNPC() {
					if (!activeNPC) {
						Object.values(inputs).forEach(input => {
							if (input.type === 'checkbox') input.checked = false;
							else input.value = '';
						});
						document.querySelector("trix-editor").editor.loadHTML("");
						viewport.innerHTML = '';
						updateNpcSelector();
						return;
					}

					for (const key in inputs) {
						if (key === 'description') {
							const trixEditorElement = document.querySelector("trix-editor");
							inputs.description.value = activeNPC[key] || '';
							if (trixEditorElement && trixEditorElement.editor) {
								trixEditorElement.editor.loadHTML(activeNPC[key] || "");
							}
							continue;
						}
						const element = inputs[key];
						const customToggle = document.getElementById(`toggle-custom-${key}`);
						if (customToggle) {
							const select = element;
							const customInput = document.getElementById(`npc-${key}-custom`);
							const npcValue = activeNPC[key] || "";
							const isStandardOption = [...select.options].some(opt => opt.value === npcValue && !opt.disabled);
							if (isStandardOption || npcValue === "") {
								select.value = npcValue;
								customToggle.checked = false;
								select.classList.remove('hidden');
								customInput.classList.add('hidden');
							} else {
								customInput.value = npcValue;
								customToggle.checked = true;
								select.classList.add('hidden');
								customInput.classList.remove('hidden');
								select.value = "";
							}
						} else if (element.type === "checkbox") {
							element.checked = activeNPC[key] || false;
						} else {
							element.value = activeNPC[key] || "";
						}
					}

					const abilities = ['strength','dexterity','constitution','intelligence','wisdom','charisma'];
					abilities.forEach(ability => {
						document.getElementById(`npc-${ability}-saving-throw-prof`).checked = activeNPC[`${ability}SavingThrowProf`] || false;
						document.getElementById(`npc-${ability}-saving-throw-adjust`).value = activeNPC[`${ability}SavingThrowAdjust`] || 0;
					});

					experienceDisplay.textContent = activeNPC.experience || '';
					proficiencyBonusDisplay.textContent = `+${activeNPC.proficiencyBonus}` || '+2';
					updateTokenDisplay();
					updateImageDisplay();
					updateAbilityBonuses();
					updateViewport();
					updateNpcSelector();
				}

				function updateActiveNPCFromForm() {
					if (!activeNPC) return;
					
					const wasUnnamed = !activeNPC.name;

					for (const key in inputs) {
						if (key === 'description') {
							activeNPC[key] = inputs.description.value;
							continue;
						}
						const element = inputs[key];
						const customToggle = document.getElementById(`toggle-custom-${key}`);
						if (customToggle) {
							if (customToggle.checked) {
								const customInput = document.getElementById(`npc-${key}-custom`);
								activeNPC[key] = customInput.value;
							} else {
								activeNPC[key] = element.value;
							}
						} else if (element.type === "checkbox") {
							activeNPC[key] = element.checked;
						} else {
							activeNPC[key] = element.value;
						}
					}
					
					const abilities = ['strength','dexterity','constitution','intelligence','wisdom','charisma'];
					abilities.forEach(ability => {
						activeNPC[`${ability}SavingThrowProf`] = document.getElementById(`npc-${ability}-saving-throw-prof`).checked;
						activeNPC[`${ability}SavingThrowAdjust`] = parseInt(document.getElementById(`npc-${ability}-saving-throw-adjust`).value, 10) || 0;
					});

					activeNPC.experience = experienceDisplay.textContent;
					activeNPC.proficiencyBonus = parseInt(proficiencyBonusDisplay.textContent.replace('+', ''), 10);
					updateAbilityBonuses();
					updateViewport();

					if (wasUnnamed && activeNPC.name) {
						updateNpcSelector(); 
					} else {
						// Update the text of the current option if name changes
						const currentOption = npcSelector.options[npcSelector.selectedIndex];
						if(currentOption) {
							currentOption.textContent = activeNPC.name || "Unnamed NPC";
						}
					}

					saveActiveProjectToDB(); // Auto-save on any change
				}

				function calculateAbilityBonus(score) {
					return Math.floor((parseInt(score, 10) - 10) / 2);
				}

				function calculateProficiencyBonus(cr) {
					const crValue = Number(String(cr).replace(/[^0-9.]/g, ''));
					if (crValue <= 4) return 2;
					if (crValue <= 8) return 3;
					if (crValue <= 12) return 4;
					if (crValue <= 16) return 5;
					if (crValue <= 20) return 6;
					if (crValue <= 24) return 7;
					if (crValue <= 28) return 8;
					return 9; // for CR 29-30
				}
				
				function updateSavingThrows() {
					if (!activeNPC) return;
					const abilities = ['strength','dexterity','constitution','intelligence','wisdom','charisma'];
					const profBonus = activeNPC.proficiencyBonus || 2;
					
					abilities.forEach(ability => {
						const base = activeNPC[`${ability}Bonus`] || 0;
						const isProficient = document.getElementById(`npc-${ability}-saving-throw-prof`).checked;
						const adjust = parseInt(document.getElementById(`npc-${ability}-saving-throw-adjust`).value, 10) || 0;
						
						const total = base + (isProficient ? profBonus : 0) + adjust;
						
						const baseEl = document.getElementById(`npc-${ability}-saving-throw-base`);
						const totalEl = document.getElementById(`npc-${ability}-saving-throw-total`);
						
						baseEl.textContent = base >= 0 ? `+${base}` : base;
						totalEl.textContent = total >= 0 ? `+${total}` : total;
					});
				}

				function updateAbilityBonuses() {
					if (!activeNPC) return;
					const abilities = ['strength','dexterity','constitution','intelligence','wisdom','charisma'];
					abilities.forEach(ability => {
						const score = parseInt(inputs[ability].value, 10) || 10;
						const bonus = calculateAbilityBonus(score);
						const bonusEl = document.getElementById(`npc-${ability}-bonus`);
						if (bonusEl) {
							bonusEl.textContent = bonus >= 0 ? `+${bonus}` : bonus;
						}
						activeNPC[ability] = score;
						activeNPC[`${ability}Bonus`] = bonus;
					});
					updateSavingThrows();
				}

				function updateViewport() {
					if (!activeNPC) {
						viewport.innerHTML = '';
						return;
					}
					const {
						name, size, type, species, alignment, armorClass, hitPoints, description,
						strength, dexterity, constitution, intelligence, wisdom, charisma,
						strengthBonus, dexterityBonus, constitutionBonus, intelligenceBonus, wisdomBonus, charismaBonus
					} = activeNPC;

					const NPCName = name || "";
					const NPCac = armorClass || "";
					const NPChp = hitPoints || "";
					const NPCDescriptionHTML = description || "";

					let NPCTypeString = `${size || ""} ${type || ""}`.trim();
					if (species) { NPCTypeString += ` (${species})`; }
					if (alignment) { NPCTypeString += `, ${alignment}`; }

					const NPCspeed = "";
					const NPCstr = strength || "10";
					const NPCstrbo = strengthBonus !== undefined ? (strengthBonus >= 0 ? `+${strengthBonus}` : strengthBonus) : "+0";
					const NPCdex = dexterity || "10";
					const NPCdexbo = dexterityBonus !== undefined ? (dexterityBonus >= 0 ? `+${dexterityBonus}` : dexterityBonus) : "+0";
					const NPCcon = constitution || "10";
					const NPCconbo = constitutionBonus !== undefined ? (constitutionBonus >= 0 ? `+${constitutionBonus}` : constitutionBonus) : "+0";
					const NPCint = intelligence || "10";
					const NPCintbo = intelligenceBonus !== undefined ? (intelligenceBonus >= 0 ? `+${intelligenceBonus}` : intelligenceBonus) : "+0";
					const NPCwis = wisdom || "10";
					const NPCwisbo = wisdomBonus !== undefined ? (wisdomBonus >= 0 ? `+${wisdomBonus}` : wisdomBonus) : "+0";
					const NPCcha = charisma || "10";
					const NPCchabo = charismaBonus !== undefined ? (charismaBonus >= 0 ? `+${charismaBonus}` : charismaBonus) : "+0";

					const generatedHtml = `
						<div class="container">
							<div class="cap"></div>
							<div class="npcname"><b>${NPCName}</b></div>
							<div class="npctype"><i>${NPCTypeString}</i></div>
							<div class="npcdiv">
								<svg viewBox="0 0 200 5" preserveAspectRatio="none" width="100%" height="5">
									<polyline points="0,0 200,2.5 0,5" fill="#922610" class="whoosh"></polyline>
								</svg>
							</div>
							<div class="npctop"><b>Armor Class</b> ${NPCac}</div>
							<div class="npctop"><b>Hit Points</b> ${NPChp}</div>
							<div class="npctop"><b>Speed</b> ${NPCspeed}</div>
							<div class="npcdiv">
								<svg viewBox="0 0 200 5" preserveAspectRatio="none" width="100%" height="5">
									<polyline points="0,0 200,2.5 0,5" fill="#922610" class="whoosh"></polyline>
								</svg>
							</div>
							<div class="npctop">
								<table class="attr" width="100%">
									<tbody>
										<tr valign="middle">
											<td><b>STR</b></td> <td><b>DEX</b></td> <td><b>CON</b></td>
											<td><b>INT</b></td> <td><b>WIS</b></td> <td><b>CHA</b></td>
										</tr>
										<tr valign="middle">
											<td>${NPCstr} (${NPCstrbo})</td> <td>${NPCdex} (${NPCdexbo})</td> <td>${NPCcon} (${NPCconbo})</td>
											<td>${NPCint} (${NPCintbo})</td> <td>${NPCwis} (${NPCwisbo})</td> <td>${NPCcha} (${NPCchabo})</td>
										</tr>
									</tbody>
								</table>
							</div>
							<div class="npcdiv">
								<svg viewBox="0 0 200 5" preserveAspectRatio="none" width="100%" height="5">
									<polyline points="0,0 200,2.5 0,5" fill="#922610" class="whoosh"></polyline>
								</svg>
							</div>
							<div class="npcdescrip"> ${NPCDescriptionHTML} </div>
						</div>
					`;
					viewport.innerHTML = generatedHtml;
				}

				function updateTokenDisplay() {
					tokenBox.innerHTML = '';
					if (activeNPC && activeNPC.token) {
						const img = document.createElement('img');
						img.src = activeNPC.token;
						img.className = 'w-full h-full object-contain';
						tokenBox.appendChild(img);
					} else {
						const placeholder = document.createElement('span');
						placeholder.textContent = 'Click or Drag a Token Image Here';
						tokenBox.appendChild(placeholder);
					}
				}

				function updateImageDisplay() {
					imageBox.innerHTML = '';
					if (activeNPC && activeNPC.image) {
						const img = document.createElement('img');
						img.src = activeNPC.image;
						img.className = 'w-full h-full object-contain';
						imageBox.appendChild(img);
					} else {
						const placeholder = document.createElement('span');
						placeholder.textContent = 'Click or Drag an NPC Image Here';
						imageBox.appendChild(placeholder);
					}
				}
				
				function populateChallengeDropdown() {
					const challengeSelect = inputs.challenge;
					challengeOrder.forEach(cr => {
						const option = document.createElement('option');
						option.value = cr;
						option.textContent = cr;
						challengeSelect.appendChild(option);
					});
				}

				function setupCustomToggles() {
					const fields = ['size','type','species','alignment'];
					fields.forEach(field => {
						const toggle = document.getElementById(`toggle-custom-${field}`);
						const select = document.getElementById(`npc-${field}`);
						const customInput = document.getElementById(`npc-${field}-custom`);
						if (toggle && select && customInput) {
							toggle.addEventListener('change', () => {
								if (toggle.checked) {
									select.classList.add('hidden');
									customInput.classList.remove('hidden');
									customInput.value = select.value;
									customInput.focus();
								} else {
									select.classList.remove('hidden');
									customInput.classList.add('hidden');
								}
								updateActiveNPCFromForm();
							});
							customInput.addEventListener('input', updateActiveNPCFromForm);
						}
					});
				}
				
				function setupSavingThrowListeners() {
					const abilities = ['strength','dexterity','constitution','intelligence','wisdom','charisma'];
					abilities.forEach(ability => {
						document.getElementById(`npc-${ability}-saving-throw-prof`).addEventListener('input', updateActiveNPCFromForm);
						document.getElementById(`npc-${ability}-saving-throw-adjust`).addEventListener('input', updateActiveNPCFromForm);
					});
				}

				function setupDragAndDrop(box, validTypes, npcKey, updateFn) {
					["dragenter","dragover","dragleave","drop"].forEach(eventName => {
						box.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
					});
					["dragenter","dragover"].forEach(eventName => {
						box.addEventListener(eventName, () => box.classList.add("drag-over"));
					});
					["dragleave","drop"].forEach(eventName => {
						box.addEventListener(eventName, () => box.classList.remove("drag-over"));
					});
					box.addEventListener("drop", e => {
						if (!activeNPC) return;
						const file = e.dataTransfer.files && e.dataTransfer.files[0];
						if (file && validTypes.includes(file.type)) {
							const reader = new FileReader();
							reader.onload = ev => {
								activeNPC[npcKey] = ev.target.result;
								updateFn();
								saveActiveProjectToDB();
							};
							reader.readAsDataURL(file);
						} else {
							console.warn("Invalid file type dropped.");
						}
					});
				}
				
				// --- Modal Handling ---
				function hideAllModals() {
					modalOverlay.classList.add('hidden');
					newProjectModal.classList.add('hidden');
					loadProjectModal.classList.add('hidden');
					hpModal.classList.add('hidden');
				}

				async function showLoadProjectModal() {
					const projects = await db.projects.toArray();
					projectListDiv.innerHTML = ''; // Clear previous list
					if (projects.length === 0) {
						projectListDiv.innerHTML = '<p class="text-gray-500">No projects found.</p>';
					} else {
						projects.forEach(proj => {
							const projEl = document.createElement('div');
							projEl.className = 'p-2 border rounded-md cursor-pointer hover:bg-gray-100';
							projEl.textContent = proj.projectName;
							projEl.onclick = () => {
								loadProject(proj);
								hideAllModals();
							};
							projectListDiv.appendChild(projEl);
						});
					}
					modalOverlay.classList.remove('hidden');
					loadProjectModal.classList.remove('hidden');
				}

				// --- EVENT LISTENERS ---
				
				// Icon Buttons
				newProjectBtn.addEventListener('click', showNewProjectModal);
				loadProjectBtn.addEventListener('click', showLoadProjectModal);
				importProjectBtn.addEventListener('click', importProject);
				exportProjectBtn.addEventListener('click', exportProject);
				newNpcBtn.addEventListener("click", createNewNpc);
				importNpcBtn.addEventListener("click", importNpc);
				exportNpcBtn.addEventListener("click", exportNpc);
				
				// Menu Items
				menuNewProject.addEventListener('click', (e) => { e.preventDefault(); showNewProjectModal(); mainMenu.classList.add('hidden'); });
				menuLoadProject.addEventListener('click', (e) => { e.preventDefault(); showLoadProjectModal(); mainMenu.classList.add('hidden'); });
				menuImportProject.addEventListener('click', (e) => { e.preventDefault(); importProject(); mainMenu.classList.add('hidden'); });
				menuExportProject.addEventListener('click', (e) => { e.preventDefault(); if(!menuExportProject.classList.contains('disabled')) exportProject(); mainMenu.classList.add('hidden'); });
				menuNewNpc.addEventListener('click', (e) => { e.preventDefault(); if(!menuNewNpc.classList.contains('disabled')) createNewNpc(); mainMenu.classList.add('hidden'); });
				menuImportNpc.addEventListener('click', (e) => { e.preventDefault(); if(!menuImportNpc.classList.contains('disabled')) importNpc(); mainMenu.classList.add('hidden'); });
				menuExportNpc.addEventListener('click', (e) => { e.preventDefault(); if(!menuExportNpc.classList.contains('disabled')) exportNpc(); mainMenu.classList.add('hidden'); });
				menuDeleteNpc.addEventListener('click', (e) => { e.preventDefault(); if(!menuDeleteNpc.classList.contains('disabled')) deleteCurrentNpc(); mainMenu.classList.add('hidden'); });
				
				// Hamburger Menu Logic
				hamburgerBtn.addEventListener('click', (e) => {
					e.stopPropagation();
					mainMenu.classList.toggle('hidden');
				});

				window.addEventListener('click', (e) => {
					if (!mainMenu.classList.contains('hidden') && !hamburgerBtn.contains(e.target)) {
						mainMenu.classList.add('hidden');
					}
				});
				
				// Modal Buttons
				createProjectBtn.addEventListener('click', createNewProject);
				newProjectNameInput.addEventListener('keyup', (e) => {
					if (e.key === 'Enter') createProjectBtn.click();
				});
				
				// NPC Selector
				npcSelector.addEventListener('change', (e) => {
					const newIndex = parseInt(e.target.value, 10);
					if (newIndex !== activeNPCIndex) {
						switchActiveNPC(newIndex);
					}
				});
				
				document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', hideAllModals));
				modalOverlay.addEventListener('click', (e) => {
					if (e.target === modalOverlay) hideAllModals();
				});

				document.querySelectorAll('.card-header').forEach((header) => {
					header.addEventListener("click", () => {
						const cardBody = header.nextElementSibling;
						if (cardBody) {
							if (cardBody.classList.contains('open')) {
								cardBody.classList.remove('open');
								cardBody.style.paddingTop = '0';
								cardBody.style.paddingBottom = '0';
							} else {
								cardBody.classList.add('open');
								cardBody.style.paddingTop = '0.5rem';
								cardBody.style.paddingBottom = '0.5rem';
							}
						}
					});
				});

				Object.values(inputs).forEach((input) => {
					if(input.id !== 'npc-description') {
						input.addEventListener("input", updateActiveNPCFromForm);
					}
				});

				inputs.challenge.addEventListener('change', () => {
					const selectedCr = inputs.challenge.value;
					experienceDisplay.textContent = crToXpMap[selectedCr] || '';
					const profBonus = calculateProficiencyBonus(selectedCr);
					proficiencyBonusDisplay.textContent = `+${profBonus}`;
					updateActiveNPCFromForm();
					updateSavingThrows();
				});

				document.querySelector("trix-editor").addEventListener("trix-change", updateActiveNPCFromForm);

				tokenBox.addEventListener('click', () => activeNPC && tokenUpload.click());
				tokenUpload.addEventListener('change', (event) => {
					const file = event.target.files[0];
					if (activeNPC && file && (file.type === "image/png" || file.type === "image/webp")) {
						const reader = new FileReader();
						reader.onload = function(e) {
							activeNPC.token = e.target.result;
							updateTokenDisplay();
							saveActiveProjectToDB();
						};
						reader.readAsDataURL(file);
					}
				});

				imageBox.addEventListener('click', () => activeNPC && imageUpload.click());
				imageUpload.addEventListener('change', (event) => {
					const file = event.target.files[0];
					if (activeNPC && file && (file.type === "image/png" || file.type === "image/webp" || file.type === "image/jpeg")) {
						const reader = new FileReader();
						reader.onload = function(e) {
							activeNPC.image = e.target.result;
							updateImageDisplay();
							saveActiveProjectToDB();
						};
						reader.readAsDataURL(file);
					}
				});

				setupDragAndDrop(tokenBox, ["image/png","image/webp"], "token", updateTokenDisplay);
				setupDragAndDrop(imageBox, ["image/png","image/webp","image/jpeg"], "image", updateImageDisplay);

				inputs.hitPoints.addEventListener('dblclick', () => {
					if (activeNPC) {
						modalOverlay.classList.remove('hidden');
						hpModal.classList.remove('hidden');
					}
				});
				hpModalCloseBtn.addEventListener('click', () => hpModal.classList.add('hidden'));
				hpApplyBtn.addEventListener('click', () => {
					const numDice = parseInt(numDiceInput.value, 10) || 0;
					const dieType = parseInt(dieTypeSelect.value, 10) || 0;
					const bonus = parseInt(bonusInput.value, 10) || 0;
					if (numDice > 0 && dieType > 0) {
						const avgRoll = (dieType / 2) + 0.5;
						const totalHp = Math.floor(numDice * avgRoll) + bonus;
						let bonusString = "";
						if (bonus > 0) { bonusString = ` + ${bonus}`; }
						else if (bonus < 0) { bonusString = ` - ${Math.abs(bonus)}`; }
						const hpString = `${totalHp} (${numDice}d${dieType}${bonusString})`;
						inputs.hitPoints.value = hpString;
						updateActiveNPCFromForm();
						hideAllModals();
					}
				});
				
				// --- INITIALIZATION ---
				populateChallengeDropdown();
				setupCustomToggles();
				setupSavingThrowListeners();
				updateUIForActiveProject(); // Initial setup for no project loaded

				document.querySelectorAll('.card-body').forEach(cardBody => {
					cardBody.classList.add('open');
					cardBody.style.paddingTop = '0.5rem';
					cardBody.style.paddingBottom = '0.5rem';
				});
			});
		</script>
	</body>
</html>


