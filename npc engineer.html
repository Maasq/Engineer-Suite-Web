<!doctype html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />

      <meta name="author" content="Maasq" />
      <meta name="description" content="A tool for creating and managing NPCs." />
      <meta name="version" content="0.01.01" />
      <meta name="date" content="2025-10-03" />

      <title>NPC Engineer</title>

      <!-- Tailwind CSS for styling -->
      <script src="https://cdn.tailwindcss.com"></script>

      <!-- Google Fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com" />
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
      <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700&display=swap" rel="stylesheet" />

      <style>
         body {
            /* A simple style for our application font */
            font-family: "Lexend", sans-serif;
         }

         .card-body {
            /* Custom styles for the card collapse/expand transition */
            max-height: 0;
            overflow: hidden;
            transition:
               max-height 0.5s ease-in-out,
               padding 0.5s ease-in-out;
            padding-top: 0;
            padding-bottom: 0;
         }
         .card-body.open {
            /* A large max-height to allow content to expand fully */
            max-height: 40rem; /* Corresponds to 640px */
            padding-top: 1rem;
            padding-bottom: 1rem;
         }
         .card-font-style { /* Sets font size for card content */
            font-size: 11pt;
         }
         .custom-shadow {
            /* Custom shadow style */
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.4);
         }
         .btn {
            @apply bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white transition duration-150 shadow-sm text-sm;
         }
         .btn:disabled {
            @apply opacity-50 cursor-not-allowed;
         }
         .input-field {
            @apply w-full bg-gray-100 border border-gray-300 rounded-md px-3 py-1 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500;
         }
         .label-text {
            @apply block text-sm font-medium text-gray-700;
         }
         .bordered-container { /* A reusable class for black borders */
            border: 1px solid black;
         }
         .info-input, .info-select { /* Custom style for specific input boxes and dropdowns */
            background-color: #F8FAFC; /* Lighter input background */
            border: 1px solid #CBD5E1; /* Adjusted darker shade for the border */
            border-radius: 2px;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            font-size: 10pt; /* Set font size for input fields */
         }
      </style>
   </head>
   <body class="bg-[#E2E8F0]">
      <!-- Background circle for the graphic -->
      <div class="absolute w-32 h-32 bg-black rounded-full custom-shadow z-10" style="top: 16px; left: 52px"></div>

      <!-- Graphic Image -->
      <img
         src="graphics/npc engineer.webp"
         alt="NPC Engineer Logo"
         class="absolute w-32 h-32 rounded-full z-30"
         style="top: 16px; left: 52px" />

      <!-- Persistent Header Bar -->
      <header
         class="fixed left-6 right-6 h-[50px] bg-gradient-to-b from-black via-gray-500 to-black border border-black rounded-xl custom-shadow z-20 flex items-center justify-between px-4"
         style="top: 44px">
         <!-- App Title -->
         <h1 class="text-3xl font-bold text-[#87CC24] ml-48">NPC Engineer</h1>
         <!-- File Management Buttons -->
         <div class="flex items-center space-x-2">
            <span id="file-status" class="text-xs text-gray-300 mr-2">No file loaded</span>
            <button id="openFileBtn" class="btn">Open File</button>
            <button id="saveFileBtn" class="btn">Save File</button>
            <button id="downloadBtn" class="btn">Download Copy</button>
         </div>
      </header>

      <!-- Main application content area -->
      <div class="relative w-full pt-40">
         <!-- This is the main container that holds both columns. -->
         <main class="w-full pr-[520px]"> <!-- Made cards wider -->
            <!-- Left Column: Contains the cards, this column will scroll -->
            <div class="px-6 pb-6 space-y-6">
               <!-- Card: NPC Information -->
               <div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
                  <div class="card-header bg-white px-3 py-1 border-b border-black/20 cursor-pointer select-none">
                     <h2 class="font-bold text-slate-700 relative" style="top: 0px;">NPC Information</h2> <!-- Nudged header text down -->
                  </div>
                  <div class="card-body open">
                     <div class="px-4 pt-2 pb-2 flex justify-start gap-x-6"> <!-- Adjusted alignment and gap -->
                        <!-- Left Column for core stats -->
                        <div class="space-y-1">
                           <div class="flex items-center mb-2"> <!-- Added space below Name -->
                              <label for="npc-name" class="label-text w-28 text-right pr-2">Name</label> <!-- Reduced padding -->
                              <input type="text" id="npc-name" class="info-input" style="width: 220px; height: 23px;" />
                           </div>
                           <div class="flex items-center">
                              <label for="npc-size" class="label-text w-28 text-right pr-2">Size</label> <!-- Reduced padding -->
                              <select id="npc-size" class="info-select" style="width: 130px; height: 23px;">
                                 <option>Tiny</option>
                                 <option>Small</option>
                                 <option>Medium</option>
                                 <option>Large</option>
                                 <option>Huge</option>
                                 <option>Gargantuan</option>
                              </select>
                           </div>
                           <div class="flex items-center">
                              <label for="npc-type" class="label-text w-28 text-right pr-2">Type</label> <!-- Reduced padding -->
                              <select id="npc-type" class="info-select" style="width: 130px; height: 23px;">
                                 <option>aberration</option>
                                 <option>beast</option>
                                 <option>celestial</option>
                                 <option>construct</option>
                                 <option>dragon</option>
                                 <option>elemental</option>
                                 <option>fey</option>
                                 <option>fiend</option>
                                 <option>giant</option>
                                 <option>humanoid</option>
                                 <option>monstrosity</option>
                                 <option>ooze</option>
                                 <option>plant</option>
                                 <option>undead</option>
                                 <option disabled>──────────</option>
                                 <option>swarm of tiny aberrations</option>
                                 <option>swarm of tiny beasts</option>
                                 <option>swarm of tiny constructs</option>
                                 <option>swarm of tiny elementals</option>
                                 <option>swarm of tiny monstrosities</option>
                                 <option>swarm of tiny oozes</option>
                                 <option>swarm of tiny plants</option>
                                 <option disabled>──────────</option>
                                 <option>trap</option>
                              </select>
                           </div>
                           <div class="flex items-center">
                              <label for="npc-sub-type" class="label-text w-28 text-right pr-2">Sub-type</label> <!-- Reduced padding -->
                              <input type="text" id="npc-sub-type" class="info-input" style="width: 130px; height: 23px;" />
                           </div>
                           <div class="flex items-center">
                              <label for="npc-alignment" class="label-text w-28 text-right pr-2">Alignment</label> <!-- Reduced padding -->
                              <input type="text" id="npc-alignment" class="info-input" style="width: 130px; height: 23px;" />
                           </div>
                           <div class="flex items-center">
                              <label for="npc-ac" class="label-text w-28 text-right pr-2">Armor Class</label> <!-- Reduced padding -->
                              <input type="number" id="npc-ac" class="info-input" style="width: 130px; height: 23px;" />
                           </div>
                           <div class="flex items-center">
                              <label for="npc-hp" class="label-text w-28 text-right pr-2">Hit Points</label> <!-- Reduced padding -->
                              <input type="number" id="npc-hp" class="info-input" style="width: 130px; height: 23px;" />
                           </div>
                        </div>
                        <!-- Right Column for other details -->
                        <div class="space-y-1">
                            <div style="height: 31px;"></div> <!-- Spacer to align with Name field -->
                           <div class="flex items-center">
                              <label for="npc-gender" class="label-text w-28 text-right pr-2">Gender</label> <!-- Reduced padding -->
                              <input type="text" id="npc-gender" class="info-input" style="width: 130px; height: 23px;" />
                           </div>
                           <div class="flex items-center h-[23px]">
                              <label for="npc-unique" class="label-text w-28 text-right pr-2">Unique</label> <!-- Reduced padding -->
                              <div class="w-[130px] flex items-center">
                                 <input
                                    type="checkbox"
                                    id="npc-unique"
                                    class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                              </div>
                           </div>
                           <div class="flex items-center h-[23px]">
                              <label for="npc-proper" class="label-text w-28 text-right pr-2">Proper Name</label> <!-- Reduced padding -->
                              <div class="w-[130px] flex items-center">
                                 <input
                                    type="checkbox"
                                    id="npc-proper"
                                    class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>

               <!-- Card: Statistics -->
               <div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
                  <div class="card-header bg-white px-3 py-1 border-b border-black/20 cursor-pointer select-none">
                     <h2 class="font-bold text-slate-700 relative" style="top: 0px;">Statistics</h2> <!-- Nudged header text down -->
                  </div>
                  <div class="card-body open">
                     <div class="p-4 min-h-[20rem]"><!-- Placeholder space --></div>
                  </div>
               </div>
            </div>

            <!-- Right Column: The Viewport, this column is fixed and will not scroll -->
            <aside class="fixed right-6 top-40">
               <div
                  id="viewport"
                  class="w-[500px] h-[800px] bg-cover bg-center rounded-xl shadow-inner custom-shadow overflow-auto bordered-container"
                  style="
                      background-image: url(&quot;graphics/viewport.jpg&quot;);
                      background-repeat: repeat;
                      background-position: top left;
                      background-size: auto;
                  ">
                  <!-- The generated HTML will eventually be injected here -->
               </div>
            </aside>
         </main>
      </div>

      <script>
         document.addEventListener("DOMContentLoaded", () => {
            // --- DATA ---
            let NPC = {};
            let currentFileHandle = null;

            // --- UI ELEMENTS ---
            const cardHeaders = document.querySelectorAll(".card-header");
            const openFileBtn = document.getElementById("openFileBtn");
            const saveFileBtn = document.getElementById("saveFileBtn");
            const downloadBtn = document.getElementById("downloadBtn");
            const fileStatusEl = document.getElementById("file-status");

            // --- FORM INPUTS ---
            const inputs = {
               name: document.getElementById("npc-name"),
               size: document.getElementById("npc-size"),
               type: document.getElementById("npc-type"),
               subType: document.getElementById("npc-sub-type"),
               alignment: document.getElementById("npc-alignment"),
               armorClass: document.getElementById("npc-ac"),
               hitPoints: document.getElementById("npc-hp"),
               gender: document.getElementById("npc-gender"),
               isUnique: document.getElementById("npc-unique"),
               isProperName: document.getElementById("npc-proper")
            };

            // --- FUNCTIONS ---

            function initializeNPC() {
               NPC = {
                  name: "",
                  size: "",
                  type: "",
                  subType: "",
                  alignment: "",
                  armorClass: "",
                  hitPoints: "",
                  gender: "neutral",
                  isUnique: false,
                  isProperName: false
               };
               updateFormFromNPC();
            }

            // Updates the form fields with data from the global NPC object
            function updateFormFromNPC() {
               for (const key in inputs) {
                  const element = inputs[key];
                  if (element.type === "checkbox") {
                     element.checked = NPC[key] || false;
                  } else {
                     element.value = NPC[key] || "";
                  }
               }
            }

            // Updates the global NPC object with data from the form fields
            function updateNPCFromForm() {
               for (const key in inputs) {
                  const element = inputs[key];
                  if (element.type === "checkbox") {
                     NPC[key] = element.checked;
                  } else if (element.type === "number") {
                     NPC[key] = element.value === "" ? "" : Number(element.value);
                  } else {
                     NPC[key] = element.value;
                  }
               }
               // console.log(NPC); // For debugging
            }

            // --- FILE SYSTEM API LOGIC ---

            async function openFile() {
               try {
                  const [handle] = await window.showOpenFilePicker({
                     types: [{ description: "JSON Files", accept: { "application/json": [".json"] } }]
                  });
                  currentFileHandle = handle;
                  const file = await handle.getFile();
                  const content = await file.text();
                  NPC = JSON.parse(content);
                  updateFormFromNPC();
                  fileStatusEl.textContent = `Editing: ${file.name}`;
               } catch (err) {
                  if (err.name !== "AbortError") console.error("Error opening file:", err);
               }
            }

            async function saveFile() {
               updateNPCFromForm();
               const jsonString = JSON.stringify(NPC, null, 2);

               if (!currentFileHandle) {
                  // "Save As" if no file is open
                  try {
                     const handle = await window.showSaveFilePicker({
                        types: [{ description: "JSON Files", accept: { "application/json": [".json"] } }]
                     });
                     currentFileHandle = handle;
                  } catch (err) {
                     if (err.name !== "AbortError") console.error("Error saving file:", err);
                     return; // Exit if user cancels "Save As"
                  }
               }

               try {
                  const writable = await currentFileHandle.createWritable();
                  await writable.write(jsonString);
                  await writable.close();
                  fileStatusEl.textContent = `Saved: ${currentFileHandle.name}`;
               } catch (err) {
                  console.error("Error saving file:", err);
               }
            }

            function downloadCopy() {
               updateNPCFromForm();
               const jsonString = JSON.stringify(NPC, null, 2);
               const blob = new Blob([jsonString], { type: "application/json" });
               const url = URL.createObjectURL(blob);
               const a = document.createElement("a");
               a.href = url;
               a.download = `${NPC.name || "unnamed-npc"}.json`;
               document.body.appendChild(a);
               a.click();
               document.body.removeChild(a);
               URL.revokeObjectURL(url);
            }

            // --- EVENT LISTENERS ---

            // Card collapsers
            cardHeaders.forEach((header) => {
               header.addEventListener("click", () => {
                  const cardBody = header.nextElementSibling;
                  if (cardBody) cardBody.classList.toggle("open");
               });
            });

            // Form inputs -> update NPC object on any change
            Object.values(inputs).forEach((input) => {
               input.addEventListener("input", updateNPCFromForm);
            });

            // File buttons
            openFileBtn.addEventListener("click", openFile);
            saveFileBtn.addEventListener("click", saveFile);
            downloadBtn.addEventListener("click", downloadCopy);

            // Check for API support and disable buttons if needed
            const isApiSupported = "showOpenFilePicker" in window;
            const isBlocked = window.self !== window.top;
            if (!isApiSupported || isBlocked) {
               openFileBtn.disabled = true;
               saveFileBtn.disabled = true;
               const reason = isBlocked ? "in this frame" : "by your browser";
               fileStatusEl.textContent = `File System API disabled ${reason}.`;
               fileStatusEl.classList.add("text-yellow-400");
            }

            // --- INITIALIZATION ---
            initializeNPC();
         });
      </script>
   </body>
</html>







