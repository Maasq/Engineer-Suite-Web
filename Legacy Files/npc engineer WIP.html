<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="author" content="Maasq" />
		<meta name="description" content="A tool for creating and managing NPCs." />
		<meta name="version" content="0.03.09" />
		<meta name="date" content="2025-10-12" />
		
		<title>NPC Engineer</title>
		
		<!-- Tailwind CSS for styling -->
		<script src="https://cdn.tailwindcss.com"></script>
		<!-- Dexie.js for IndexedDB -->
		<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
		
		<!-- Trix Editor for WYSIWYG -->
		<link rel="stylesheet" type="text/css" href="https://unpkg.com/trix@2.0.0/dist/trix.css">
		<script type="text/javascript" src="https://unpkg.com/trix@2.0.0/dist/trix.umd.min.js"></script>
		
		<!-- Google Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<!-- Lexend used for application cards -->
		<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700&display=swap" rel="stylesheet" />
		<!-- Cormorant used for NPC name -->
		<link href="https://fonts.googleapis.com/css2?family=Cormorant+SC:wght@400;500;700&display=swap" rel="stylesheet" />
		<!-- Questrial used for HTML -->
		<link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet" />
		<!-- Lato used for Description maybe? -->
		<link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet" />
		<!-- Macondo Swash Caps used for drop caps -->
		<link href="https://fonts.googleapis.com/css2?family=Macondo+Swash+Caps&display=swap" rel="stylesheet" />
		
		<style>
			body { /* A simple style for our application font */
				font-family: "Lexend", sans-serif;
			}
			.card-body { /* Custom styles for the card collapse/expand transition */
				max-height: 0;
				overflow: hidden;
				transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
				padding-top: 0;
				padding-bottom: 0;
			}
			.card-body.open { /* A large max-height to allow content to expand fully */
				max-height: 70rem; /* Increased to accommodate new section */
			}
			.card-font-style { /* Sets font size for card content */
				font-size: 11pt;
			}
			.custom-shadow { /* Custom shadow style */
				box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.4);
			}
			.input-field {
				@apply w-full bg-gray-100 border border-gray-300 rounded-md px-3 py-1 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500;
			}
			.label-text {
				@apply block text-sm font-medium text-gray-700;
			}
			.bordered-container { /* A reusable class for black borders */
				border: 1px solid black;
			}
			.info-input, .info-select { /* Custom style for specific input boxes and dropdowns */
				background-color: #F8FAFC; /* Lighter input background */
				border: 1px solid #CBD5E1; /* Adjusted darker shade for the border */
				border-radius: 2px;
				padding-left: 0.5rem;
				padding-right: 0.5rem;
				font-size: 10pt; /* Set font size for input fields */
			}

			/* --- Trix Editor Styles --- */
			trix-toolbar .trix-button-group button {
				tabindex: -1; /* Remove Trix toolbar buttons from tab order */
			}
			.trix-content {
				min-height: 250px;
				background-color: #F8FAFC;
				border: 1px solid #CBD5E1;
				border-top: none; /* The toolbar has a bottom border already */
				border-radius: 0 0 2px 2px;
				padding: 0.5rem;
			}
			trix-toolbar {
				background-color: #F8FAFC;
			}

			/* --- Viewport Styles --- */
			div.container {
				margin: auto;
				width: 10.3cm;
				box-shadow: 8px 8px 20px #472737;
				background-image: url("graphics/statblock texture.jpg");
				background-color: #FDF1E6; /* Pale yellow fallback */
			}
			div.cap {
				margin: auto;
				height: 0.2cm;
				width: 10.3cm;
				background: #e0851d; /* App title green color */
				border-style: solid;
				border-right-width: 1px;
				border-left-width: 1px;
				border-top-width: 1px;
				border-bottom-width: 1px;
				border-right-color: #000000;
				border-left-color: #000000;
				border-top-color: #000000;
				border-bottom-color: #000000;
				background-image: url("graphics/statblock cap.jpg");
			}
			div.npcname {
				margin: auto;
				width: 10.3cm;
				background: rgba(0, 0, 0, 0.0);
				color: #7A200D;
				font-family: "Cormorant SC", serif;
				font-size: 21pt;
				border-left-style: solid;
				border-right-style: solid;
				border-top-style: none;
				border-bottom-style: none;
				border-right-width: 1px;
				border-left-width: 1px;
				border-right-color: #BA4E3B;
				border-left-color: #BA4E3B;
				padding: 0cm 0.15cm 0cm 0.15cm;
			}
			div.npctype {
				margin: auto;
				width: 10.3cm;
				background: rgba(0, 0, 0, 0.0);
				color: #000000;
				font-family: "Questrial", sans-serif;
				font-size: 9pt;
				border-left-style: solid;
				border-right-style: solid;
				border-top-style: none;
				border-bottom-style: none;
				border-right-width: 1px;
				border-left-width: 1px;
				border-right-color: #BA4E3B;
				border-left-color: #BA4E3B;
				padding: 0cm 0.15cm 0cm 0.15cm;
			}
			div.npctop {
				margin: auto;
				width: 10.3cm;
				background: rgba(0, 0, 0, 0.0);
				color: #7A200D;
				font-family: "Questrial", sans-serif;
				font-size: 10.5pt;
				border-left-style: solid;
				border-right-style: solid;
				border-top-style: none;
				border-bottom-style: none;
				border-right-width: 1px;
				border-left-width: 1px;
				border-right-color: #BA4E3B;
				border-left-color: #BA4E3B;
				padding: 0cm 0.15cm 0cm 0.15cm;
			}
			div.npcbottom {
				margin: auto;
				width: 10.3cm;
				background: rgba(0, 0, 0, 0.0);
				color: #000000;
				font-family: "Questrial", sans-serif;
				font-size: 10pt;
				border-left-style: solid;
				border-right-style: solid;
				border-top-style: none;
				border-bottom-style: none;
				border-right-width: 1px;
				border-left-width: 1px;
				border-right-color: #BA4E3B;
				border-left-color: #BA4E3B;
				padding: 0cm 0.15cm 0cm 0.15cm;
			}
			div.npcdescrip {
				margin: auto;
				background-color: transparent; /* Removes color */
				background-image: none;        /* Removes image */
  				background: rgba(255, 255, 255, 0.0);
				color: #000000;
				font-family: "Questrial", sans-serif;
				font-size: 12pt;
				padding: 0.4cm 0.1cm 0cm 0.1cm;
			}
			div.npcdescrip .trix-content { /* Override Trix's default padding for the viewport */
				padding: 0;
			}
			.heading {
				background: rgba(0, 0, 0, 0.0);
				color: #7A200D;
				font-size: 16pt;
				font-weight: bold;
			}
			.post-container {
				margin: 20px 20px 0 0;
				overflow: auto;
				padding: 0cm 0.15cm 0cm 0cm;
			}
			.post-thumb {
				float: left;
			}
			.post-thumb img {
				display: block;
			}
			.post-content {
				background: #FDF1E6;
				color: #000000;
				font-family: "Questrial", sans-serif;
				font-size: 10pt;
				border: 1px solid #7A200D;
				margin-left: 1cm;
				padding: 0.15cm 0.15cm 0cm 0.15cm;
				box-shadow: 4px 4px 8px #472737;
			}
			div.npcdiv {
				margin: auto;
				width: 10.3cm;
				background: rgba(0, 0, 0, 0.0);
				border-left-style: solid;
				border-right-style: solid;
				border-top-style: none;
				border-bottom-style: none;
				border-right-width: 1px;
				border-left-width: 1px;
				border-right-color: #BA4E3B;
				border-left-color: #BA4E3B;
				padding: 0cm 0.15cm 0cm 0.15cm;
			}
			.whoosh { /* This class is now used on an SVG polyline, styled via attributes */ }
			table.attr {
				background: rgba(0, 0, 0, 0.0);
				color: #7A200D;
				font-family: "Lato", sans-serif;
				font-size: 11pt;
				border-style: none;
				border-collapse: collapse;
				text-align: center;
				padding: 0cm 0cm 0cm 0cm;
			}
			div.npcdiv2 {
				margin: auto;
				width: 10.3cm;
				background: rgba(0, 0, 0, 0.0);
				border-left-style: solid;
				border-right-style: solid;
				border-top-style: none;
				border-bottom-style: none;
				border-right-width: 1px;
				border-left-width: 1px;
				border-right-color: #BA4E3B;
				border-left-color: #BA4E3B;
				padding: 0cm 0.15cm 0.2cm 0.15cm;
			}
			table.spell {
				background: #FDF1E6;
				color: #000000;
				font-family: "Lato", sans-serif;
				font-size: 11pt;
				border: 1px solid #7A200D;
				border-collapse: collapse;
				text-align: left;
				padding: 0.2cm 0.2cm 0.2cm 0.2cm;
				box-shadow: 3px 3px #DDDDDD;
			}
			table.spell th {
				background-color: #7A200D;
				color: #FFFFFF;
				padding: 0.1cm;
				border: 1px solid #7A200D;
				border-collapse: collapse;
			}
			table.spell td {
				padding: 0.1cm;
				border: 1px solid #7A200D;
				border-collapse: collapse;
			}

			/* --- Drag & Drop highlight --- */
			.drag-over {
				border: 2px dashed #87CC24 !important;
				background-color: #f0fff4 !important;
			}
			#npc-token, #npc-image {
				padding: 0;
			}
			.menu-item.disabled {
				opacity: 0.5;
				cursor: not-allowed;
			}
			.menu-item.disabled:hover {
				background-color: transparent;
			}
			.stat-header {
				color: #8B575C; /* Desaturated dark red */
			}
			.drop-cap::first-letter {
				font-family: 'Macondo Swash Caps', serif;
				font-size: 3em;
				float: left;
				line-height: 0.8;
				padding-top: 4px; /* Adjust vertical alignment */
				padding-right: 4px;
				color: #7A200D;
			}
		</style>
	</head>
	<body class="bg-[#E2E8F0]">
		<!-- Centering Container with a max-width. -->
		<div class="max-w-screen-2xl mx-auto px-6 pb-6">

			<!-- Sticky Header Area -->
			<header class="sticky top-0 z-50 bg-[#E2E8F0] pt-1 pb-12">
				<div class="relative h-24">
					
					<!-- Hamburger Menu -->
					<div class="absolute top-2 left-2 z-40">
						<button id="hamburger-btn" class="w-10 h-10 flex items-center justify-center rounded-full bg-transparent hover:bg-violet-200 transition-colors">
							<svg class="h-6 w-6 text-black" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
							</svg>
						</button>
						<div id="main-menu" class="absolute left-0 mt-2 w-56 bg-white rounded-md shadow-lg z-50 hidden">
							<!-- Bestiaries Sub-Menu -->
							<div class="relative group/bestiaries">
								<div class="flex justify-between items-center w-full px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 cursor-default">
									<span>Bestiaries</span>
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
								</div>
								<div class="absolute left-full top-0 w-56 bg-white rounded-md shadow-lg z-50 hidden group-hover/bestiaries:block">
									<a href="#" id="menu-new-bestiary" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">New Bestiary</a>
									<a href="#" id="menu-load-bestiary" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">Select Bestiary</a>
									<a href="#" id="menu-import-bestiary" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">Import Bestiary</a>
									<a href="#" id="menu-export-bestiary" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">Export Bestiary</a>
								</div>
							</div>
							<hr class="my-1"/>
							<!-- NPCs Sub-Menu -->
							<div class="relative group/npcs">
								<div class="flex justify-between items-center w-full px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 cursor-default">
									<span>NPCs</span>
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
								</div>
								<div class="absolute left-full top-0 w-56 bg-white rounded-md shadow-lg z-50 hidden group-hover/npcs:block">
									<a href="#" id="menu-new-npc" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">New NPC</a>
									<a href="#" id="menu-duplicate-npc" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">Duplicate NPC</a>
									<a href="#" id="menu-import-npc" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">Import NPC</a>
									<a href="#" id="menu-export-npc" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">Export NPC</a>
									<a href="#" id="menu-delete-npc" class="menu-item block px-4 py-1 text-sm text-red-600 hover:bg-red-50">Delete NPC</a>
								</div>
							</div>
							<hr class="my-1"/>
							<a href="#" id="menu-settings" class="menu-item block px-4 py-1 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
						</div>
					</div>

					<!-- Background circle for the graphic -->
					<div class="absolute w-32 h-32 bg-black rounded-full custom-shadow z-10" style="top: 16px; left: 28px"></div>
					<!-- Graphic Image -->
					<img src="graphics/npc engineer.webp" alt="NPC Engineer Logo" class="absolute w-32 h-32 rounded-full z-30" style="top: 16px; left: 28px" />
					
					
					<!-- Bestiary Management Buttons -->
					<div id="bestiary-buttons" class="absolute right-3 top-[15px] z-30 flex items-center space-x-4">
						<span id="bestiary-status" class="text-sm font-medium text-gray-600 mr-2">No Bestiary Loaded</span>
						<!-- New Bestiary Button -->
						<button id="newBestiaryBtn" title="Create a new Bestiary" class="transition duration-150 p-1.5 text-black rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-black">
							<svg class="h-6 w-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
								<path d="M11 19.913c-4.966-.084-8-1.388-8-2.334v-6.248C4.643 12.429 8.082 13 11.5 13s6.857-.57 8.5-1.67V14h1V5c0-1.97-4.78-3-9.5-3S2 3.03 2 5v12.58c0 2.116 4.448 3.255 9 3.333zM11.5 3C17 3 20 4.321 20 5s-3 2-8.5 2S3 5.679 3 5s3-2 8.5-2zM3 6.411C4.643 7.457 8.082 8 11.5 8s6.857-.543 8.5-1.589v3.437C20 10.726 16.689 12 11.5 12S3 10.726 3 9.848zM18 15l-1-1h-3l-1 1h-1v8h11v-8zm4 7h-9v-4h9zm-9-5v-1h.414l1-1h2.172l1 1H22v1z"/>
								<path fill="none" d="M0 0h24v24H0z"/>
							</svg>
						</button>
						<!-- Load Bestiary Button -->
						<button id="loadBestiaryBtn" title="Select one of your Bestiaries to edit" class="transition duration-150 p-1.5 text-black rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-black">
							<svg class="h-6 w-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
								<path d="M4 4H3v1h2V2h1v20H5v-1H4v2h18V1H4zm3-2h14v20H7zM5 20H3v-1h1v-1h1zm0-6H3v-1h1v-1h1zm0-6H3V7h1V6h1zm0 3H3v-1h1V9h1zm0 6H3v-1h1v-1h1zm10.5-5h-3A3.504 3.504 0 0 0 9 15.5V18h10v-2.5a3.504 3.504 0 0 0-3.5-3.5zm2.5 5h-8v-1.5a2.503 2.503 0 0 1 2.5-2.5h3a2.503 2.503 0 0 1 2.5 2.5zm-4-6a3 3 0 1 0-3-3 3.003 3.003 0 0 0 3 3zm0-5a2 2 0 1 1-2 2 2.002 2.002 0 0 1 2-2z"/>
								<path fill="none" d="M0 0h24v24H0z"/>
							</svg>
						</button>
						<!-- Import Bestiary Button -->
						<button id="importBestiaryBtn" title="Import Bestiary (JSON) from Disk" class="transition duration-150 p-1.5 text-black rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-black">
							<svg class="h-6 w-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
								<path d="M24 12a5 5 0 0 1-5 5h-2v-1h2a3.99 3.99 0 0 0 .623-7.934l-.79-.124-.052-.798a5.293 5.293 0 0 0-10.214-1.57L8.17 6.59l-.977-.483A2.277 2.277 0 0 0 6.19 5.87a2.18 2.18 0 0 0-1.167.339 2.205 2.205 0 0 0-.98 1.395l-.113.505-.476.2A4 4 0 0 0 5 16h3v1H5a5 5 0 0 1-1.934-9.611 3.21 3.21 0 0 1 1.422-2.025 3.17 3.17 0 0 1 1.702-.493 3.268 3.268 0 0 1 1.446.34 6.293 6.293 0 0 1 12.143 1.867A4.988 4.988 0 0 1 24 12zm-11-.293l2.646 2.646.707-.707L12.5 9.793l-3.854 3.853.707.707L12 11.707V22h1z"/>
								<path fill="none" d="M0 0h24v24H0z"/>
							</svg>
						</button>
						<!-- Export Bestiary Button -->
						<button id="exportBestiaryBtn" title="Export Bestiary (JSON) to Disk" class="transition duration-150 p-1.5 text-black rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-black">
							<svg class="h-6 w-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
								<path d="M24 12a5 5 0 0 1-5 5h-2v-1h2a3.99 3.99 0 0 0 .623-7.934l-.79-.124-.052-.798a5.293 5.293 0 0 0-10.214-1.57L8.17 6.59l-.977-.483A2.277 2.277 0 0 0 6.19 5.87a2.18 2.18 0 0 0-1.167.339 2.206 2.206 0 0 0-.98 1.395l-.113.505-.476.2A4 4 0 0 0 5 16h3v1H5a5 5 0 0 1-1.934-9.611 3.21 3.21 0 0 1 1.422-2.025 3.17 3.17 0 0 1 1.702-.493 3.268 3.268 0 0 1 1.446.34 6.293 6.293 0 0 1 12.143 1.867A4.988 4.988 0 0 1 24 12zm-11-1h-1v10.292l-2.646-2.646-.707.707 3.854 3.854 3.853-3.852-.707-.707L13 21.294z"/>
								<path fill="none" d="M0 0h24v24H0z"/>
							</svg>
						</button>
					</div>
					
					<!-- Persistent Header Bar -->
					<div class="absolute bottom-0 left-0 right-0 h-[50px] bg-gradient-to-b from-black via-gray-500 to-black border border-black rounded-xl custom-shadow z-20 flex items-center justify-between px-4">
						<h1 class="text-3xl font-bold text-[#87CC24] ml-48">NPC Engineer</h1>
						<div id="npc-buttons" class="flex items-center space-x-4">
							<button id="newNpcBtn" title="New NPC" class="transition duration-150 p-1.5 text-white rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
								<svg fill="currentColor" stroke="currentColor" stroke-width="0.5" class="h-5 w-5" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 502 502" xml:space="preserve"><g><g><path d="M405.889,348.576V105.273c0-2.652-1.054-5.196-2.929-7.071L307.688,2.929C305.812,1.054,303.269,0,300.617,0H70.783 c-5.523,0-10,4.477-10,10v445.916c0,5.523,4.477,10,10,10h216.442C303.083,488.611,328.615,502,356.57,502 c46.674,0,84.646-37.972,84.646-84.646C441.217,389.827,428.102,364.485,405.889,348.576z M80.783,20h215.691l76.158,76.158 h-51.151c-5.522,0-10,4.477-10,10s4.478,10,10,10h64.408v221.789c-9.334-3.451-19.247-5.241-29.319-5.241 c-46.675,0-84.647,37.973-84.647,84.647c0,9.793,1.692,19.45,4.955,28.562H80.783V20z M356.57,482 c-22.766,0-43.43-11.629-55.277-31.107c-6.13-10.077-9.37-21.675-9.37-33.539c0-35.646,29.001-64.647,64.647-64.647 c11.785,0,23.28,3.21,33.334,9.278c0.474,0.355,0.979,0.67,1.513,0.938c18.668,11.975,29.799,32.278,29.799,54.431 C421.217,453,392.217,482,356.57,482z"/><path d="M394.345,407.354h-27.776v-27.776c0-5.523-4.478-10-10-10s-10,4.477-10,10v27.776h-27.776c-5.522,0-10,4.477-10,10 s4.478,10,10,10h27.776v27.776c0,5.523,4.478,10,10,10s10-4.477,10-10v-27.776h27.776c5.522,0,10-4.477,10-10 S399.868,407.354,394.345,407.354z"/><path d="M292.56,106.158c0-5.523-4.478-10-10-10h-11.447c-5.522,0-10,4.477-10,10s4.478,10,10,10h11.447 C288.083,116.158,292.56,111.681,292.56,106.158z"/></g></g></svg>
							</button>
							<button id="duplicateNpcBtn" title="Duplicate this NPC." class="transition duration-150 p-1.5 text-white rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white disabled:opacity-25 disabled:cursor-not-allowed">
								<svg class="h-5 w-5" fill="currentColor" viewBox="0 0 64 64" data-name="Material Expand" id="Material_Expand" xmlns="http://www.w3.org/2000/svg"><path d="M60,18H44V4a2,2,0,0,0-2-2H8A2,2,0,0,0,6,4V34H4a2,2,0,0,0-2,2v4a6.006,6.006,0,0,0,6,6H24v4H22a2,2,0,0,0-2,2v4a6.006,6.006,0,0,0,6,6H56a6.006,6.006,0,0,0,6-6V20A2,2,0,0,0,60,18ZM10,6H40V40a2,2,0,0,1-4,0V36a2,2,0,0,0-2-2H10ZM6,40V38H32v2a5.972,5.972,0,0,0,.343,2H8A2,2,0,0,1,6,40ZM26,58a2,2,0,0,1-2-2V54H50v2a5.972,5.972,0,0,0,.343,2Zm32-2a2,2,0,0,1-4,0V52a2,2,0,0,0-2-2H28V46H38a6.006,6.006,0,0,0,6-6V22H58Z"/><rect height="4" width="4" x="14" y="10"/><rect height="4" width="14" x="22" y="10"/><rect height="4" width="22" x="14" y="18"/><rect height="4" width="22" x="14" y="26"/><rect height="4" width="6" x="48" y="26"/><rect height="4" width="6" x="48" y="34"/><rect height="4" width="6" x="48" y="42"/></svg>
							</button>
							<button id="importNpcBtn" title="Import NPC" class="transition duration-150 p-1.5 text-white rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white disabled:opacity-25 disabled:cursor-not-allowed">
								<svg class="h-5 w-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="currentColor" stroke-width="1"><path d="M21 5h-8.8L11 3H4L2.8 5H1v16h20l2.902-12H21zM2 6h1.366l1.2-2h5.868l1.2 2H20v3h-5.6l-2 2H4.35L2 18.015zm20.632 4l-2.42 10H2.39l2.68-8h7.744l2-2z"/></svg>
							</button>
							<button id="exportNpcBtn" title="Export NPC" class="transition duration-150 p-1.5 text-white rounded-lg hover:opacity-75 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white disabled:opacity-25 disabled:cursor-not-allowed">
								<svg class="h-5 w-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="currentColor" stroke-width="1"><path d="M16.765 2c1.187 0 1.363.06 1.51.168L21.662 4.7a.845.845 0 0 1 .339.677v15.78a.844.844 0 0 1-.844.844H2.844A.844.844 0 0 1 2 21.156V2.844A.844.844 0 0 1 2.844 2zM17 21v-7H7v7zM14 3v3h1V3zM7 3v6h10V3h-1v4h-3V3zM3 21h3v-8h12v8h3V5.452l-3-2.278v6.17a.769.769 0 0 1-.844.656H6.844A.769.769 0 0 1 6 9.344V3H3z"/></svg>
							</button>
						</div>
					</div>
					<!-- NPC Selector -->
					<div id="npc-selector-container" class="absolute left-0 right-0 pr-6" style="top: 100px; display: flex; justify-content: flex-end; align-items: center;">
						<select id="npc-selector" class="info-select hidden" style="width: 450px; font-size: 11pt;" title="Select an NPC to edit"></select>
						<button id="deleteNpcBtn" title="Delete Current NPC" class="ml-2 p-1.5 text-red-600 rounded-lg hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 hidden">
							<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>
							</svg>
						</button>
					</div>
				</div>
			</header>

			<!-- Main Content Area: flex-wrap will stack columns on smaller screens -->
			<main class="flex flex-wrap justify-center gap-6 pt-6">

				<!-- Left Column -->
				<div id="main-content-column" class="w-[900px] flex-shrink-0 space-y-6">

					<!-- Card: NPC Information -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-[#F1FBEA] px-3 py-1 border-b border-black/20 flex justify-between items-center">
							<h2 class="font-bold text-slate-700 cursor-pointer select-none" id="npc-info-header-title">NPC Information</h2>
							<div class="flex items-center space-x-2">
								<label for="fantasy-grounds-group" class="label-text text-xs">FG Group:</label>
								<select id="fantasy-grounds-group" class="info-select h-6 text-xs" style="width: 150px;"></select>
								<button id="manage-groups-btn" title="Manage Groups">
									<svg class="h-5 w-5 text-gray-600 hover:text-black" fill="currentColor" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 447.479 447.479" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 447.479 447.479">
										<g>
											<path d="M411.426,75.746H36.053C16.173,75.746,0,91.92,0,111.799V335.68c0,19.879,16.173,36.052,36.053,36.052h375.374   c19.879,0,36.053-16.173,36.053-36.052V111.799C447.479,91.92,431.306,75.746,411.426,75.746z M427.479,335.68   c0,8.851-7.201,16.052-16.053,16.052H36.053c-8.852,0-16.053-7.201-16.053-16.052V111.799c0-8.852,7.201-16.053,16.053-16.053   h375.374c8.852,0,16.053,7.201,16.053,16.053V335.68z"/>
											<path d="m82.747,127.494c-17.506,0-31.749,14.243-31.749,31.749 0,14.011 9.127,25.923 21.745,30.125v120.615c0,5.523 4.477,10 10,10s10-4.477 10-10v-120.613c12.622-4.199 21.753-16.113 21.753-30.127-1.42109e-14-17.506-14.243-31.749-31.749-31.749zm0,43.498c-6.479,0-11.749-5.271-11.749-11.749s5.271-11.749 11.749-11.749 11.749,5.271 11.749,11.749-5.271,11.749-11.749,11.749z"/>
											<path d="m186.743,172.115v-34.623c0-5.523-4.477-10-10-10s-10,4.477-10,10v34.622c-12.62,4.2-21.75,16.113-21.75,30.126s9.129,25.927 21.75,30.126v77.616c0,5.523 4.477,10 10,10s10-4.477 10-10v-77.616c12.62-4.201 21.748-16.114 21.748-30.126s-9.129-25.925-21.748-30.125zm-10.001,41.875c-6.478,0-11.749-5.271-11.749-11.749 0-6.478 5.271-11.749 11.749-11.749 6.479,0 11.749,5.271 11.749,11.749 2.84217e-14,6.478-5.271,11.749-11.749,11.749z"/>
											<path d="m280.733,215.111v-77.618c0-5.523-4.477-10-10-10s-10,4.477-10,10v77.621c-12.618,4.202-21.745,16.114-21.745,30.125s9.127,25.923 21.745,30.125v34.619c0,5.523 4.477,10 10,10s10-4.477 10-10v-34.616c12.622-4.199 21.753-16.114 21.753-30.128s-9.131-25.929-21.753-30.128zm-9.996,41.877c-6.479,0-11.749-5.271-11.749-11.749s5.271-11.749 11.749-11.749c6.478,0 11.749,5.271 11.749,11.749s-5.271,11.749-11.749,11.749z"/>
											<path d="m374.733,258.111v-120.619c0-5.523-4.477-10-10-10s-10,4.477-10,10v120.618c-12.62,4.2-21.75,16.114-21.75,30.126 0,17.506 14.243,31.749 31.749,31.749s31.749-14.242 31.749-31.749c-5.68434e-14-14.012-9.128-25.925-21.748-30.125zm-10.001,41.874c-6.479,0-11.749-5.271-11.749-11.749 0-6.479 5.271-11.749 11.749-11.749s11.749,5.271 11.749,11.749c-5.68434e-14,6.479-5.27,11.749-11.749,11.749z"/>
										</g>
									</svg>
								</button>
							</div>
						</div>
						<div class="card-body">
							<div class="px-4 pt-2 pb-2">
								<div class="flex space-x-4">
									<!-- Main Info Column -->
									<div class="flex-shrink-0">
										<div class="space-y-1">
											<!-- Name -->
											<div class="flex items-center mb-2">
												<label for="npc-name" class="label-text w-28 text-right pr-2">Name</label>
												<input type="text" id="npc-name" class="info-input" style="width: 250px; height: 23px; background-color: #fef2f2; border-color: #b91c1c;" tabindex="1" title="Enter the NPC's name." />
											</div>
											<!-- Size and Gender -->
											<div class="flex items-center">
												<label for="npc-size" class="label-text w-28 text-right pr-2">Size</label>
												<div class="relative" style="width: 200px; height: 23px;">
													<select id="npc-size" class="info-select absolute top-0 left-0 w-full h-full" tabindex="2" title="Select from the standard size categories or enter your own by clicking the checkbox.">
														<option value="" disabled selected hidden></option>
														<option>Tiny</option>
														<option>Small</option>
														<option>Medium</option>
														<option>Large</option>
														<option>Huge</option>
														<option>Gargantuan</option>
													</select>
													<input type="text" id="npc-size-custom" class="info-input absolute top-0 left-0 w-full h-full hidden" tabindex="2" title="Select from the standard size categories or enter your own by clicking the checkbox." />
												</div>
												<input type="checkbox" id="toggle-custom-size" title="enter a custom size" class="ml-2 mr-4 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" tabindex="-1">
												<label for="npc-gender" class="label-text w-28 text-right pr-2">Gender</label>
												<select id="npc-gender" class="info-select" style="width: 130px; height: 23px;" tabindex="8" title="Select the NPC's gender.
This will insert gender-specific pronouns in the descriptive text.">
													<option value="creature">creature</option>
													<option value="neutral">neutral</option>
													<option value="male">male</option>
													<option value="female">female</option>
												</select>
											</div>
											<!-- Type and Unique -->
											<div class="flex items-center">
												<label for="npc-type" class="label-text w-28 text-right pr-2">Type</label>
												<div class="relative" style="width: 200px; height: 23px;">
													<select id="npc-type" class="info-select absolute top-0 left-0 w-full h-full" tabindex="3" title="Select from the standard creature types or enter your own by clicking the checkbox.">
														<option value="" disabled selected hidden></option>
														<option>aberration</option>
														<option>beast</option>
														<option>celestial</option>
														<option>construct</option>
														<option>dragon</option>
														<option>elemental</option>
														<option>fey</option>
														<option>fiend</option>
														<option>giant</option>
														<option>humanoid</option>
														<option>monstrosity</option>
														<option>ooze</option>
														<option>plant</option>
														<option>undead</option>
														<option disabled>──────────</option>
														<option>swarm of tiny aberrations</option>
														<option>swarm of tiny beasts</option>
														<option>swarm of tiny constructs</option>
														<option>swarm of tiny elementals</option>
														<option>swarm of tiny monstrosities</option>
														<option>swarm of tiny oozes</option>
														<option>swarm of tiny plants</option>
														<option disabled>──────────</option>
														<option>trap</option>
													</select>
													<input type="text" id="npc-type-custom" class="info-input absolute top-0 left-0 w-full h-full hidden" tabindex="3" title="Select from the standard creature types or enter your own by clicking the checkbox." />
												</div>
												<input type="checkbox" id="toggle-custom-type" title="enter a custom type" class="ml-2 mr-4 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" tabindex="-1">
												<label for="npc-unique" class="label-text w-28 text-right pr-2">Unique</label>
												<div class="w-[130px] flex items-center">
													<input type="checkbox" id="npc-unique" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" tabindex="9" title="Check if the NPC is unique for any reason.
This will capitalise its name in the descriptive text.">
												</div>
											</div>
											<!-- Species and Proper Name -->
											<div class="flex items-center">
												<label for="npc-species" class="label-text w-28 text-right pr-2">Species</label>
												<div class="relative" style="width: 200px; height: 23px;">
													<select id="npc-species" class="info-select absolute top-0 left-0 w-full h-full" tabindex="4" title="Select a specific species or enter your own by clicking the checkbox.
Example: a species of humanoid may be half-elf.
You can leave this box blank if desired.">
														<option value="" disabled selected hidden></option>
														<option>aarakocra</option>
														<option>any species</option>
														<option>bullywug</option>
														<option>demon</option>
														<option>derro</option>
														<option>devil</option>
														<option>dragonborn</option>
														<option>dwarf</option>
														<option>elf</option>
														<option>firenewt</option>
														<option>genasi</option>
														<option>gith</option>
														<option>gnoll</option>
														<option>gnome</option>
														<option>goblinoid</option>
														<option>grimlock</option>
														<option>grung</option>
														<option>half-elf</option>
														<option>half-orc</option>
														<option>halfling</option>
														<option>human</option>
														<option>kenku</option>
														<option>kobold</option>
														<option>kuo-toa</option>
														<option>lizardfolk</option>
														<option>merfolk</option>
														<option>orc</option>
														<option>quaggoth</option>
														<option>ratfolk</option>
														<option>sahuagin</option>
														<option>shapechanger</option>
														<option>thri-kreen</option>
														<option>tiefling</option>
														<option>titan</option>
														<option>troglodyte</option>
														<option>xvart</option>
														<option>yuan-ti</option>
														<option>yugoloth</option>
													</select>
													<input type="text" id="npc-species-custom" class="info-input absolute top-0 left-0 w-full h-full hidden" tabindex="4" title="Select a specific species or enter your own by clicking the checkbox.
Example: a species of humanoid may be half-elf.
You can leave this box blank if desired.">
												</div>
												<input type="checkbox" id="toggle-custom-species" title="enter a custom species" class="ml-2 mr-4 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" tabindex="-1">
												<label for="npc-proper" class="label-text w-28 text-right pr-2">Proper Name</label>
												<div class="w-[130px] flex items-center">
													<input type="checkbox" id="npc-proper" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" tabindex="10" title="Check if the name entered is a proper name.
This will use just the first word of the name in the descriptive text.
('Maasq Hammerheart' will be referred to as 'Maasq' throughout; 'Ironbane, Destroyer of Worlds' as 'Ironbane') ">
												</div>
											</div>
											<!-- Flex container for the Alignment/AC/HP column and Token column -->
											<div class="flex items-start">
												<!-- Left Column: Alignment, AC, HP -->
												<div class="space-y-1">
													<!-- Alignment -->
													<div class="flex items-center">
														<label for="npc-alignment" class="label-text w-28 text-right pr-2">Alignment</label>
														<div class="relative" style="width: 200px; height: 23px;">
															<select id="npc-alignment" class="info-select absolute top-0 left-0 w-full h-full" tabindex="5" title="Select from the standard alignments or enter your own by clicking the checkbox.">
																<option value="" disabled selected hidden></option>
																<option>unaligned</option>
																<option disabled>──────────</option>
																<option>lawful good</option>
																<option>lawful neutral</option>
																<option>lawful evil</option>
																<option disabled>──────────</option>
																<option>neutral good</option>
																<option>true neutral</option>
																<option>neutral evil</option>
																<option disabled>──────────</option>
																<option>chaotic good</option>
																<option>chaotic neutral</option>
																<option>chaotic evil</option>
															</select>
															<input type="text" id="npc-alignment-custom" class="info-input absolute top-0 left-0 w-full h-full hidden" tabindex="5" title="Select from the standard alignments or enter your own by clicking the checkbox.">
														</div>
														<input type="checkbox" id="toggle-custom-alignment" title="enter a custom alignment" class="ml-2 mr-4 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" tabindex="-1">
													</div>
													<!-- Armor Class -->
													<div class="flex items-center">
														<label for="npc-ac" class="label-text w-28 text-right pr-2">Armor Class</label>
														<input type="text" id="npc-ac" class="info-input" style="width: 200px; height: 23px;" tabindex="6" title="Enter the NPC's armor class. You can also enter the type of armor in brackets.
Example: 12 (leather armor)">
													</div>
													<!-- Hit Points -->
													<div class="flex items-center">
														<label for="npc-hp" class="label-text w-28 text-right pr-2">Hit Points</label>
														<input type="text" id="npc-hp" class="info-input" style="width: 200px; height: 23px;" tabindex="7" title="Enter the NPC's hit points, followed by its hit dice in brackets.
Example: 16 (3d6 + 6)
Double-click to open a window that will help build a correct expression.">
													</div>
													<!-- Challenge -->
													<div class="flex items-center" style="padding-top: 3px;">
														<label for="npc-challenge" class="label-text w-28 text-right pr-2">Challenge</label>
														<select id="npc-challenge" class="info-select" style="width: 70px; height: 23px;" tabindex="8"></select>
													</div>
													<!-- XP and Proficiency Bonus -->
													<div class="flex items-center" style="margin-top: -1px;">
														<label class="label-text w-28 text-right pr-2">XP</label>
														<span id="npc-experience-display" class="font-medium text-gray-800" style="width: 80px;"></span>
														<label class="label-text pr-2 ml-2">Proficiency Bonus</label>
														<span id="npc-proficiency-bonus-display" class="font-medium text-gray-800"></span>
													</div>
												</div>

												<!-- Right Column: Token -->
												<div class="flex">
													<label class="label-text w-28 text-right pr-2">Token</label>
													<div class="w-[130px]">
														<div id="npc-token" class="w-[130px] h-[130px] info-input cursor-pointer flex items-center justify-center text-gray-400 text-xs text-center overflow-hidden">
															<span>Click or Drag a Token Image Here</span>
														</div>
														<input type="file" id="token-upload" class="hidden" accept="image/png, image/webp">
													</div>
												</div>
											</div>
										</div>
									</div>

									<!-- Image Column -->
									<div class="flex-grow">
										<div id="npc-image" class="w-[256px] h-[242px] info-input cursor-pointer flex items-center justify-center text-gray-400 text-xs text-center overflow-hidden">
											<span>Click or Drag an NPC Image Here</span>
										</div>
										<input type="file" id="image-upload" class="hidden" accept="image/png, image/webp, image/jpeg">
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Card: Statistics -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-[#F1FBEA] px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">Statistics</h2>
						</div>
						<div class="card-body">
							<div class="p-4">
								<div class="flex justify-around">
									<!-- Ability Scores Section -->
									<div class="ml-12">
										<h3 class="font-bold text-center ml-9 mb-1 text-gray-800">Ability Scores</h3>
										<div class="flex space-x-2">
											<!-- Ability Column -->
											<div class="flex flex-col items-end space-y-1">
												<label class="label-text font-semibold h-6 mb-1 stat-header">Ability</label>
												<label for="npc-strength" class="label-text h-6 flex items-center">Strength</label>
												<label for="npc-dexterity" class="label-text h-6 flex items-center">Dexterity</label>
												<label for="npc-constitution" class="label-text h-6 flex items-center">Constitution</label>
												<label for="npc-intelligence" class="label-text h-6 flex items-center">Intelligence</label>
												<label for="npc-wisdom" class="label-text h-6 flex items-center">Wisdom</label>
												<label for="npc-charisma" class="label-text h-6 flex items-center">Charisma</label>
											</div>
											<!-- Score Column -->
											<div class="flex flex-col items-center space-y-1">
												<label class="label-text font-semibold h-6 mb-1 stat-header">Score</label>
												<input type="number" id="npc-strength" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="1" max="30">
												<input type="number" id="npc-dexterity" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="1" max="30">
												<input type="number" id="npc-constitution" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="1" max="30">
												<input type="number" id="npc-intelligence" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="1" max="30">
												<input type="number" id="npc-wisdom" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="1" max="30">
												<input type="number" id="npc-charisma" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="1" max="30">
											</div>
											<!-- Bonus Column -->
											<div class="flex flex-col items-center space-y-1">
												<label class="label-text font-semibold h-6 mb-1 stat-header">Bonus</label>
												<span id="npc-strength-bonus" class="font-medium text-gray-800 h-6 flex items-center"></span>
												<span id="npc-dexterity-bonus" class="font-medium text-gray-800 h-6 flex items-center"></span>
												<span id="npc-constitution-bonus" class="font-medium text-gray-800 h-6 flex items-center"></span>
												<span id="npc-intelligence-bonus" class="font-medium text-gray-800 h-6 flex items-center"></span>
												<span id="npc-wisdom-bonus" class="font-medium text-gray-800 h-6 flex items-center"></span>
												<span id="npc-charisma-bonus" class="font-medium text-gray-800 h-6 flex items-center"></span>
											</div>
										</div>
									</div>
									
									<!-- Saving Throws Section -->
									<div class="mr-12">
										<h3 class="font-bold text-center mb-1 text-gray-800">Saving Throws</h3>
										<div class="flex space-x-2">
											<div class="flex flex-col items-center space-y-1">
												<label class="label-text font-semibold h-6 mb-1 text-center stat-header" style="width: 60px;">Prof</label>
												<div class="h-6 flex items-center justify-center w-full"><input type="checkbox" id="npc-strength-saving-throw-prof" title="Add proficiency in strength saving throws?" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
												<div class="h-6 flex items-center justify-center w-full"><input type="checkbox" id="npc-dexterity-saving-throw-prof" title="Add proficiency in dexterity saving throws?" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
												<div class="h-6 flex items-center justify-center w-full"><input type="checkbox" id="npc-constitution-saving-throw-prof" title="Add proficiency in constitution saving throws?" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
												<div class="h-6 flex items-center justify-center w-full"><input type="checkbox" id="npc-intelligence-saving-throw-prof" title="Add proficiency in intelligence saving throws?" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
												<div class="h-6 flex items-center justify-center w-full"><input type="checkbox" id="npc-wisdom-saving-throw-prof" title="Add proficiency in wisdom saving throws?" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
												<div class="h-6 flex items-center justify-center w-full"><input type="checkbox" id="npc-charisma-saving-throw-prof" title="Add proficiency in charisma saving throws?" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											</div>
											<div class="flex flex-col items-center space-y-1">
												<label class="label-text font-semibold h-6 mb-1 text-center stat-header" style="width: 50px;">Adjust</label>
												<input type="number" id="npc-strength-saving-throw-adjust" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="-9" max="9">
												<input type="number" id="npc-dexterity-saving-throw-adjust" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="-9" max="9">
												<input type="number" id="npc-constitution-saving-throw-adjust" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="-9" max="9">
												<input type="number" id="npc-intelligence-saving-throw-adjust" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="-9" max="9">
												<input type="number" id="npc-wisdom-saving-throw-adjust" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="-9" max="9">
												<input type="number" id="npc-charisma-saving-throw-adjust" class="info-input h-6" style="width: 41px; padding-right: 2px;" min="-9" max="9">
											</div>
											<div class="flex flex-col items-center space-y-1">
												<label class="label-text font-semibold h-6 mb-1 text-center stat-header" style="width: 50px;">Total</label>
												<span id="npc-strength-saving-throw-total" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
												<span id="npc-dexterity-saving-throw-total" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
												<span id="npc-constitution-saving-throw-total" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
												<span id="npc-intelligence-saving-throw-total" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
												<span id="npc-wisdom-saving-throw-total" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
												<span id="npc-charisma-saving-throw-total" class="font-medium text-gray-800 h-6 flex items-center justify-center w-full"></span>
											</div>
										</div>
									</div>

								</div>
							</div>
						</div>
					</div>
					
					<!-- Card: Movement Speed and Sense Ranges -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-[#F1FBEA] px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">Movement Speed and Sense Ranges</h2>
						</div>
						<div class="card-body">
							<div class="p-4">
								<div class="flex justify-around">
									<!-- Speeds Section -->
									<div>
										<h3 class="font-bold text-center mb-1 text-gray-800">Speeds (ft.)</h3>
										<div class="flex items-center space-x-2 mb-1">
											<label for="npc-speed-base" class="label-text w-24 text-right whitespace-nowrap">Base Speed</label>
											<input type="number" id="npc-speed-base" class="info-input h-6 w-20 text-center" min="0" max="200" step="5">
										</div>
										<div class="flex items-center space-x-2 mb-1">
											<label for="npc-speed-burrow" class="label-text w-24 text-right">Burrow</label>
											<input type="number" id="npc-speed-burrow" class="info-input h-6 w-20 text-center" min="0" max="200" step="5">
										</div>
										<div class="flex items-center space-x-2 mb-1">
											<label for="npc-speed-climb" class="label-text w-24 text-right">Climb</label>
											<input type="number" id="npc-speed-climb" class="info-input h-6 w-20 text-center" min="0" max="200" step="5">
										</div>
										<div class="flex items-center space-x-2 mb-1">
											<label for="npc-speed-fly" class="label-text w-24 text-right">Fly</label>
											<input type="number" id="npc-speed-fly" class="info-input h-6 w-20 text-center" min="0" max="200" step="5">
											<div class="w-28 flex items-center ml-4">
												<input type="checkbox" id="npc-fly-hover" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
												<label for="npc-fly-hover" class="label-text ml-2">Hover</label>
											</div>
										</div>
										<div class="flex items-center space-x-2 mb-1">
											<label for="npc-speed-swim" class="label-text w-24 text-right">Swim</label>
											<input type="number" id="npc-speed-swim" class="info-input h-6 w-20 text-center" min="0" max="200" step="5">
										</div>
									</div>
									<!-- Senses Section -->
									<div>
										<h3 class="font-bold text-center mb-1 text-gray-800">Senses (ft.)</h3>
										<div class="flex items-center space-x-2 mb-1">
											<label for="npc-sense-blindsight" class="label-text w-36 text-right">Blindsight</label>
											<input type="number" id="npc-sense-blindsight" class="info-input h-6 w-20 text-center" min="0" max="600" step="10">
											<div class="w-32 flex items-center ml-4">
												<input type="checkbox" id="npc-blind-beyond" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
												<label for="npc-blind-beyond" class="label-text ml-2">Blind Beyond</label>
											</div>
										</div>
										<div class="flex items-center space-x-2 mb-1">
											<label for="npc-sense-darkvision" class="label-text w-36 text-right">Darkvision</label>
											<input type="number" id="npc-sense-darkvision" class="info-input h-6 w-20 text-center" min="0" max="600" step="10">
										</div>
										<div class="flex items-center space-x-2 mb-1">
											<label for="npc-sense-tremorsense" class="label-text w-36 text-right">Tremorsense</label>
											<input type="number" id="npc-sense-tremorsense" class="info-input h-6 w-20 text-center" min="0" max="600" step="10">
										</div>
										<div class="flex items-center space-x-2 mb-1">
											<label for="npc-sense-truesight" class="label-text w-36 text-right">Truesight</label>
											<input type="number" id="npc-sense-truesight" class="info-input h-6 w-20 text-center" min="0" max="600" step="10">
										</div>
										<div class="flex items-center space-x-2 mt-2">
											<label class="label-text w-36 text-right font-semibold whitespace-nowrap">Passive Perception</label>
											<span id="npc-passive-perception" class="font-medium text-gray-800 h-6 flex items-center justify-center w-20"></span>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Card: Resistances -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-[#F1FBEA] px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">Resistances</h2>
						</div>
						<div class="card-body">
							<div class="p-4">
								<!-- Vulnerabilities Section -->
								<div class="relative mt-2">
									<h3 class="font-bold text-gray-800 absolute -top-2.5 left-4 bg-white px-1">Vulnerability</h3>
									<div class="border border-gray-400 rounded-lg p-3 pt-4">
										<div class="flex justify-between items-start">
											<div class="flex flex-col items-center text-center px-1"><label for="vuln-acid" class="label-text text-[8pt] leading-tight">Acid</label><input type="checkbox" id="vuln-acid" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="vuln-cold" class="label-text text-[8pt] leading-tight">Cold</label><input type="checkbox" id="vuln-cold" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="vuln-fire" class="label-text text-[8pt] leading-tight">Fire</label><input type="checkbox" id="vuln-fire" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="vuln-force" class="label-text text-[8pt] leading-tight">Force</label><input type="checkbox" id="vuln-force" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="vuln-lightning" class="label-text text-[8pt] leading-tight">Lightning</label><input type="checkbox" id="vuln-lightning" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="vuln-necrotic" class="label-text text-[8pt] leading-tight">Necrotic</label><input type="checkbox" id="vuln-necrotic" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="vuln-poison" class="label-text text-[8pt] leading-tight">Poison</label><input type="checkbox" id="vuln-poison" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="vuln-psychic" class="label-text text-[8pt] leading-tight">Psychic</label><input type="checkbox" id="vuln-psychic" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="vuln-radiant" class="label-text text-[8pt] leading-tight">Radiant</label><input type="checkbox" id="vuln-radiant" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="vuln-thunder" class="label-text text-[8pt] leading-tight">Thunder</label><input type="checkbox" id="vuln-thunder" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="vuln-bludgeoning" class="label-text text-[8pt] leading-tight">Bludgeoning</label><input type="checkbox" id="vuln-bludgeoning" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="vuln-piercing" class="label-text text-[8pt] leading-tight">Piercing</label><input type="checkbox" id="vuln-piercing" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="vuln-slashing" class="label-text text-[8pt] leading-tight">Slashing</label><input type="checkbox" id="vuln-slashing" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
										</div>
									</div>
								</div>

								<!-- Resistance Section -->
								<div class="relative mt-6">
									<h3 class="font-bold text-gray-800 absolute -top-2.5 left-4 bg-white px-1">Resistance</h3>
									<div class="border border-gray-400 rounded-lg p-3 pt-4">
										<div class="flex justify-between items-start">
											<div class="flex flex-col items-center text-center px-1"><label for="res-acid" class="label-text text-[8pt] leading-tight">Acid</label><input type="checkbox" id="res-acid" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="res-cold" class="label-text text-[8pt] leading-tight">Cold</label><input type="checkbox" id="res-cold" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="res-fire" class="label-text text-[8pt] leading-tight">Fire</label><input type="checkbox" id="res-fire" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="res-force" class="label-text text-[8pt] leading-tight">Force</label><input type="checkbox" id="res-force" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="res-lightning" class="label-text text-[8pt] leading-tight">Lightning</label><input type="checkbox" id="res-lightning" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="res-necrotic" class="label-text text-[8pt] leading-tight">Necrotic</label><input type="checkbox" id="res-necrotic" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="res-poison" class="label-text text-[8pt] leading-tight">Poison</label><input type="checkbox" id="res-poison" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="res-psychic" class="label-text text-[8pt] leading-tight">Psychic</label><input type="checkbox" id="res-psychic" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="res-radiant" class="label-text text-[8pt] leading-tight">Radiant</label><input type="checkbox" id="res-radiant" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="res-thunder" class="label-text text-[8pt] leading-tight">Thunder</label><input type="checkbox" id="res-thunder" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="res-bludgeoning" class="label-text text-[8pt] leading-tight">Bludgeoning</label><input type="checkbox" id="res-bludgeoning" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="res-piercing" class="label-text text-[8pt] leading-tight">Piercing</label><input type="checkbox" id="res-piercing" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="res-slashing" class="label-text text-[8pt] leading-tight">Slashing</label><input type="checkbox" id="res-slashing" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
										</div>
										<div class="mt-4 pt-2 border-t border-gray-300">
											<div class="flex flex-col space-y-1 text-sm">
												<div class="flex items-center">
													<input type="radio" id="wr-none" name="weapon-resistance" value="none" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
													<label for="wr-none" class="ml-2 label-text">No special weapon resistances.</label>
												</div>
												<div class="flex items-center">
													<input type="radio" id="wr-nonmagical" name="weapon-resistance" value="nonmagical" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
													<label for="wr-nonmagical" class="ml-2 label-text">Resistant to nonmagical weapons.</label>
												</div>
												<div class="flex items-center">
													<input type="radio" id="wr-silvered" name="weapon-resistance" value="silvered" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
													<label for="wr-silvered" class="ml-2 label-text">Resistant to nonmagical weapons that aren't silvered.</label>
												</div>
												<div class="flex items-center">
													<input type="radio" id="wr-adamantine" name="weapon-resistance" value="adamantine" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
													<label for="wr-adamantine" class="ml-2 label-text">Resistant to nonmagical weapons that aren't adamantine.</label>
												</div>
												<div class="flex items-center">
													<input type="radio" id="wr-cold-forged" name="weapon-resistance" value="cold-forged" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
													<label for="wr-cold-forged" class="ml-2 label-text">Resistant to nonmagical weapons that aren't cold-forged iron.</label>
												</div>
												<div class="flex items-center">
													<input type="radio" id="wr-magical" name="weapon-resistance" value="magical" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
													<label for="wr-magical" class="ml-2 label-text">Resistant to magical weapons.</label>
												</div>
											</div>
										</div>
									</div>
								</div>

								<!-- Immunity Section -->
								<div class="relative mt-6">
									<h3 class="font-bold text-gray-800 absolute -top-2.5 left-4 bg-white px-1">Immunity</h3>
									<div class="border border-gray-400 rounded-lg p-3 pt-4">
										<div class="flex justify-between items-start">
											<div class="flex flex-col items-center text-center px-1"><label for="imm-acid" class="label-text text-[8pt] leading-tight">Acid</label><input type="checkbox" id="imm-acid" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="imm-cold" class="label-text text-[8pt] leading-tight">Cold</label><input type="checkbox" id="imm-cold" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="imm-fire" class="label-text text-[8pt] leading-tight">Fire</label><input type="checkbox" id="imm-fire" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="imm-force" class="label-text text-[8pt] leading-tight">Force</label><input type="checkbox" id="imm-force" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="imm-lightning" class="label-text text-[8pt] leading-tight">Lightning</label><input type="checkbox" id="imm-lightning" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="imm-necrotic" class="label-text text-[8pt] leading-tight">Necrotic</label><input type="checkbox" id="imm-necrotic" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="imm-poison" class="label-text text-[8pt] leading-tight">Poison</label><input type="checkbox" id="imm-poison" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="imm-psychic" class="label-text text-[8pt] leading-tight">Psychic</label><input type="checkbox" id="imm-psychic" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="imm-radiant" class="label-text text-[8pt] leading-tight">Radiant</label><input type="checkbox" id="imm-radiant" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="imm-thunder" class="label-text text-[8pt] leading-tight">Thunder</label><input type="checkbox" id="imm-thunder" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="imm-bludgeoning" class="label-text text-[8pt] leading-tight">Bludgeoning</label><input type="checkbox" id="imm-bludgeoning" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="imm-piercing" class="label-text text-[8pt] leading-tight">Piercing</label><input type="checkbox" id="imm-piercing" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
											<div class="flex flex-col items-center text-center px-1"><label for="imm-slashing" class="label-text text-[8pt] leading-tight">Slashing</label><input type="checkbox" id="imm-slashing" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></div>
										</div>
										<div class="mt-4 pt-2 border-t border-gray-300">
											<div class="flex flex-col space-y-1 text-sm">
												<div class="flex items-center">
													<input type="radio" id="wi-none" name="weapon-immunity" value="none" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
													<label for="wi-none" class="ml-2 label-text">No special weapon immunities.</label>
												</div>
												<div class="flex items-center">
													<input type="radio" id="wi-nonmagical" name="weapon-immunity" value="nonmagical" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
													<label for="wi-nonmagical" class="ml-2 label-text">Immune to nonmagical weapons.</label>
												</div>
												<div class="flex items-center">
													<input type="radio" id="wi-silvered" name="weapon-immunity" value="silvered" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
													<label for="wi-silvered" class="ml-2 label-text">Immune to nonmagical weapons that aren't silvered.</label>
												</div>
												<div class="flex items-center">
													<input type="radio" id="wi-adamantine" name="weapon-immunity" value="adamantine" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
													<label for="wi-adamantine" class="ml-2 label-text">Immune to nonmagical weapons that aren't adamantine.</label>
												</div>
												<div class="flex items-center">
													<input type="radio" id="wi-cold-forged" name="weapon-immunity" value="cold-forged" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
													<label for="wi-cold-forged" class="ml-2 label-text">Immune to nonmagical weapons that aren't cold-forged iron.</label>
												</div>
											</div>
										</div>
									</div>
								</div>
								
								<!-- Condition Immunity Section -->
								<div class="relative mt-6">
									<h3 class="font-bold text-gray-800 absolute -top-2.5 left-4 bg-white px-1">Condition Immunity</h3>
									<div class="border border-gray-400 rounded-lg p-4 pt-5">
										<div class="grid grid-cols-3 gap-x-8 gap-y-1 text-sm">
											<div class="flex items-center"><input type="checkbox" id="ci-blinded" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-blinded" class="ml-2 label-text">blinded</label></div>
											<div class="flex items-center"><input type="checkbox" id="ci-charmed" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-charmed" class="ml-2 label-text">charmed</label></div>
											<div class="flex items-center"><input type="checkbox" id="ci-deafened" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-deafened" class="ml-2 label-text">deafened</label></div>
											<div class="flex items-center"><input type="checkbox" id="ci-exhaustion" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-exhaustion" class="ml-2 label-text">exhaustion</label></div>
											<div class="flex items-center"><input type="checkbox" id="ci-frightened" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-frightened" class="ml-2 label-text">frightened</label></div>
											<div class="flex items-center"><input type="checkbox" id="ci-grappled" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-grappled" class="ml-2 label-text">grappled</label></div>
											<div class="flex items-center"><input type="checkbox" id="ci-incapacitated" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-incapacitated" class="ml-2 label-text">incapacitated</label></div>
											<div class="flex items-center"><input type="checkbox" id="ci-invisible" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-invisible" class="ml-2 label-text">invisible</label></div>
											<div class="flex items-center"><input type="checkbox" id="ci-paralyzed" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-paralyzed" class="ml-2 label-text">paralyzed</label></div>
											<div class="flex items-center"><input type="checkbox" id="ci-petrified" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-petrified" class="ml-2 label-text">petrified</label></div>
											<div class="flex items-center"><input type="checkbox" id="ci-poisoned" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-poisoned" class="ml-2 label-text">poisoned</label></div>
											<div class="flex items-center"><input type="checkbox" id="ci-prone" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-prone" class="ml-2 label-text">prone</label></div>
											<div class="flex items-center"><input type="checkbox" id="ci-restrained" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-restrained" class="ml-2 label-text">restrained</label></div>
											<div class="flex items-center"><input type="checkbox" id="ci-stunned" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-stunned" class="ml-2 label-text">stunned</label></div>
											<div class="flex items-center"><input type="checkbox" id="ci-unconscious" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="ci-unconscious" class="ml-2 label-text">unconscious</label></div>
										</div>
									</div>
								</div>

							</div>
						</div>
					</div>

					<!-- Card: Skills -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-[#F1FBEA] px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">Skills</h2>
						</div>
						<div class="card-body">
							<div class="p-4 min-h-[10rem]"><!-- Placeholder space --></div>
						</div>
					</div>

					<!-- Card: Languages -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-[#F1FBEA] px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">Languages</h2>
						</div>
						<div class="card-body">
							<div class="p-4 min-h-[10rem]"><!-- Placeholder space --></div>
						</div>
					</div>

					<!-- Card: Traits -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-[#F1FBEA] px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">Traits</h2>
						</div>
						<div class="card-body">
							<div class="p-4 min-h-[10rem]"><!-- Placeholder space --></div>
						</div>
					</div>

					<!-- Card: Actions -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-[#F1FBEA] px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">Actions</h2>
						</div>
						<div class="card-body">
							<div class="p-4 min-h-[10rem]"><!-- Placeholder space --></div>
						</div>
					</div>

					<!-- Card: Description -->
					<div class="bg-white rounded-xl custom-shadow overflow-hidden bordered-container card-font-style">
						<div class="card-header bg-[#F1FBEA] px-3 py-1 border-b border-black/20 cursor-pointer select-none">
							<h2 class="font-bold text-slate-700 relative" style="top: 0px;">Description</h2>
						</div>
						<div class="card-body">
							<div class="p-2">
								<input id="npc-description" type="hidden" name="content">
								<trix-editor input="npc-description" class="trix-content"></trix-editor>
							</div>
						</div>
					</div>
				</div>

				<!-- Right Column: Sticky on large screens -->
				<aside class="w-[500px] flex-shrink-0 lg:sticky top-36">
					<div id="viewport" class="w-[500px] h-[800px] bg-cover bg-center rounded-xl custom-shadow overflow-auto bordered-container" style=" padding-top: 10px; background-image: url(&quot;graphics/viewport.jpg&quot;); background-repeat: repeat; background-position: top left; background-size: auto; overflow-y: scroll;">
						<!-- The generated HTML will eventually be injected here -->
					</div>
					<div id="npc-options-container" class="hidden w-full mt-2 ml-5">
						<div class="flex flex-col space-y-1">
							<div class="flex items-center">
								<input type="checkbox" id="npc-add-description" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
								<label for="npc-add-description" class="ml-2 label-text text-xs">Add description to the NPC</label>
							</div>
							<div class="flex items-center">
								<input type="checkbox" id="npc-add-title" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
								<label for="npc-add-title" class="ml-2 label-text text-xs">Add a title</label>
							</div>
							<div class="flex items-center">
								<input type="checkbox" id="npc-add-image-link" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
								<label for="npc-add-image-link" class="ml-2 label-text text-xs">Add an image link</label>
							</div>
							<div class="flex items-center">
								<input type="checkbox" id="npc-use-drop-cap" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
								<label for="npc-use-drop-cap" class="ml-2 label-text text-xs">Use a drop cap in the description</label>
							</div>
						</div>
					</div>
				</aside>
			</main>
		</div>

		<!-- Modals -->
		<div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
			
			<!-- New Bestiary Modal -->
			<div id="new-bestiary-modal" class="bg-white rounded-xl custom-shadow bordered-container card-font-style p-4 space-y-3 w-80 hidden">
				<div class="flex justify-between items-center mb-2">
					<h3 class="font-bold text-slate-700">Create New Bestiary</h3>
					<button class="modal-close-btn text-gray-500 hover:text-black text-2xl leading-none">&times;</button>
				</div>
				<div class="space-y-2">
					<div>
						<label for="new-bestiary-name" class="label-text">Bestiary Name</label>
						<input type="text" id="new-bestiary-name" class="info-input w-full">
					</div>
				</div>
				<div class="text-right pt-2">
					<button id="create-bestiary-btn" class="bg-[#87CC24] text-black px-4 py-1 rounded-md text-sm hover:opacity-80 font-semibold">Create</button>
				</div>
			</div>

			<!-- Load Bestiary Modal -->
			<div id="load-bestiary-modal" class="bg-white rounded-xl custom-shadow bordered-container card-font-style p-4 space-y-3 w-96 hidden">
				<div class="flex justify-between items-center mb-2">
					<h3 class="font-bold text-slate-700">Load Bestiary</h3>
					<button class="modal-close-btn text-gray-500 hover:text-black text-2xl leading-none">&times;</button>
				</div>
				<div id="bestiary-list" class="space-y-2 max-h-80 overflow-y-auto">
					<!-- Bestiary items will be injected here -->
				</div>
			</div>
			
			<!-- Manage Groups Modal -->
			<div id="manage-groups-modal" class="bg-white rounded-xl custom-shadow bordered-container card-font-style p-4 space-y-3 w-96 hidden">
				<div class="flex justify-between items-center mb-2">
					<h3 class="font-bold text-slate-700">Manage Groups</h3>
					<button class="modal-close-btn text-gray-500 hover:text-black text-2xl leading-none">&times;</button>
				</div>
				<div class="flex space-x-2">
					<input type="text" id="new-group-name" class="info-input w-full" placeholder="New group name...">
					<button id="add-group-btn" class="bg-[#87CC24] text-black px-4 py-1 rounded-md text-sm hover:opacity-80 font-semibold">Add</button>
				</div>
				<div id="group-list" class="space-y-1 max-h-60 overflow-y-auto border-t pt-2 mt-2">
					<!-- Group items will be injected here -->
				</div>
			</div>

			<!-- Settings Modal -->
			<div id="settings-modal" class="bg-white rounded-xl custom-shadow bordered-container card-font-style p-4 space-y-3 w-96 hidden">
				<div class="flex justify-between items-center mb-2">
					<h3 class="font-bold text-slate-700">Bestiary Default Settings</h3>
					<button class="modal-close-btn text-gray-500 hover:text-black text-2xl leading-none">&times;</button>
				</div>
				<div class="space-y-2 border-t pt-2 mt-2">
					<p class="text-xs text-gray-500">These settings are applied to all new NPCs created in this bestiary.</p>
					<div class="flex items-center">
						<input type="checkbox" id="bestiary-add-description" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
						<label for="bestiary-add-description" class="ml-2 label-text">Add description to the NPC</label>
					</div>
					<div class="flex items-center">
						<input type="checkbox" id="bestiary-add-title" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
						<label for="bestiary-add-title" class="ml-2 label-text">Add a title</label>
					</div>
					<div class="flex items-center">
						<input type="checkbox" id="bestiary-add-image-link" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
						<label for="bestiary-add-image-link" class="ml-2 label-text">Add an image link</label>
					</div>
					<div class="flex items-center">
						<input type="checkbox" id="bestiary-use-drop-cap" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
						<label for="bestiary-use-drop-cap" class="ml-2 label-text">Use a drop cap in the description</label>
					</div>
				</div>
				<div class="text-right pt-2">
					<button id="settings-ok-btn" class="bg-[#87CC24] text-black px-4 py-1 rounded-md text-sm hover:opacity-80 font-semibold">OK</button>
				</div>
			</div>


			<!-- Hit Dice Calculator Modal -->
			<div id="hp-modal" class="bg-white rounded-xl custom-shadow bordered-container card-font-style p-4 space-y-3 w-64 hidden">
				<div class="flex justify-between items-center mb-2">
					<h3 class="font-bold text-slate-700">Hit Dice Calculator</h3>
					<button id="hp-modal-close" class="text-gray-500 hover:text-black text-2xl leading-none">&times;</button>
				</div>
				<div class="space-y-2">
					<div>
						<label for="hp-num-dice" class="label-text">Number of Dice</label>
						<input type="number" id="hp-num-dice" class="info-input w-full" value="1" min="1">
					</div>
					<div>
						<label for="hp-die-type" class="label-text">Die Type</label>
						<select id="hp-die-type" class="info-select w-full">
							<option value="4">d4</option>
							<option value="6">d6</option>
							<option value="8" selected>d8</option>
							<option value="10">d10</option>
							<option value="12">d12</option>
							<option value="20">d20</option>
						</select>
					</div>
					<div>
						<label for="hp-bonus" class="label-text">Bonus</label>
						<input type="number" id="hp-bonus" class="info-input w-full" value="0">
					</div>
				</div>
				<div class="text-right pt-2">
					<button id="hp-apply-btn" class="bg-[#87CC24] text-black px-4 py-1 rounded-md text-sm hover:opacity-80 font-semibold">Apply</button>
				</div>
			</div>

		</div>

		<script>
			document.addEventListener("DOMContentLoaded", () => {
				
				// --- DATABASE SETUP ---
				const db = new Dexie('npcEngineerDB');
				db.version(1).stores({
					projects: '++id, projectName' // NOTE: This is kept as 'projects' for backward compatibility.
				});

				// --- DATA & STATE ---
				const damageTypes = [
					'acid', 'cold', 'fire', 'force', 'lightning', 'necrotic', 'poison',
					'psychic', 'radiant', 'thunder', 'bludgeoning', 'piercing', 'slashing'
				];
				const conditions = [
					'blinded', 'charmed', 'deafened', 'exhaustion', 'frightened', 'grappled', 
					'incapacitated', 'invisible', 'paralyzed', 'petrified', 'poisoned', 
					'prone', 'restrained', 'stunned', 'unconscious'
				];
				
				let activeBestiary = null;
				let activeNPC = null;
				let activeNPCIndex = -1;
				let isUpdatingForm = false;
				
				const baseDefaultNPC = {
					name: "", size: "", type: "", species: "", alignment: "",
					armorClass: "", hitPoints: "", challenge: "0", experience: "10", proficiencyBonus: 2,
					strength: 10, strengthBonus: 0, dexterity: 10, dexterityBonus: 0, constitution: 10, constitutionBonus: 0,
					intelligence: 10, intelligenceBonus: 0, wisdom: 10, wisdomBonus: 0, charisma: 10, charismaBonus: 0,
					strengthSavingThrowProf: false, strengthSavingThrowAdjust: 0,
					dexteritySavingThrowProf: false, dexteritySavingThrowAdjust: 0,
					constitutionSavingThrowProf: false, constitutionSavingThrowAdjust: 0,
					intelligenceSavingThrowProf: false, intelligenceSavingThrowAdjust: 0,
					wisdomSavingThrowProf: false, wisdomSavingThrowAdjust: 0,
					charismaSavingThrowProf: false, charismaSavingThrowAdjust: 0,
					gender: "creature", isUnique: false, isProperName: false, description: "", token: "", image: "",
					saves: "",
					speed: "",
					addDescription: true, addTitle: true, addImageLink: true, useDropCap: true,
					speedBase: 30, speedFly: 0, flyHover: false, speedClimb: 0, speedSwim: 0, speedBurrow: 0,
					senseBlindsight: 0, blindBeyond: false, senseDarkvision: 0, senseTremorsense: 0, senseTruesight: 0,
					passivePerception: 10, fg_group: "",
					weaponResistance: 'none',
					weaponImmunity: 'none'
				};
				
				// Dynamically create the full defaultNPC object with resistance properties
				const defaultNPC = { ...baseDefaultNPC };
				damageTypes.forEach(type => {
					defaultNPC[`vulnerability_${type}`] = false;
					defaultNPC[`resistance_${type}`] = false;
					defaultNPC[`immunity_${type}`] = false;
				});
				conditions.forEach(condition => {
					defaultNPC[`ci_${condition}`] = false;
				});


				const crToXpMap = {
					'0': '10', '1/8': '25', '1/4': '50', '1/2': '100', '1': '200', '2': '450', '3': '700',
					'4': '1,100', '5': '1,800', '6': '2,300', '7': '2,900', '8': '3,900', '9': '5,000', '10': '5,900',
					'11': '7,200', '12': '8,400', '13': '10,000', '14': '11,500', '15': '13,000', '16': '15,000',
					'17': '18,000', '18': '20,000', '19': '22,000', '20': '25,000', '21': '33,000', '22': '41,000',
					'23': '50,000', '24': '62,000', '25': '75,000', '26': '90,000', '27': '105,000', '28': '120,000',
					'29': '135,000', '30': '155,000'
				};

				const challengeOrder = ['0','1/8','1/4','1/2','1','2','3','4','5','6','7','8','9','10',
													'11','12','13','14','15','16','17','18','19','20','21','22','23',
													'24','25','26','27','28','29','30'];
				
				const pronounSets = {
					male: ['he', 'his', 'him', 'his'],
					female: ['she', 'her', 'her', 'hers'],
					neutral: ['they', 'their', 'them', 'theirs'],
					creature: ['it', 'its', 'it', 'theirs']
				};

				// --- UI ELEMENTS ---
				const mainContentColumn = document.getElementById('main-content-column');
				const viewport = document.getElementById("viewport");
				const bestiaryStatusEl = document.getElementById("bestiary-status");
				
				// Bestiary Buttons
				const newBestiaryBtn = document.getElementById("newBestiaryBtn");
				const loadBestiaryBtn = document.getElementById("loadBestiaryBtn");
				const exportBestiaryBtn = document.getElementById("exportBestiaryBtn");
				const importBestiaryBtn = document.getElementById("importBestiaryBtn");

				// NPC Buttons
				const newNpcBtn = document.getElementById("newNpcBtn");
				const duplicateNpcBtn = document.getElementById("duplicateNpcBtn");
				const importNpcBtn = document.getElementById("importNpcBtn");
				const exportNpcBtn = document.getElementById("exportNpcBtn");
				const deleteNpcBtn = document.getElementById("deleteNpcBtn");
				
				// Menu Items
				const hamburgerBtn = document.getElementById('hamburger-btn');
				const mainMenu = document.getElementById('main-menu');
				const menuNewBestiary = document.getElementById('menu-new-bestiary');
				const menuLoadBestiary = document.getElementById('menu-load-bestiary');
				const menuImportBestiary = document.getElementById('menu-import-bestiary');
				const menuExportBestiary = document.getElementById('menu-export-bestiary');
				const menuNewNpc = document.getElementById('menu-new-npc');
				const menuDuplicateNpc = document.getElementById('menu-duplicate-npc');
				const menuImportNpc = document.getElementById('menu-import-npc');
				const menuExportNpc = document.getElementById('menu-export-npc');
				const menuDeleteNpc = document.getElementById('menu-delete-npc');
				const menuSettings = document.getElementById('menu-settings');


				// NPC Selector
				const npcSelector = document.getElementById("npc-selector");
				const npcOptionsContainer = document.getElementById('npc-options-container');

				// Modals & Overlays
				const modalOverlay = document.getElementById("modal-overlay");
				const newBestiaryModal = document.getElementById("new-bestiary-modal");
				const loadBestiaryModal = document.getElementById("load-bestiary-modal");
				const hpModal = document.getElementById("hp-modal");
				const settingsModal = document.getElementById('settings-modal');
				
				// Modal-specific elements
				const createBestiaryBtn = document.getElementById("create-bestiary-btn");
				const newBestiaryNameInput = document.getElementById("new-bestiary-name");
				const bestiaryListDiv = document.getElementById("bestiary-list");
				const manageGroupsBtn = document.getElementById('manage-groups-btn');
				const manageGroupsModal = document.getElementById('manage-groups-modal');
				const addGroupBtn = document.getElementById('add-group-btn');
				const newGroupNameInput = document.getElementById('new-group-name');
				const groupListDiv = document.getElementById('group-list');
				const settingsOkBtn = document.getElementById('settings-ok-btn');

				const tokenBox = document.getElementById("npc-token");
				const tokenUpload = document.getElementById("token-upload");
				const imageBox = document.getElementById("npc-image");
				const imageUpload = document.getElementById("image-upload");

				const hpModalCloseBtn = document.getElementById("hp-modal-close");
				const hpApplyBtn = document.getElementById("hp-apply-btn");
				const numDiceInput = document.getElementById("hp-num-dice");
				const dieTypeSelect = document.getElementById("hp-die-type");
				const bonusInput = document.getElementById("hp-bonus");
				const experienceDisplay = document.getElementById("npc-experience-display");
				const proficiencyBonusDisplay = document.getElementById("npc-proficiency-bonus-display");

				// Settings Checkboxes
				const bestiarySettingsCheckboxes = {
					addDescription: document.getElementById('bestiary-add-description'),
					addTitle: document.getElementById('bestiary-add-title'),
					addImageLink: document.getElementById('bestiary-add-image-link'),
					useDropCap: document.getElementById('bestiary-use-drop-cap'),
				};
				const npcSettingsCheckboxes = {
					addDescription: document.getElementById('npc-add-description'),
					addTitle: document.getElementById('npc-add-title'),
					addImageLink: document.getElementById('npc-add-image-link'),
					useDropCap: document.getElementById('npc-use-drop-cap'),
				};

				// --- FORM INPUTS ---
				const inputs = {
					name: document.getElementById("npc-name"),
					size: document.getElementById("npc-size"),
					type: document.getElementById("npc-type"),
					species: document.getElementById("npc-species"),
					alignment: document.getElementById("npc-alignment"),
					armorClass: document.getElementById("npc-ac"),
					hitPoints: document.getElementById("npc-hp"),
					challenge: document.getElementById("npc-challenge"),
					strength: document.getElementById("npc-strength"),
					dexterity: document.getElementById("npc-dexterity"),
					constitution: document.getElementById("npc-constitution"),
					intelligence: document.getElementById("npc-intelligence"),
					wisdom: document.getElementById("npc-wisdom"),
					charisma: document.getElementById("npc-charisma"),
					gender: document.getElementById("npc-gender"),
					isUnique: document.getElementById("npc-unique"),
					isProperName: document.getElementById("npc-proper"),
					description: document.getElementById("npc-description"), // hidden input for Trix
					speedBase: document.getElementById('npc-speed-base'),
					speedFly: document.getElementById('npc-speed-fly'),
					flyHover: document.getElementById('npc-fly-hover'),
					speedClimb: document.getElementById('npc-speed-climb'),
					speedSwim: document.getElementById('npc-speed-swim'),
					speedBurrow: document.getElementById('npc-speed-burrow'),
					senseBlindsight: document.getElementById('npc-sense-blindsight'),
					blindBeyond: document.getElementById('npc-blind-beyond'),
					senseDarkvision: document.getElementById('npc-sense-darkvision'),
					senseTremorsense: document.getElementById('npc-sense-tremorsense'),
					senseTruesight: document.getElementById('npc-sense-truesight'),
					fg_group: document.getElementById('fantasy-grounds-group')
				};

				// --- FUNCTIONS ---
				
				function findUniqueNpcName(baseName) {
					if (!activeBestiary) return baseName;
					let newName = baseName;
					let counter = 1;
					while (activeBestiary.npcs.some(npc => npc.name.toLowerCase() === newName.toLowerCase())) {
						counter++;
						newName = `${baseName} ${counter}`;
					}
					return newName;
				}

				// --- Bestiary Management ---
				function showNewBestiaryModal() {
					modalOverlay.classList.remove('hidden');
					newBestiaryModal.classList.remove('hidden');
					newBestiaryNameInput.focus();
				}

				async function createNewBestiary() {
					const bestiaryName = newBestiaryNameInput.value.trim();
					if (!bestiaryName) {
						alert("Bestiary name cannot be empty.");
						return;
					}
					const existingBestiary = await db.projects.where('projectName').equalsIgnoreCase(bestiaryName).first();
					if (existingBestiary) {
						alert(`A bestiary named "${bestiaryName}" already exists. Please choose a unique name.`);
						return;
					}
					
					const newBestiary = {
						projectName: bestiaryName, // This remains projectName for DB compatibility
						metadata: { 
							createdAt: new Date(),
							addDescription: true,
							addTitle: true,
							addImageLink: true,
							useDropCap: true,
							fg_groups: []
						},
						npcs: [{ ...defaultNPC, name: "New NPC", fg_group: bestiaryName }]
					};

					try {
						const newId = await db.projects.add(newBestiary);
						newBestiary.id = newId;
						loadBestiary(newBestiary);
						hideAllModals();
						newBestiaryNameInput.value = "";
					} catch (error) {
						console.error("Failed to create bestiary:", error);
						alert("Error: Could not create bestiary. Check console for details.");
					}
				}

				function loadBestiary(bestiary) {
					// Backward compatibility for booleans
					const propsToConvert = ['addDescription', 'addTitle', 'addImageLink', 'useDropCap'];
					
					propsToConvert.forEach(prop => {
						if (typeof bestiary.metadata[prop] === 'number') {
							bestiary.metadata[prop] = bestiary.metadata[prop] === 1;
						} else if (bestiary.metadata[prop] === undefined) {
							bestiary.metadata[prop] = true;
						}
					});

					// Data Healing: Assign names to any unnamed NPCs from older versions
					let unnamedCounter = 1;
					bestiary.npcs.forEach(npc => {
						propsToConvert.forEach(prop => {
							if (typeof npc[prop] === 'number') {
								npc[prop] = npc[prop] === 1;
							} else if (npc[prop] === undefined) {
								npc[prop] = bestiary.metadata[prop];
							}
						});
						
						if (!npc.name || npc.name.trim() === "") {
							let uniqueName = `Unnamed NPC`;
							if (unnamedCounter > 1) uniqueName += ` ${unnamedCounter}`;
							while (bestiary.npcs.some(n => n.name === uniqueName)) {
								unnamedCounter++;
								uniqueName = `Unnamed NPC ${unnamedCounter}`;
							}
							npc.name = uniqueName;
						}
					});

					activeBestiary = bestiary;
					sortAndSwitchToNpc(null);
					updateUIForActiveBestiary();
				}
				
				function switchActiveNPC(index) {
					if (activeBestiary && index >= 0 && index < activeBestiary.npcs.length) {
						activeNPCIndex = index;
						activeNPC = activeBestiary.npcs[index];
						updateFormFromActiveNPC();
					} else if (activeBestiary && activeBestiary.npcs.length > 0) {
						// Fallback to the first NPC if index is out of bounds
						activeNPCIndex = 0;
						activeNPC = activeBestiary.npcs[0];
						updateFormFromActiveNPC();
					}
				}

				async function saveActiveBestiaryToDB() {
					if (activeBestiary && activeBestiary.id) {
						try {
							await db.projects.put(activeBestiary);
						} catch (error) {
							console.error("Failed to save bestiary to DB:", error);
						}
					}
				}
				
				function sortAndSwitchToNpc(targetNpc) {
					if (!activeBestiary) return;

					// Sort the array alphabetically by name, case-insensitive.
					activeBestiary.npcs.sort((a, b) => {
						return (a.name || "").localeCompare(b.name || "", undefined, { sensitivity: 'base' });
					});

					// Find the index of the target NPC in the newly sorted array.
					const newIndex = targetNpc ? activeBestiary.npcs.findIndex(npc => npc === targetNpc) : 0;
					
					// Switch to that index (or the first one if no target).
					switchActiveNPC(newIndex >= 0 ? newIndex : 0);
				}


				async function exportBestiary() {
					if (!activeBestiary) return;
					
					const bestiaryJson = JSON.stringify(activeBestiary, null, 2);
					try {
						const handle = await window.showSaveFilePicker({
							suggestedName: `Bestiary-${activeBestiary.projectName}.json`,
							types: [{ description: "JSON Files", accept: { "application/json": [".json"] } }]
						});
						const writable = await handle.createWritable();
						await writable.write(bestiaryJson);
						await writable.close();
					} catch (err) {
						if (err.name !== "AbortError") console.error("Error exporting bestiary:", err);
					}
				}

				async function importBestiary() {
					try {
						const [handle] = await window.showOpenFilePicker({
							types: [{ description: "JSON Files", accept: { "application/json": [".json"] } }]
						});
						const file = await handle.getFile();
						const content = await file.text();
						const importedBestiary = JSON.parse(content);
						
						// Remove existing ID to ensure a new one is created on import
						delete importedBestiary.id; 

						// Check for existing bestiary with the same name
						const existing = await db.projects.where('projectName').equalsIgnoreCase(importedBestiary.projectName).first();
						if (existing) {
							alert(`A bestiary named "${importedBestiary.projectName}" already exists.`);
							return;
						}

						const newId = await db.projects.add(importedBestiary);
						importedBestiary.id = newId;
						loadBestiary(importedBestiary);
						alert(`Bestiary "${importedBestiary.projectName}" imported successfully!`);
					} catch (err) {
						if (err.name !== "AbortError") {
							console.error("Error importing bestiary:", err);
							alert("Failed to import bestiary.");
						}
					}
				}
				
				// --- NPC Management ---
				function createNewNpc() {
					if (!activeBestiary) return;
					const newNpc = { 
						...defaultNPC,
						name: findUniqueNpcName("New NPC"),
						useDropCap: activeBestiary.metadata.useDropCap,
						addDescription: activeBestiary.metadata.addDescription,
						addTitle: activeBestiary.metadata.addTitle,
						addImageLink: activeBestiary.metadata.addImageLink,
						fg_group: activeBestiary.projectName // Set default group
					};
					activeBestiary.npcs.push(newNpc);
					sortAndSwitchToNpc(newNpc);
					saveActiveBestiaryToDB();
					inputs.name.focus();
				}

				function duplicateCurrentNpc() {
					if (!activeBestiary || !activeNPC) return;

					// Create a deep copy
					const newNpc = JSON.parse(JSON.stringify(activeNPC));
					newNpc.name = findUniqueNpcName(`${activeNPC.name} (Copy)`);

					// Add to bestiary and switch
					activeBestiary.npcs.push(newNpc);
					sortAndSwitchToNpc(newNpc);
					saveActiveBestiaryToDB();
					inputs.name.focus();
				}
				
				function deleteCurrentNpc() {
					if (!activeBestiary || activeBestiary.npcs.length <= 1) return;

					// Find the NPC to be deleted and remove it
					const npcToDelete = activeNPC;
					activeBestiary.npcs = activeBestiary.npcs.filter(npc => npc !== npcToDelete);
					
					sortAndSwitchToNpc(null); // Sort and switch to the first NPC
					saveActiveBestiaryToDB();
				}

				async function importNpc() {
					if (!activeBestiary) return;
					
					try {
						const [handle] = await window.showOpenFilePicker({
							types: [{ description: "JSON Files", accept: { "application/json": [".json"] } }]
						});
						const file = await handle.getFile();
						const content = await file.text();
						const loadedNPC = JSON.parse(content);
						
						const newNpc = { ...defaultNPC, ...loadedNPC };
						
						activeBestiary.npcs.push(newNpc);
						sortAndSwitchToNpc(newNpc);
						saveActiveBestiaryToDB();
						
					} catch (err) {
						if (err.name !== "AbortError") console.error("Error importing NPC:", err);
					}
				}

				async function exportNpc() {
					if (!activeNPC) return;

					const npcJson = JSON.stringify(activeNPC, null, 2);
					try {
						const handle = await window.showSaveFilePicker({
							suggestedName: `${activeNPC.name || "unnamed-npc"}.json`,
							types: [{ description: "JSON Files", accept: { "application/json": [".json"] } }]
						});
						const writable = await handle.createWritable();
						await writable.write(npcJson);
						await writable.close();
					} catch (err) {
						if (err.name !== "AbortError") console.error("Error exporting NPC:", err);
					}
				}
				
				// --- UI & State Update Functions ---
				function updateMenuState() {
					const hasActiveBestiary = !!activeBestiary;
					const menuItemsToToggle = [
						menuExportBestiary, menuNewNpc, menuDuplicateNpc, menuImportNpc,
						menuExportNpc, menuDeleteNpc, menuSettings
					];

					menuItemsToToggle.forEach(item => {
						if (hasActiveBestiary) {
							item.classList.remove('disabled');
						} else {
							item.classList.add('disabled');
						}
					});
					
					if (hasActiveBestiary && activeBestiary.npcs.length <= 1) {
						menuDeleteNpc.classList.add('disabled');
					}
				}

				function updateUIForActiveBestiary() {
					if (activeBestiary) {
						bestiaryStatusEl.innerHTML = `Bestiary: <span class="font-bold text-red-700">${activeBestiary.projectName} (${activeBestiary.npcs.length} NPCs)</span>`;
						mainContentColumn.style.opacity = '1';
						mainContentColumn.style.pointerEvents = 'auto';
						npcSelector.classList.remove('hidden');
						deleteNpcBtn.classList.remove('hidden');
						npcOptionsContainer.classList.remove('hidden');
						[newNpcBtn, duplicateNpcBtn, importNpcBtn, exportNpcBtn, deleteNpcBtn].forEach(btn => btn.disabled = false);
					} else {
						bestiaryStatusEl.textContent = "No Bestiary Loaded";
						mainContentColumn.style.opacity = '0.3';
						mainContentColumn.style.pointerEvents = 'none';
						npcSelector.classList.add('hidden');
						deleteNpcBtn.classList.add('hidden');
						npcOptionsContainer.classList.add('hidden');
						[newNpcBtn, duplicateNpcBtn, importNpcBtn, exportNpcBtn, deleteNpcBtn].forEach(btn => btn.disabled = true);
					}
					updateMenuState();
					updateFormFromActiveNPC();
				}
				
				function updateNpcSelector() {
					if (!activeBestiary) return;
					
					npcSelector.innerHTML = '';
					
					activeBestiary.npcs.forEach((npc, index) => {
						const option = document.createElement('option');
						option.value = index;
						option.textContent = npc.name;
						if (index === activeNPCIndex) {
							option.selected = true;
						}
						npcSelector.appendChild(option);
					});

					deleteNpcBtn.disabled = activeBestiary.npcs.length <= 1;
				}

				
				function updateFormFromActiveNPC() {
					isUpdatingForm = true;
					try {
						if (!activeNPC) {
							Object.values(inputs).forEach(input => {
								if (input.type === 'checkbox') input.checked = false;
								else input.value = '';
							});
							document.querySelector("trix-editor").editor.loadHTML("");
							viewport.innerHTML = '';
							updateNpcSelector();
							return;
						}

						for (const key in inputs) {
							if (key === 'description') {
								const trixEditorElement = document.querySelector("trix-editor");
								inputs.description.value = activeNPC[key] || '';
								if (trixEditorElement && trixEditorElement.editor) {
									trixEditorElement.editor.loadHTML(activeNPC[key] || "");
								}
								continue;
							}
							const element = inputs[key];
							const customToggle = document.getElementById(`toggle-custom-${key}`);
							if (customToggle) {
								const select = element;
								const customInput = document.getElementById(`npc-${key}-custom`);
								const npcValue = activeNPC[key] || "";
								const isStandardOption = [...select.options].some(opt => opt.value === npcValue && !opt.disabled);
								if (isStandardOption || npcValue === "") {
									select.value = npcValue;
									customToggle.checked = false;
									select.classList.remove('hidden');
									customInput.classList.add('hidden');
								} else {
									customInput.value = npcValue;
									customToggle.checked = true;
									select.classList.add('hidden');
									customInput.classList.remove('hidden');
									select.value = "";
								}
							} else if (element.type === "checkbox") {
								element.checked = activeNPC[key] || false;
							} else {
								element.value = activeNPC[key] || "";
							}
						}

						for (const key in npcSettingsCheckboxes) {
							npcSettingsCheckboxes[key].checked = activeNPC[key];
						}

						const abilities = ['strength','dexterity','constitution','intelligence','wisdom','charisma'];
						abilities.forEach(ability => {
							document.getElementById(`npc-${ability}-saving-throw-prof`).checked = activeNPC[`${ability}SavingThrowProf`] || false;
							document.getElementById(`npc-${ability}-saving-throw-adjust`).value = activeNPC[`${ability}SavingThrowAdjust`] || 0;
						});
						
						damageTypes.forEach(type => {
							document.getElementById(`vuln-${type}`).checked = activeNPC[`vulnerability_${type}`] || false;
							document.getElementById(`res-${type}`).checked = activeNPC[`resistance_${type}`] || false;
							document.getElementById(`imm-${type}`).checked = activeNPC[`immunity_${type}`] || false;
						});
						
						conditions.forEach(condition => {
							document.getElementById(`ci-${condition}`).checked = activeNPC[`ci_${condition}`] || false;
						});

						const weaponResValue = activeNPC.weaponResistance || 'none';
						const weaponResRadio = document.querySelector(`input[name="weapon-resistance"][value="${weaponResValue}"]`);
						if (weaponResRadio) {
							weaponResRadio.checked = true;
						} else { 
							document.getElementById('wr-none').checked = true;
						}
						
						const weaponImmValue = activeNPC.weaponImmunity || 'none';
						const weaponImmRadio = document.querySelector(`input[name="weapon-immunity"][value="${weaponImmValue}"]`);
						if (weaponImmRadio) {
							weaponImmRadio.checked = true;
						} else {
							document.getElementById('wi-none').checked = true;
						}


						// Populate FG groups dropdown
						const fgGroupDropdown = document.getElementById('fantasy-grounds-group');
						fgGroupDropdown.innerHTML = '';
						const bestiaryOption = document.createElement('option');
						bestiaryOption.value = activeBestiary.projectName;
						bestiaryOption.textContent = activeBestiary.projectName;
						fgGroupDropdown.appendChild(bestiaryOption);
						(activeBestiary.metadata.fg_groups || []).forEach(group => {
							const groupOption = document.createElement('option');
							groupOption.value = group;
							groupOption.textContent = group;
							fgGroupDropdown.appendChild(groupOption);
						});
						fgGroupDropdown.value = activeNPC.fg_group || activeBestiary.projectName;

						experienceDisplay.textContent = activeNPC.experience || '';
						proficiencyBonusDisplay.textContent = `+${activeNPC.proficiencyBonus}` || '+2';
						updateTokenDisplay();
						updateImageDisplay();
						calculateAllStats();
						updateStatDisplays();
						updateViewport();
						updateNpcSelector();
					} finally {
						isUpdatingForm = false;
					}
				}

				function updateActiveNPCFromForm() {
					if (isUpdatingForm || !activeNPC) return;

					const newName = inputs.name.value.trim();
					if (newName && newName.toLowerCase() !== (activeNPC.name || "").toLowerCase()) {
						const isDuplicate = activeBestiary.npcs.some((npc, index) => 
							index !== activeNPCIndex && npc.name.toLowerCase() === newName.toLowerCase()
						);

						if (isDuplicate) {
							alert(`An NPC named "${newName}" already exists in this bestiary.`);
							inputs.name.value = activeNPC.name; // Revert to the old name
							return; // Stop the update
						}
					}

					for (const key in inputs) {
						if (key === 'description') {
							activeNPC[key] = inputs.description.value;
							continue;
						}
						const element = inputs[key];
						const customToggle = document.getElementById(`toggle-custom-${key}`);
						if (customToggle) {
							if (customToggle.checked) {
								const customInput = document.getElementById(`npc-${key}-custom`);
								activeNPC[key] = customInput.value;
							} else {
								activeNPC[key] = element.value;
							}
						} else if (element.type === "checkbox") {
							activeNPC[key] = element.checked;
						} else {
							activeNPC[key] = element.value;
						}
					}

					for (const key in npcSettingsCheckboxes) {
						activeNPC[key] = npcSettingsCheckboxes[key].checked;
					}
					
					const abilities = ['strength','dexterity','constitution','intelligence','wisdom','charisma'];
					abilities.forEach(ability => {
						activeNPC[`${ability}SavingThrowProf`] = document.getElementById(`npc-${ability}-saving-throw-prof`).checked;
						activeNPC[`${ability}SavingThrowAdjust`] = parseInt(document.getElementById(`npc-${ability}-saving-throw-adjust`).value, 10) || 0;
					});
					
					damageTypes.forEach(type => {
						activeNPC[`vulnerability_${type}`] = document.getElementById(`vuln-${type}`).checked;
						activeNPC[`resistance_${type}`] = document.getElementById(`res-${type}`).checked;
						activeNPC[`immunity_${type}`] = document.getElementById(`imm-${type}`).checked;
					});

					conditions.forEach(condition => {
						activeNPC[`ci_${condition}`] = document.getElementById(`ci-${condition}`).checked;
					});

					const selectedWeaponRes = document.querySelector('input[name="weapon-resistance"]:checked');
					if (selectedWeaponRes) {
						activeNPC.weaponResistance = selectedWeaponRes.value;
					}

					const selectedWeaponImm = document.querySelector('input[name="weapon-immunity"]:checked');
					if (selectedWeaponImm) {
						activeNPC.weaponImmunity = selectedWeaponImm.value;
					}

					activeNPC.experience = experienceDisplay.textContent;
					activeNPC.proficiencyBonus = parseInt(proficiencyBonusDisplay.textContent.replace('+', ''), 10);
					
					calculateAllStats();
					updateStatDisplays();
					updateViewport();
					
					// Just update the name in the dropdown, don't re-sort on every keystroke
					const currentOption = npcSelector.options[npcSelector.selectedIndex];
					if(currentOption) {
						currentOption.textContent = activeNPC.name;
					}

					saveActiveBestiaryToDB(); // Auto-save on any change
				}

				function calculateAbilityBonus(score) {
					return Math.floor((parseInt(score, 10) - 10) / 2);
				}

				function calculateProficiencyBonus(cr) {
					const crValue = Number(String(cr).replace(/[^0-9.]/g, ''));
					if (crValue <= 4) return 2;
					if (crValue <= 8) return 3;
					if (crValue <= 12) return 4;
					if (crValue <= 16) return 5;
					if (crValue <= 20) return 6;
					if (crValue <= 24) return 7;
					if (crValue <= 28) return 8;
					return 9; // for CR 29-30
				}
				
				function calculateSpeedString(npc) {
					if (!npc) return "";

					let speedParts = [];
					let baseSpeedString = `${npc.speedBase || 0} ft.`;
					
					if (parseInt(npc.speedBase, 10) > 0 || (parseInt(npc.speedBase, 10) === 0 && !npc.speedBurrow && !npc.speedClimb && !npc.speedFly && !npc.speedSwim)) {
						speedParts.push(baseSpeedString);
					}

					if (npc.speedBurrow > 0) {
						speedParts.push(`burrow ${npc.speedBurrow} ft.`);
					}
					if (npc.speedClimb > 0) {
						speedParts.push(`climb ${npc.speedClimb} ft.`);
					}
					if (npc.speedFly > 0) {
						let flyString = `fly ${npc.speedFly} ft.`;
						if (npc.flyHover) {
							flyString += " (hover)";
						}
						speedParts.push(flyString);
					}
					if (npc.speedSwim > 0) {
						speedParts.push(`swim ${npc.speedSwim} ft.`);
					}
					
					if (speedParts.length > 1 && speedParts[0] === '0 ft.') {
						speedParts.shift();
					}

					return speedParts.join(', ');
				}

				function calculateDamageModifiersString(npc) {
					if (!npc) return { vulnerabilities: "", resistances: "", immunities: "" };

					const vulnerabilities = [];
					const resistances = [];
					const immunities = [];

					damageTypes.forEach(type => {
						if (npc[`vulnerability_${type}`]) {
							vulnerabilities.push(type);
						}
						if (npc[`resistance_${type}`]) {
							resistances.push(type);
						}
						if (npc[`immunity_${type}`]) {
							immunities.push(type);
						}
					});
					
					let resistanceString = resistances.join(', ');
					let immunityString = immunities.join(', ');
					
					const weaponResTextMap = {
						'nonmagical': "bludgeoning, piercing, and slashing from nonmagical attacks",
						'silvered': "bludgeoning, piercing, and slashing from nonmagical attacks that aren't silvered",
						'adamantine': "bludgeoning, piercing, and slashing from nonmagical attacks that aren't adamantine",
						'cold-forged': "bludgeoning, piercing, and slashing from nonmagical attacks that aren't cold-forged iron",
						'magical': "bludgeoning, piercing, and slashing from magical attacks",
					};
					const weaponResText = weaponResTextMap[npc.weaponResistance];
					if (weaponResText) {
						if (resistanceString) {
							resistanceString += '; ' + weaponResText;
						} else {
							resistanceString = weaponResText;
						}
					}
					
					const weaponImmTextMap = {
						'nonmagical': "bludgeoning, piercing, and slashing from nonmagical attacks",
						'silvered': "bludgeoning, piercing, and slashing from nonmagical attacks that aren't silvered",
						'adamantine': "bludgeoning, piercing, and slashing from nonmagical attacks that aren't adamantine",
						'cold-forged': "bludgeoning, piercing, and slashing from nonmagical attacks that aren't cold-forged iron",
					};
					const weaponImmText = weaponImmTextMap[npc.weaponImmunity];
					if (weaponImmText) {
						if (immunityString) {
							immunityString += '; ' + weaponImmText;
						} else {
							immunityString = weaponImmText;
						}
					}


					return {
						vulnerabilities: vulnerabilities.join(', '),
						resistances: resistanceString,
						immunities: immunityString
					};
				}
				
				function calculateConditionImmunitiesString(npc) {
					if (!npc) return "";
					const immuneConditions = [];
					conditions.forEach(condition => {
						if (npc[`ci_${condition}`]) {
							immuneConditions.push(condition);
						}
					});
					return immuneConditions.join(', ');
				}

				function calculateAllStats() {
					if (!activeNPC) return;
					const abilities = ['strength','dexterity','constitution','intelligence','wisdom','charisma'];
					const abilityAbbr = { strength: 'Str', dexterity: 'Dex', constitution: 'Con', intelligence: 'Int', wisdom: 'Wis', charisma: 'Cha' };
					
					// 1. Calculate ability bonuses
					abilities.forEach(ability => {
						const score = activeNPC[ability] || 10;
						activeNPC[`${ability}Bonus`] = calculateAbilityBonus(score);
					});

					// 2. Calculate saving throws
					const profBonus = activeNPC.proficiencyBonus || 2;
					const savesArray = [];
					abilities.forEach(ability => {
						const base = activeNPC[`${ability}Bonus`] || 0;
						const isProficient = activeNPC[`${ability}SavingThrowProf`] || false;
						const adjust = activeNPC[`${ability}SavingThrowAdjust`] || 0;
						const total = base + (isProficient ? profBonus : 0) + adjust;
						
						if (isProficient || adjust !== 0) {
							savesArray.push(`${abilityAbbr[ability]} ${total >= 0 ? '+' : ''}${total}`);
						}
					});
					activeNPC.saves = savesArray.join(', ');

					// 3. Calculate Passive Perception
					activeNPC.passivePerception = 10 + (activeNPC.wisdomBonus || 0);
					
					// 4. Calculate Speed String
					activeNPC.speed = calculateSpeedString(activeNPC);
				}

				function updateStatDisplays() {
					if (!activeNPC) return;
					const abilities = ['strength','dexterity','constitution','intelligence','wisdom','charisma'];
					const profBonus = activeNPC.proficiencyBonus || 2;

					abilities.forEach(ability => {
						// Update bonus display
						const bonus = activeNPC[`${ability}Bonus`] || 0;
						const bonusEl = document.getElementById(`npc-${ability}-bonus`);
						if (bonusEl) {
							bonusEl.textContent = bonus >= 0 ? `+${bonus}` : bonus;
						}

						// Update saving throw total display
						const base = bonus;
						const isProficient = activeNPC[`${ability}SavingThrowProf`] || false;
						const adjust = activeNPC[`${ability}SavingThrowAdjust`] || 0;
						const total = base + (isProficient ? profBonus : 0) + adjust;
						const totalEl = document.getElementById(`npc-${ability}-saving-throw-total`);
						totalEl.textContent = total >= 0 ? `+${total}` : total;
					});
					
					document.getElementById('npc-passive-perception').textContent = activeNPC.passivePerception || 10;
				}

				function updateViewport() {
					if (!activeNPC) {
						viewport.innerHTML = '';
						return;
					}
					const {
						name, size, type, species, alignment, armorClass, hitPoints, description, saves,
						strength, dexterity, constitution, intelligence, wisdom, charisma,
						strengthBonus, dexterityBonus, constitutionBonus, intelligenceBonus, wisdomBonus, charismaBonus,
						useDropCap, addDescription, speed
					} = activeNPC;
					
					const { vulnerabilities, resistances, immunities } = calculateDamageModifiersString(activeNPC);
					const conditionImmunities = calculateConditionImmunitiesString(activeNPC);

					const NPCName = name || "";
					const NPCac = armorClass || "";
					const NPChp = hitPoints || "";
					const NPCDescriptionHTML = description || "";

					let NPCTypeString = `${size || ""} ${type || ""}`.trim();
					if (species) { NPCTypeString += ` (${species})`; }
					if (alignment) { NPCTypeString += `, ${alignment}`; }

					const NPCspeed = speed || "";
					const NPCstr = strength || "10";
					const NPCstrbo = strengthBonus !== undefined ? (strengthBonus >= 0 ? `+${strengthBonus}` : strengthBonus) : "+0";
					const NPCdex = dexterity || "10";
					const NPCdexbo = dexterityBonus !== undefined ? (dexterityBonus >= 0 ? `+${dexterityBonus}` : dexterityBonus) : "+0";
					const NPCcon = constitution || "10";
					const NPCconbo = constitutionBonus !== undefined ? (constitutionBonus >= 0 ? `+${constitutionBonus}` : constitutionBonus) : "+0";
					const NPCint = intelligence || "10";
					const NPCintbo = intelligenceBonus !== undefined ? (intelligenceBonus >= 0 ? `+${intelligenceBonus}` : intelligenceBonus) : "+0";
					const NPCwis = wisdom || "10";
					const NPCwisbo = wisdomBonus !== undefined ? (wisdomBonus >= 0 ? `+${wisdomBonus}` : wisdomBonus) : "+0";
					const NPCcha = charisma || "10";
					const NPCchabo = charismaBonus !== undefined ? (charismaBonus >= 0 ? `+${charismaBonus}` : charismaBonus) : "+0";

					const dropCapClass = useDropCap ? 'drop-cap' : '';
					const descriptionHtml = addDescription ? `<div class="npcdescrip ${dropCapClass}"> ${NPCDescriptionHTML} </div>` : '';

					const generatedHtml = `
						<div class="container">
							<div class="cap"></div>
							<div class="npcname"><b>${NPCName}</b></div>
							<div class="npctype"><i>${NPCTypeString}</i></div>
							<div class="npcdiv">
								<svg viewBox="0 0 200 5" preserveAspectRatio="none" width="100%" height="5">
									<polyline points="0,0 200,2.5 0,5" fill="#922610" class="whoosh"></polyline>
								</svg>
							</div>
							<div class="npctop"><b>Armor Class</b> ${NPCac}</div>
							<div class="npctop"><b>Hit Points</b> ${NPChp}</div>
							<div class="npctop"><b>Speed</b> ${NPCspeed}</div>
							<div class="npcdiv">
								<svg viewBox="0 0 200 5" preserveAspectRatio="none" width="100%" height="5">
									<polyline points="0,0 200,2.5 0,5" fill="#922610" class="whoosh"></polyline>
								</svg>
							</div>
							<div class="npctop">
								<table class="attr" width="100%">
									<tbody>
										<tr valign="middle">
											<td><b>STR</b></td> <td><b>DEX</b></td> <td><b>CON</b></td>
											<td><b>INT</b></td> <td><b>WIS</b></td> <td><b>CHA</b></td>
										</tr>
										<tr valign="middle">
											<td>${NPCstr} (${NPCstrbo})</td> <td>${NPCdex} (${NPCdexbo})</td> <td>${NPCcon} (${NPCconbo})</td>
											<td>${NPCint} (${NPCintbo})</td> <td>${NPCwis} (${NPCwisbo})</td> <td>${NPCcha} (${NPCchabo})</td>
										</tr>
									</tbody>
								</table>
							</div>
							<div class="npcdiv">
								<svg viewBox="0 0 200 5" preserveAspectRatio="none" width="100%" height="5">
									<polyline points="0,0 200,2.5 0,5" fill="#922610" class="whoosh"></polyline>
								</svg>
							</div>
							${saves ? `<div class="npctop"><b>Saving Throws</b> ${saves}</div>` : ''}
							${vulnerabilities ? `<div class="npctop"><b>Damage Vulnerabilities</b> ${vulnerabilities}</div>` : ''}
							${resistances ? `<div class="npctop"><b>Damage Resistances</b> ${resistances}</div>` : ''}
							${immunities ? `<div class="npctop"><b>Damage Immunities</b> ${immunities}</div>` : ''}
							${conditionImmunities ? `<div class="npctop"><b>Condition Immunities</b> ${conditionImmunities}</div>` : ''}
							<div class="npcdiv">
								<svg viewBox="0 0 200 5" preserveAspectRatio="none" width="100%" height="5">
									<polyline points="0,0 200,2.5 0,5" fill="#922610" class="whoosh"></polyline>
								</svg>
							</div>
							<div class="npcbottom">&nbsp;</div>
							<div class="cap"></div>
						</div>
						${descriptionHtml}
					`;
					viewport.innerHTML = generatedHtml;
				}

				function updateTokenDisplay() {
					tokenBox.innerHTML = '';
					if (activeNPC && activeNPC.token) {
						const img = document.createElement('img');
						img.src = activeNPC.token;
						img.className = 'w-full h-full object-contain';
						tokenBox.appendChild(img);
					} else {
						const placeholder = document.createElement('span');
						placeholder.textContent = 'Click or Drag a Token Image Here';
						tokenBox.appendChild(placeholder);
					}
				}

				function updateImageDisplay() {
					imageBox.innerHTML = '';
					if (activeNPC && activeNPC.image) {
						const img = document.createElement('img');
						img.src = activeNPC.image;
						img.className = 'w-full h-full object-contain';
						imageBox.appendChild(img);
					} else {
						const placeholder = document.createElement('span');
						placeholder.textContent = 'Click or Drag an NPC Image Here';
						imageBox.appendChild(placeholder);
					}
				}
				
				function populateChallengeDropdown() {
					const challengeSelect = inputs.challenge;
					challengeOrder.forEach(cr => {
						const option = document.createElement('option');
						option.value = cr;
						option.textContent = cr;
						challengeSelect.appendChild(option);
					});
				}

				function setupCustomToggles() {
					const fields = ['size','type','species','alignment'];
					fields.forEach(field => {
						const toggle = document.getElementById(`toggle-custom-${field}`);
						const select = document.getElementById(`npc-${field}`);
						const customInput = document.getElementById(`npc-${field}-custom`);
						if (toggle && select && customInput) {
							toggle.addEventListener('change', () => {
								if (toggle.checked) {
									select.classList.add('hidden');
									customInput.classList.remove('hidden');
									customInput.value = select.value;
									customInput.focus();
								} else {
									select.classList.remove('hidden');
									customInput.classList.add('hidden');
								}
								updateActiveNPCFromForm();
							});
							customInput.addEventListener('input', updateActiveNPCFromForm);
						}
					});
				}
				
				function setupSavingThrowListeners() {
					const abilities = ['strength','dexterity','constitution','intelligence','wisdom','charisma'];
					abilities.forEach(ability => {
						document.getElementById(`npc-${ability}-saving-throw-prof`).addEventListener('input', updateActiveNPCFromForm);
						document.getElementById(`npc-${ability}-saving-throw-adjust`).addEventListener('input', updateActiveNPCFromForm);
					});
				}
				
				function setupResistanceListeners() {
					damageTypes.forEach(type => {
						const vulnCheckbox = document.getElementById(`vuln-${type}`);
						const resCheckbox = document.getElementById(`res-${type}`);
						const immCheckbox = document.getElementById(`imm-${type}`);

						vulnCheckbox.addEventListener('input', updateActiveNPCFromForm);

						resCheckbox.addEventListener('input', () => {
							if (resCheckbox.checked) {
								immCheckbox.checked = false;
							}
							updateActiveNPCFromForm(); // Update data model after any change
						});

						immCheckbox.addEventListener('input', () => {
							if (immCheckbox.checked) {
								resCheckbox.checked = false;
							}
							updateActiveNPCFromForm(); // Update data model after any change
						});
					});
				}

				function setupWeaponModifierListeners() {
					document.querySelectorAll('input[name="weapon-resistance"]').forEach(radio => {
						radio.addEventListener('input', updateActiveNPCFromForm);
					});
					document.querySelectorAll('input[name="weapon-immunity"]').forEach(radio => {
						radio.addEventListener('input', updateActiveNPCFromForm);
					});
				}

				function setupConditionImmunityListeners() {
					conditions.forEach(condition => {
						document.getElementById(`ci-${condition}`).addEventListener('input', updateActiveNPCFromForm);
					});
				}


				function setupDragAndDrop(box, validTypes, npcKey, updateFn) {
					["dragenter","dragover","dragleave","drop"].forEach(eventName => {
						box.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
					});
					["dragenter","dragover"].forEach(eventName => {
						box.addEventListener(eventName, () => box.classList.add("drag-over"));
					});
					["dragleave","drop"].forEach(eventName => {
						box.addEventListener(eventName, () => box.classList.remove("drag-over"));
					});
					box.addEventListener("drop", e => {
						if (!activeNPC) return;
						const file = e.dataTransfer.files && e.dataTransfer.files[0];
						if (file && validTypes.includes(file.type)) {
							const reader = new FileReader();
							reader.onload = ev => {
								activeNPC[npcKey] = ev.target.result;
								updateFn();
								saveActiveBestiaryToDB();
							};
							reader.readAsDataURL(file);
						} else {
							console.warn("Invalid file type dropped.");
						}
					});
				}
				
				// --- Modal Handling ---
				function hideAllModals() {
					modalOverlay.classList.add('hidden');
					newBestiaryModal.classList.add('hidden');
					loadBestiaryModal.classList.add('hidden');
					hpModal.classList.add('hidden');
					manageGroupsModal.classList.add('hidden');
					settingsModal.classList.add('hidden');
				}

				async function showLoadBestiaryModal() {
					const bestiaries = await db.projects.toArray();
					bestiaryListDiv.innerHTML = ''; // Clear previous list
					if (bestiaries.length === 0) {
						bestiaryListDiv.innerHTML = '<p class="text-gray-500">No bestiaries found.</p>';
					} else {
						bestiaries.forEach(proj => {
							const projEl = document.createElement('div');
							projEl.className = 'flex justify-between items-center py-1 px-2 border rounded-md hover:bg-gray-100';

							const nameSpan = document.createElement('span');
							nameSpan.textContent = proj.projectName;
							nameSpan.className = 'cursor-pointer flex-grow';
							nameSpan.onclick = () => {
								loadBestiary(proj);
								hideAllModals();
							};

							const deleteBtn = document.createElement('button');
							deleteBtn.innerHTML = `<svg class="h-5 w-5 text-red-500 hover:text-red-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
							deleteBtn.className = 'p-1';
							deleteBtn.title = `Delete ${proj.projectName}`;
							deleteBtn.onclick = async (e) => {
								e.stopPropagation();
								await db.projects.delete(proj.id);
								if(activeBestiary && activeBestiary.id === proj.id) {
									activeBestiary = null;
									activeNPC = null;
									activeNPCIndex = -1;
									updateUIForActiveBestiary();
								}
								showLoadBestiaryModal(); // Refresh list
							};
							
							projEl.appendChild(nameSpan);
							projEl.appendChild(deleteBtn);
							bestiaryListDiv.appendChild(projEl);
						});
					}
					modalOverlay.classList.remove('hidden');
					loadBestiaryModal.classList.remove('hidden');
				}
				
				async function showManageGroupsModal() {
					if (!activeBestiary) return;
					groupListDiv.innerHTML = '';

					const groups = activeBestiary.metadata.fg_groups || [];
					if (groups.length === 0) {
						groupListDiv.innerHTML = '<p class="text-gray-500 text-center">No custom groups created.</p>';
					} else {
						groups.forEach(groupName => {
							const groupEl = document.createElement('div');
							groupEl.className = 'flex justify-between items-center py-0.5 px-2 border rounded-md hover:bg-gray-100';
							
							const nameSpan = document.createElement('span');
							nameSpan.textContent = groupName;
							
							const deleteBtn = document.createElement('button');
							deleteBtn.innerHTML = `<svg class="h-5 w-5 text-red-500 hover:text-red-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
							deleteBtn.className = 'p-1';
							deleteBtn.title = `Delete group: ${groupName}`;
							deleteBtn.onclick = (e) => {
								e.stopPropagation();
								deleteGroup(groupName);
							};

							groupEl.appendChild(nameSpan);
							groupEl.appendChild(deleteBtn);
							groupListDiv.appendChild(groupEl);
						});
					}
					modalOverlay.classList.remove('hidden');
					manageGroupsModal.classList.remove('hidden');
				}

				function showSettingsModal() {
					if (!activeBestiary) return;

					for (const key in bestiarySettingsCheckboxes) {
						bestiarySettingsCheckboxes[key].checked = activeBestiary.metadata[key];
					}

					modalOverlay.classList.remove('hidden');
					settingsModal.classList.remove('hidden');
				}

				function deleteGroup(groupName) {
					if (!activeBestiary || !activeBestiary.metadata.fg_groups) return;
					
					activeBestiary.metadata.fg_groups = activeBestiary.metadata.fg_groups.filter(g => g !== groupName);
					
					// Check if any NPC was using this group and reset it
					activeBestiary.npcs.forEach(npc => {
						if (npc.fg_group === groupName) {
							npc.fg_group = activeBestiary.projectName;
						}
					});

					saveActiveBestiaryToDB();
					showManageGroupsModal(); // Refresh modal list
					updateFormFromActiveNPC(); // Refresh main dropdown
				}

				function addNewGroup() {
					const newName = newGroupNameInput.value.trim();
					if (!newName) return;

					if (!activeBestiary.metadata.fg_groups) {
						activeBestiary.metadata.fg_groups = [];
					}
					
					const isDuplicate = newName.toLowerCase() === activeBestiary.projectName.toLowerCase() || activeBestiary.metadata.fg_groups.some(g => g.toLowerCase() === newName.toLowerCase());

					if (isDuplicate) {
						alert(`A group named "${newName}" already exists.`);
						return;
					}

					activeBestiary.metadata.fg_groups.push(newName);
					saveActiveBestiaryToDB();
					newGroupNameInput.value = '';
					showManageGroupsModal(); // Refresh list
					updateFormFromActiveNPC(); // Refresh main dropdown
				}

				function parseHpStringToModal() {
					const hpString = inputs.hitPoints.value || "";
					const match = hpString.match(/\((\d+)d(\d+)\s*([+-])?\s*(\d+)?\)/);

					if (match) {
						// Example match for "16 (3d6 + 6)": ["(3d6 + 6)", "3", "6", "+", "6"]
						const numDice = parseInt(match[1], 10);
						const dieType = parseInt(match[2], 10);
						const sign = match[3];
						const bonus = parseInt(match[4], 10) || 0;

						numDiceInput.value = numDice;
						dieTypeSelect.value = dieType;
						bonusInput.value = (sign === '-') ? -bonus : bonus;
					} else {
						// Reset to defaults if no match
						numDiceInput.value = 1;
						dieTypeSelect.value = 8; // d8 default
						bonusInput.value = 0;
					}
				}


				// --- EVENT LISTENERS ---
				
				// Icon Buttons
				newBestiaryBtn.addEventListener('click', showNewBestiaryModal);
				loadBestiaryBtn.addEventListener('click', showLoadBestiaryModal);
				importBestiaryBtn.addEventListener('click', importBestiary);
				exportBestiaryBtn.addEventListener('click', exportBestiary);
				newNpcBtn.addEventListener("click", createNewNpc);
				duplicateNpcBtn.addEventListener("click", duplicateCurrentNpc);
				importNpcBtn.addEventListener("click", importNpc);
				exportNpcBtn.addEventListener("click", exportNpc);
				deleteNpcBtn.addEventListener('click', deleteCurrentNpc);
				
				// Menu Items
				menuNewBestiary.addEventListener('click', (e) => { e.preventDefault(); showNewBestiaryModal(); mainMenu.classList.add('hidden'); });
				menuLoadBestiary.addEventListener('click', (e) => { e.preventDefault(); showLoadBestiaryModal(); mainMenu.classList.add('hidden'); });
				menuImportBestiary.addEventListener('click', (e) => { e.preventDefault(); importBestiary(); mainMenu.classList.add('hidden'); });
				menuExportBestiary.addEventListener('click', (e) => { e.preventDefault(); if(!menuExportBestiary.classList.contains('disabled')) exportBestiary(); mainMenu.classList.add('hidden'); });
				menuNewNpc.addEventListener('click', (e) => { e.preventDefault(); if(!menuNewNpc.classList.contains('disabled')) createNewNpc(); mainMenu.classList.add('hidden'); });
				menuDuplicateNpc.addEventListener('click', (e) => { e.preventDefault(); if(!menuDuplicateNpc.classList.contains('disabled')) duplicateCurrentNpc(); mainMenu.classList.add('hidden'); });
				menuImportNpc.addEventListener('click', (e) => { e.preventDefault(); if(!menuImportNpc.classList.contains('disabled')) importNpc(); mainMenu.classList.add('hidden'); });
				menuExportNpc.addEventListener('click', (e) => { e.preventDefault(); if(!menuExportNpc.classList.contains('disabled')) exportNpc(); mainMenu.classList.add('hidden'); });
				menuDeleteNpc.addEventListener('click', (e) => { e.preventDefault(); if(!menuDeleteNpc.classList.contains('disabled')) deleteCurrentNpc(); mainMenu.classList.add('hidden'); });
				menuSettings.addEventListener('click', (e) => { e.preventDefault(); if(!menuSettings.classList.contains('disabled')) showSettingsModal(); mainMenu.classList.add('hidden'); });
				
				// Hamburger Menu Logic
				hamburgerBtn.addEventListener('click', (e) => {
					e.stopPropagation();
					mainMenu.classList.toggle('hidden');
				});

				window.addEventListener('click', (e) => {
					if (!mainMenu.classList.contains('hidden') && !hamburgerBtn.contains(e.target)) {
						mainMenu.classList.add('hidden');
					}
				});
				
				// Modal Buttons
				createBestiaryBtn.addEventListener('click', createNewBestiary);
				newBestiaryNameInput.addEventListener('keyup', (e) => {
					if (e.key === 'Enter') createBestiaryBtn.click();
				});
				manageGroupsBtn.addEventListener('click', showManageGroupsModal);
				addGroupBtn.addEventListener('click', addNewGroup);
				newGroupNameInput.addEventListener('keyup', (e) => {
					if (e.key === 'Enter') {
						addNewGroup();
					}
				});
				settingsOkBtn.addEventListener('click', hideAllModals);

				
				// NPC Selector
				npcSelector.addEventListener('change', (e) => {
					const newIndex = parseInt(e.target.value, 10);
					if (newIndex !== activeNPCIndex) {
						switchActiveNPC(newIndex);
					}
				});
				
				document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', hideAllModals));
				modalOverlay.addEventListener('click', (e) => {
					if (e.target === modalOverlay) hideAllModals();
				});

				document.querySelectorAll('.card-header').forEach((header) => {
					header.addEventListener("click", (e) => {
						if (e.target.closest('#fantasy-grounds-group') || e.target.closest('#manage-groups-btn')) {
							return;
						}
						const cardBody = header.nextElementSibling;
						if (cardBody) {
							if (cardBody.classList.contains('open')) {
								cardBody.classList.remove('open');
								cardBody.style.paddingTop = '0';
								cardBody.style.paddingBottom = '0';
							} else {
								cardBody.classList.add('open');
								cardBody.style.paddingTop = '0.5rem';
								cardBody.style.paddingBottom = '0.5rem';
							}
						}
					});
				});

				Object.values(inputs).forEach((input) => {
					if(input.id !== 'npc-description') {
						input.addEventListener("input", updateActiveNPCFromForm);
					}
				});
				
				// Re-sort the list when the name input loses focus
				inputs.name.addEventListener('blur', () => {
					if (activeBestiary) {
						sortAndSwitchToNpc(activeNPC);
					}
				});


				// Settings Checkbox Listeners
				for (const key in bestiarySettingsCheckboxes) {
					bestiarySettingsCheckboxes[key].addEventListener('input', () => {
						if (activeBestiary) {
							activeBestiary.metadata[key] = bestiarySettingsCheckboxes[key].checked;
							saveActiveBestiaryToDB();
						}
					});
				}
				for (const key in npcSettingsCheckboxes) {
					npcSettingsCheckboxes[key].addEventListener('input', () => {
						if (activeNPC) {
							activeNPC[key] = npcSettingsCheckboxes[key].checked;
							updateViewport();
							saveActiveBestiaryToDB();
						}
					});
				}


				inputs.challenge.addEventListener('change', () => {
					const selectedCr = inputs.challenge.value;
					experienceDisplay.textContent = crToXpMap[selectedCr] || '';
					const profBonus = calculateProficiencyBonus(selectedCr);
					proficiencyBonusDisplay.textContent = `+${profBonus}`;
					updateActiveNPCFromForm();
				});

				document.querySelector("trix-editor").addEventListener("trix-change", updateActiveNPCFromForm);

				tokenBox.addEventListener('click', () => activeNPC && tokenUpload.click());
				tokenUpload.addEventListener('change', (event) => {
					const file = event.target.files[0];
					if (activeNPC && file && (file.type === "image/png" || file.type === "image/webp")) {
						const reader = new FileReader();
						reader.onload = function(e) {
							activeNPC.token = e.target.result;
							updateTokenDisplay();
							saveActiveBestiaryToDB();
						};
						reader.readAsDataURL(file);
					}
				});

				imageBox.addEventListener('click', () => activeNPC && imageUpload.click());
				imageUpload.addEventListener('change', (event) => {
					const file = event.target.files[0];
					if (activeNPC && file && (file.type === "image/png" || file.type === "image/webp" || file.type === "image/jpeg")) {
						const reader = new FileReader();
						reader.onload = function(e) {
							activeNPC.image = e.target.result;
							updateImageDisplay();
							saveActiveBestiaryToDB();
						};
						reader.readAsDataURL(file);
					}
				});

				setupDragAndDrop(tokenBox, ["image/png","image/webp"], "token", updateTokenDisplay);
				setupDragAndDrop(imageBox, ["image/png","image/webp","image/jpeg"], "image", updateImageDisplay);

				inputs.hitPoints.addEventListener('dblclick', () => {
					if (activeNPC) {
						parseHpStringToModal();
						modalOverlay.classList.remove('hidden');
						hpModal.classList.remove('hidden');
					}
				});
				hpModalCloseBtn.addEventListener('click', () => {
					hideAllModals();
				});
				hpApplyBtn.addEventListener('click', () => {
					const numDice = parseInt(numDiceInput.value, 10) || 0;
					const dieType = parseInt(dieTypeSelect.value, 10) || 0;
					const bonus = parseInt(bonusInput.value, 10) || 0;
					if (numDice > 0 && dieType > 0) {
						const avgRoll = (dieType / 2) + 0.5;
						const totalHp = Math.floor(numDice * avgRoll) + bonus;
						let bonusString = "";
						if (bonus > 0) { bonusString = ` + ${bonus}`; }
						else if (bonus < 0) { bonusString = ` - ${Math.abs(bonus)}`; }
						const hpString = `${totalHp} (${numDice}d${dieType}${bonusString})`;
						inputs.hitPoints.value = hpString;
						updateActiveNPCFromForm();
						hideAllModals();
					}
				});
				
				// --- INITIALIZATION ---
				populateChallengeDropdown();
				setupCustomToggles();
				setupSavingThrowListeners();
				setupResistanceListeners();
				setupWeaponModifierListeners();
				setupConditionImmunityListeners();
				updateUIForActiveBestiary(); // Initial setup for no bestiary loaded

				document.querySelectorAll('.card-body').forEach(cardBody => {
					cardBody.classList.add('open');
					cardBody.style.paddingTop = '0.5rem';
					cardBody.style.paddingBottom = '0.5rem';
				});
			});
		</script>
	</body>
</html>

